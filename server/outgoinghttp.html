
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Keycloak - Server - Configuring outgoing HTTP requests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Keycloak is an open source identity and access management solution">
    <meta name="author" content="Keycloak Team">
    <meta name="keywords" content="sso,idm,openid connect,saml,kerberos,ldap">

    

    

    <link href="https://www.keycloak.org/resources/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://www.keycloak.org/resources/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="https://www.keycloak.org/resources/css/keycloak.css" rel="stylesheet">

    <link rel="shortcut icon" href="https://www.keycloak.org/resources/favicon.ico">

    <script src="https://www.keycloak.org/resources/js/ga.js" type="text/javascript"></script>
    <script src="https://www.keycloak.org/resources/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="https://www.keycloak.org/resources/tocbot/dist/tocbot.min.js" type="text/javascript"></script>
</head>
<body>

<header class="navbar navbar-expand-md bg-light shadow-sm">
<nav class="container-xxl flex-wrap flex-md-no-wrap navbar-light">
    <a class="navbar-brand me-5" href="https://www.keycloak.org/">
        <img class="img-fluid" src="https://www.keycloak.org/resources/images/keycloak_logo_200px.svg" width="240" alt="Keycloak"/>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="fa fa-bars fa-lg px-1 py-2"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav flex-row flex-wrap bd-navbar-nav pt-2 py-md-0">
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/guides">Guides</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/documentation">Docs</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/downloads">Downloads</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/community">Community</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/blog">Blog</a>
        </li>
      </ul>
    </div>
</nav>
</header>


<div class="container mt-5 kc-article">
    <div class="row">
        <div class="col-md-9 col-xl-10 col-sm-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="https://www.keycloak.org/guides">Guides</a></li>
                    <li class="breadcrumb-item"><a href="https://www.keycloak.org/guides#server">Server</a></li>
                    <li class="breadcrumb-item active">Configuring outgoing HTTP requests</li>
                </ol>
            </nav>

            <div class="mb-4">
                <h1>Configuring outgoing HTTP requests</h1>
                    <span class="text-muted">How to configure the client used for outgoing HTTP requests.</span>
            </div>



            <div class="kc-asciidoc" id="guide-body">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak often needs to make requests to the applications and services it secures. Keycloak manages these outgoing connections using an HTTP client. This guide shows how to configure the client, it&#8217;s connection pool, proxy environment settings, timeouts and more.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage">Usage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To configure Keycloak&#8217;s outgoing Http client, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">bin/kc.[sh|bat] start --spi-connections-http-client-default-&lt;configurationoption&gt;=&lt;value&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please see <a href="#_outgoing_http_client_configuration_options">Outgoing Http Client Configuration Options</a> for the available configuration options.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_outgoing_http_client_configuration_options">Outgoing Http Client Configuration Options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The HTTP client Keycloak uses for outgoing communication is highly configurable. The available options are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>establish-connection-timeout-millis</strong></dt>
<dd>
<p>Maximum time in milliseconds until establishing a connection times out. Default: Not set.</p>
</dd>
<dt class="hdlist1"><strong>socket-timeout-millis</strong></dt>
<dd>
<p>Maximum time of inactivity between two data packets until a socket connection times out, in milliseconds. Default: 5000ms</p>
</dd>
<dt class="hdlist1"><strong>connection-pool-size</strong></dt>
<dd>
<p>Size of the connection pool for outgoing connections. Default: 128.</p>
</dd>
<dt class="hdlist1"><strong>max-pooled-per-route</strong></dt>
<dd>
<p>How many connections can be pooled per host. Default: 64.</p>
</dd>
<dt class="hdlist1"><strong>connection-ttl-millis</strong></dt>
<dd>
<p>Maximum connection time to live in milliseconds. Default: Not set.</p>
</dd>
<dt class="hdlist1"><strong>max-connection-idle-time-millis</strong></dt>
<dd>
<p>Maximum time an idle connection stays in the connection pool, in milliseconds. Idle connections will be removed from the pool by a background cleaner thread. Set to -1 to disable this check. Default: 900000.</p>
</dd>
<dt class="hdlist1"><strong>disable-cookies</strong></dt>
<dd>
<p>Enable or disable caching of cookies. Default: true.</p>
</dd>
<dt class="hdlist1"><strong>client-keystore</strong></dt>
<dd>
<p>File path to a Java keystore file. This keystore contains client certificates for two-way SSL.</p>
</dd>
<dt class="hdlist1"><strong>client-keystore-password</strong></dt>
<dd>
<p>Password for the client keystore. REQUIRED, when <code>client-keystore</code> ist set.</p>
</dd>
<dt class="hdlist1"><strong>client-key-password</strong></dt>
<dd>
<p>Password for the client&#8217;s private key. REQUIRED, when client-keystore is set.</p>
</dd>
<dt class="hdlist1"><strong>proxy-mappings</strong></dt>
<dd>
<p>Specify proxy configurations for outgoing HTTP requests. See the section on Proxy Mappings for Outgoing HTTP Requests for more details.</p>
</dd>
<dt class="hdlist1"><strong>disable-trust-manager</strong></dt>
<dd>
<p>If an outgoing request requires HTTPS and this config option is set to true you do not have to specify a truststore. This setting should only be used during development and <strong>never in production</strong> as it will disable verification of SSL certificates. Default: false.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proxy_mappings_for_outgoing_http_requests">Proxy mappings for outgoing HTTP requests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To configure outgoing requests to use a proxy, you can use the following standard proxy environment variables to configure the proxy mappings: <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code> and <code>NO_PROXY</code>.</p>
</div>
<div class="paragraph">
<p>The <code>HTTP_PROXY</code> and <code>HTTPS_PROXY</code> variables represent the proxy server that will be used for outgoing HTTP requests. Keycloak does not differ between the two. If both are specified, <code>HTTPS_PROXY</code> takes precedence regardless of the actual scheme the proxy server uses.</p>
</div>
<div class="paragraph">
<p>The <code>NO_PROXY</code> variable is used to define a comma separated list of hostnames that should not use the proxy. If a hostname is specified, all its subdomains are also excluded from using proxy.</p>
</div>
<div class="paragraph">
<p>The environment variables can be lowercase or uppercase. Lowercase takes precedence. For example if both <code>HTTP_PROXY</code> and <code>http_proxy</code> are defined, <code>http_proxy</code> will be used.</p>
</div>
<div class="sect2">
<h3 id="_example">Example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>HTTPS_PROXY=https://www-proxy.acme.com:8080
NO_PROXY=google.com,login.facebook.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, all outgoing requests will use the proxy <code><a href="https://www-proxy.acme.com:8080" class="bare">https://www-proxy.acme.com:8080</a></code> except for requests to google.com, any subdomain of google.com (e.g. auth.google.com). Also, login.facebook.com and all its subdomains will not use the defined Proxy, but e.g. groups.facebook.com will use the proxy.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_the_outgoing_http_client_configuration_to_define_proxy_mappings">Using the outgoing HTTP client configuration to define proxy mappings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Alternatively, outgoing requests sent by Keycloak can use a proxy server by configuring a comma delimited list of proxy-mappings. A proxy-mapping consists of a regex-based hostname pattern and a proxy-uri, using the scheme <code>hostname-pattern;proxy-uri</code>, e.g. you can apply the regex</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>*\.(google|googleapis)\.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">bin/kc.[sh|bat] start --spi-connections-http-client-default-proxy-mappings="'*\\\.(google|googleapis)\\\.com;http://www-proxy.acme.com:8080'"</code></pre>
</div>
</div>
<div class="paragraph">
<p>To determine the proxy for an outgoing HTTP request, the target hostname is matched against all configured hostname patterns. The proxy-uri of the first matching pattern will be used. If none of the configured patterns match for the hostname, no proxy is used.</p>
</div>
<div class="paragraph">
<p>When your proxy server requires authentication, include the proxy user?s credentials in the format <code>username:password@</code>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>.*\.(google|googleapis)\.com;http://proxyuser:password@www-proxy.acme.com:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>The special value NO_PROXY for the proxy-uri can be used to indicate that no proxy should be used for hosts matching the associated hostname pattern. It is possible to specify a catch-all pattern at the end of the proxy-mappings to define a default proxy for all outgoing requests.</p>
</div>
<div class="listingblock">
<div class="title">Example regular expressions for proxy-mapping:</div>
<div class="content">
<pre class="highlight"><code># All requests to Google APIs use http://www-proxy.acme.com:8080 as proxy
.*\.(google|googleapis)\.com;http://www-proxy.acme.com:8080

# All requests to internal systems use no proxy
.*\.acme\.com;NO_PROXY

# All other requests use http://fallback:8080 as proxy
.*;http://fallback:8080</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_outgoing_https_request_truststore">Outgoing HTTPS request truststore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When Keycloak calls remote HTTPS endpoints, it has to validate the remote server&#8217;s certificate in order to ensure it is connecting to a trusted server. This is necessary in order to prevent man-in-the-middle attacks.  The certificates of these remote servers or the CA that signed these certificates must be put in a truststore.</p>
</div>
<div class="paragraph">
<p>This truststore is used to securely connect e.g. to identity brokers, LDAP identity providers, when sending emails, and for backchannel communication with client applications.</p>
</div>
<div class="paragraph">
<p>When no truststore is configured, outgoing https connection will use the standard java truststore configuration by default. When no trust can be established, outgoing HTTPS requests will fail.</p>
</div>
<div class="paragraph">
<p>You can add your truststore configuration by using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">bin/kc.[sh|bat] start --spi-truststore-file-file=myTrustStore.jks --spi-truststore-file-password=password --spi-truststore-file-hostname-verification-policy=ANY</code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible configuration options for this setting are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">file</dt>
<dd>
<p>The path to a Java keystore file.
HTTPS requests need a way to verify the host of the server they are talking to.
This is what the trustore does.
The keystore contains one or more trusted host certificates or certificate authorities.
This truststore file should only contain public certificates of your secured hosts.
This is <em>REQUIRED</em> if any of these properties are defined.</p>
</dd>
<dt class="hdlist1">password</dt>
<dd>
<p>Password of the keystore.
This is <em>REQUIRED</em> if any of these properties are defined.</p>
</dd>
<dt class="hdlist1">hostname-verification-policy</dt>
<dd>
<p>For HTTPS requests, this verifies the hostname of the server&#8217;s certificate.
<code>ANY</code> means that the hostname is not verified. <code>WILDCARD</code> Allows wildcards in subdomain names, e.g.
*.foo.com. When using <code>STRICT</code>, the Common Name (CN) must match the hostname exactly. Default: <code>WILDCARD</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<div class="title">Example</div>
<p>An example configuration for a truststore that allows you to create trustful connections to all <code>mycompany.org</code> domains and it&#8217;s subdomains is shown below:</p>
</div>
<div class="paragraph">
<p>&lt;kc.start parameters="--spi-truststore-file-file=path/to/truststore.jks --spi-truststore-file-password=change_me --spi-truststore-file-hostname-verification-policy=WILDCARD"/&gt;</p>
</div>
</div>
</div>            </div>
        </div>

        <div class="col-md-3 mt-4 col-xl-2 col-sm-12 bg-light">
            <div class="sticky-top px-2 py-3">
                <div class="mt-2 mb-2 fw-bold">On this page</div>
                <div id="js-toc"></div>
                <div class="mt-4">
                    <a href="https://github.com/keycloak/keycloak/tree/main/docs/guides/src/main/server/outgoinghttp.adoc" target="_blank"><i class="fa fa-edit"></i> Edit this guide</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.keycloak.org/resources/js/guide.js" type="text/javascript"></script>


<div class="container">
    <footer class="d-flex flex-wrap justify-content-between align-items-center pt-2 mt-3 mb-3">
        <div class="col-md-4 d-flex align-items-center">
            <span class="text-muted me-3">Sponsored by</span>
            <a href="http://www.redhat.com/" target="_blank" class="">
                <img alt="Red Hat" src="https://www.keycloak.org/resources/images/Logo-RedHat-A-Standard-RGB.svg" width="100">
            </a>
        </div>
    </footer>
</div>

</body>
</html>
