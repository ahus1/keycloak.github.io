<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>Securing Applications and Services Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<style>
/* Top menu */

@media only screen and (min-width: 768px) {
       div.top-menu-guides {
              position: fixed;
              display: inline-block;
              top: 0;
              left: 0;
              z-index: 9999;
       }

       div.top-menu-guides p {
              margin: 0;
              padding: 0;
       }

       div.top-menu-guides .content {
              margin: 0;
              padding: 7px 20px 0 20px;
              background-color: #ededed;
              height: 48px;
              width: 20em;
       }

       @media only screen and (max-width: 1280px) {
              div.top-menu-guides .content {
                     width: 15em;
              }
       }

       div.top-menu-guides .ulist {
              display: none;
              position: absolute;
              background-color: #f9f9f9;
              min-width: 160px;
              box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
              padding: 0px;
              margin-top: 12px;
       }

       div.top-menu-guides .ulist ul {
              list-style: none;
              padding: 5px;
              margin: 0;
       }

       div.top-menu-guides .ulist li {
              padding: 5px 10px;
       }

       div.top-menu-guides:hover .ulist {
           display: block;
       }

       div.top-menu-version {
           position: fixed;
           top: 0;
           z-index: 9999;
       }

       div.top-menu-version .content {
           padding: 0;
           margin: 0;
           background-color: #eee;
           height: 48px;
           padding: 7px;
       }

        div.top-menu-version p {
            margin: 0;
            padding: 2px 5px 2px 10px;
        }

}

/* TOC */

#tocbot a.toc-link.node-name--H1{ font-style: italic }
@media screen{
#tocbot > ul.toc-list{ margin-bottom: 0.5em; margin-left: 0.125em }
#tocbot ul.sectlevel0, #tocbot a.toc-link.node-name--H1 + ul{
  padding-left: 0 }
#tocbot a.toc-link{ height:100% }
.is-collapsible{ max-height:3000px; overflow:hidden; }
.is-collapsed{ max-height:0 }
.is-active-link{ font-weight:700 }
}
@media print{
#tocbot a.toc-link.node-name--H4{ display:none }
}

/* Fix scroll to anchor hides title */
h1::before, h2::before, h3::before, h4::before, h5::before, h6::before {
    display: block;
    content: " ";
    height: 70px;
    margin-top: -70px;
}

h1 {
    border-bottom: none !important
}

#toc.toc2 {
    top: 30px;
    bottom: 0px;
    height: unset;
}

body.toc2 {
    padding-top: 30px;
}

@media only screen and (min-width:768px) {
    #toc.toc2 {
        top: 40px;
    }

    body.toc2 {
        padding-top: 40px;
    }
}

@media only screen and (min-width:1280px) {
    #toc.toc2 {
        top: 48px;
    }

    body.toc2 {
        padding-top: 48px;
    }
}


/* General Changes */

h1, h2, h3, #toctitle, .sidebarblock>.content>.title, h4, h5, h6 {
    color: #444444;
    font-weight: 500;
}

a {
    color: #004670;
    text-decoration: none;
}

a:hover {
    color: #7da1dc;
}

body {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    color: #444444;
}

.subheader, .admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    color: #444444;
}

.admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    font-style: normal;
}

span.image img {
    border:1px solid #ccc;
    -webkit-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    -moz-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
}

.sect1+.sect1 {
    border-top: none;
}

.page-links {
    border-bottom: 1px solid #efefed;
    border-top: none;
    background: none;
    position: relative;
    left: 0em;
    width: 100%;
    top: -5em;
    height: 0;
    margin: 0;
    padding: 0;
}

.sect2 .page-links {
    top: -3.5em;
}

.page-links .content {
    background: #f8f8f7;
    border: 1px solid #e0e0dc;
    float: right;
    font-size: 0.8em;
    margin: 0;
    padding: 5px;
}

.page-links a {
    display: block;
    padding: 5px;
}
</style>

</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Securing Applications and Services Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#planning-for-securing-applications-and-services">1. Planning for securing applications and services</a>
<ul class="sectlevel2">
<li><a href="#basic-steps-to-secure-applications-and-services">1.1. Basic steps to secure applications and services</a></li>
<li><a href="#getting-started">1.2. Getting Started</a>
<ul class="sectlevel3">
<li><a href="#openid-connect">1.2.1. OpenID Connect</a></li>
<li><a href="#saml">1.2.2. SAML</a></li>
</ul>
</li>
<li><a href="#terminology">1.3. Terminology</a></li>
</ul>
</li>
<li><a href="#_oidc">2. Using OpenID Connect to secure applications and services</a>
<ul class="sectlevel2">
<li><a href="#available-endpoints">2.1. Available Endpoints</a>
<ul class="sectlevel3">
<li><a href="#endpoints">2.1.1. Endpoints</a></li>
</ul>
</li>
<li><a href="#supported-grant-types">2.2. Supported Grant Types</a>
<ul class="sectlevel3">
<li><a href="#authorization-code">2.2.1. Authorization code</a></li>
<li><a href="#implicit">2.2.2. Implicit</a></li>
<li><a href="#_resource_owner_password_credentials_flow">2.2.3. Resource Owner Password Credentials</a></li>
<li><a href="#client-credentials">2.2.4. Client credentials</a></li>
<li><a href="#device-authorization-grant">2.2.5. Device Authorization Grant</a></li>
<li><a href="#_client_initiated_backchannel_authentication_grant">2.2.6. Client Initiated Backchannel Authentication Grant</a></li>
</ul>
</li>
<li><a href="#_oidc-errors">2.3. Keycloak specific errors</a></li>
<li><a href="#keycloak-java-adapters">2.4. Keycloak Java adapters</a></li>
<li><a href="#_javascript_adapter">2.5. Keycloak JavaScript adapter</a>
<ul class="sectlevel3">
<li><a href="#installation">2.5.1. Installation</a></li>
<li><a href="#keycloak-server-configuration">2.5.2. Keycloak server configuration</a></li>
<li><a href="#using-the-adapter">2.5.3. Using the adapter</a></li>
<li><a href="#session-status-iframe">2.5.4. Session Status iframe</a></li>
<li><a href="#_javascript_implicit_flow">2.5.5. Implicit and hybrid flow</a></li>
<li><a href="#hybrid-apps-with-cordova">2.5.6. Hybrid Apps with Cordova</a></li>
<li><a href="#custom-adapters">2.5.7. Custom Adapters</a></li>
<li><a href="#_modern_browsers">2.5.8. Modern Browsers with Tracking Protection</a></li>
<li><a href="#api-reference">2.5.9. API Reference</a></li>
</ul>
</li>
<li><a href="#_nodejs_adapter">2.6. Keycloak Node.js adapter</a>
<ul class="sectlevel3">
<li><a href="#installation-2">2.6.1. Installation</a></li>
<li><a href="#usage">2.6.2. Usage</a></li>
<li><a href="#installing-middleware">2.6.3. Installing middleware</a></li>
<li><a href="#configuration-for-proxies">2.6.4. Configuration for proxies</a></li>
<li><a href="#protecting-resources">2.6.5. Protecting resources</a></li>
<li><a href="#additional-urls">2.6.6. Additional URLs</a></li>
<li><a href="#complete-example">2.6.7. Complete example</a></li>
</ul>
</li>
<li><a href="#_mod_auth_openidc">2.7. mod_auth_openidc Apache HTTPD Module</a></li>
<li><a href="#_fapi-support">2.8. Financial-grade API (FAPI) Support</a>
<ul class="sectlevel3">
<li><a href="#fapi-client-profiles">2.8.1. FAPI client profiles</a></li>
<li><a href="#open-finance-brasil-financial-grade-api-security-profile">2.8.2. Open Finance Brasil Financial-grade API Security Profile</a></li>
<li><a href="#australia-consumer-data-right-cdr-security-profile">2.8.3. Australia Consumer Data Right (CDR) Security Profile</a></li>
<li><a href="#tls-considerations">2.8.4. TLS considerations</a></li>
</ul>
</li>
<li><a href="#_oauth21-support">2.9. OAuth 2.1 Support</a>
<ul class="sectlevel3">
<li><a href="#oauth-2-1-client-profiles">2.9.1. OAuth 2.1 client profiles</a></li>
</ul>
</li>
<li><a href="#recommendations">2.10. Recommendations</a>
<ul class="sectlevel3">
<li><a href="#validating-access-tokens">2.10.1. Validating access tokens</a></li>
<li><a href="#redirect-uris">2.10.2. Redirect URIs</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_saml">3. Using SAML to secure applications and services</a>
<ul class="sectlevel2">
<li><a href="#keycloak-java-adapters-2">3.1. Keycloak Java adapters</a>
<ul class="sectlevel3">
<li><a href="#_saml-general-config">3.1.1. General Adapter Config</a></li>
<li><a href="#_saml_jboss_adapter">3.1.2. JBoss EAP/WildFly adapter</a></li>
<li><a href="#_saml-jboss-adapter-installation">3.1.3. Installing adapters from a Galleon feature pack</a></li>
<li><a href="#registering-with-an-identity-provider">3.1.4. Registering with an Identity Provider</a></li>
<li><a href="#logout">3.1.5. Logout</a></li>
<li><a href="#obtaining-assertion-attributes">3.1.6. Obtaining assertion attributes</a></li>
<li><a href="#error-handling">3.1.7. Error Handling</a></li>
<li><a href="#troubleshooting">3.1.8. Troubleshooting</a></li>
<li><a href="#_saml_multi_tenancy">3.1.9. Multi Tenancy</a></li>
<li><a href="#migration-from-older-versions">3.1.10. Migration from older versions</a></li>
</ul>
</li>
<li><a href="#_mod_auth_mellon">3.2. mod_auth_mellon Apache HTTPD Module</a>
<ul class="sectlevel3">
<li><a href="#configuring-mod_auth_mellon-with-keycloak">3.2.1. Configuring mod_auth_mellon with Keycloak</a></li>
<li><a href="#setting-the-samesite-value-for-the-cookie-used-by-mod_auth_mellon">3.2.2. Setting the SameSite value for the cookie used by mod_auth_mellon</a></li>
</ul>
</li>
<li><a href="#_saml-errors">3.3. Keycloak specific errors</a></li>
</ul>
</li>
<li><a href="#configuring-a-docker-registry-to-use-keycloak">4. Configuring a Docker registry to use Keycloak</a>
<ul class="sectlevel2">
<li><a href="#docker-registry-configuration-file-installation">4.1. Docker registry configuration file installation</a></li>
<li><a href="#docker-registry-environment-variable-override-installation">4.2. Docker registry environment variable override installation</a></li>
<li><a href="#docker-compose-yaml-file">4.3. Docker Compose YAML File</a></li>
</ul>
</li>
<li><a href="#_client_registration">5. Using the client registration service</a>
<ul class="sectlevel2">
<li><a href="#authentication">5.1. Authentication</a>
<ul class="sectlevel3">
<li><a href="#bearer-token">5.1.1. Bearer token</a></li>
<li><a href="#_initial_access_token">5.1.2. Initial Access Token</a></li>
<li><a href="#_registration_access_token">5.1.3. Registration Access Token</a></li>
</ul>
</li>
<li><a href="#keycloak-representations">5.2. Keycloak Representations</a></li>
<li><a href="#keycloak-adapter-configuration">5.3. Keycloak adapter configuration</a></li>
<li><a href="#openid-connect-dynamic-client-registration">5.4. OpenID Connect Dynamic Client Registration</a></li>
<li><a href="#saml-entity-descriptors">5.5. SAML Entity Descriptors</a></li>
<li><a href="#example-using-curl-2">5.6. Example using CURL</a></li>
<li><a href="#example-using-java-client-registration-api">5.7. Example using Java Client Registration API</a></li>
<li><a href="#_client_registration_policies">5.8. Client Registration Policies</a></li>
</ul>
</li>
<li><a href="#_client_registration_cli">6. Automating Client Registration with the CLI</a>
<ul class="sectlevel2">
<li><a href="#_configuring_a_user_for_client_registration_cli">6.1. Configuring a new regular user for use with Client Registration CLI</a></li>
<li><a href="#_configuring_a_client_for_use_with_client_registration_cli">6.2. Configuring a client for use with the Client Registration CLI</a></li>
<li><a href="#_installing_client_registration_cli">6.3. Installing the Client Registration CLI</a></li>
<li><a href="#_using_client_registration_cli">6.4. Using the Client Registration CLI</a>
<ul class="sectlevel3">
<li><a href="#_logging_in">6.4.1. Logging in</a></li>
<li><a href="#_working_with_alternative_configurations">6.4.2. Working with alternative configurations</a></li>
<li><a href="#_initial_access_and_registration_access_tokens">6.4.3. Initial Access and Registration Access Tokens</a></li>
<li><a href="#_performing_crud_operations">6.4.4. Creating a client configuration</a></li>
<li><a href="#retrieving-a-client-configuration">6.4.5. Retrieving a client configuration</a></li>
<li><a href="#modifying-a-client-configuration">6.4.6. Modifying a client configuration</a></li>
<li><a href="#deleting-a-client-configuration">6.4.7. Deleting a client configuration</a></li>
<li><a href="#_refreshing_invalid_registration_access_tokens">6.4.8. Refreshing invalid Registration Access Tokens</a></li>
</ul>
</li>
<li><a href="#_troubleshooting_2">6.5. Troubleshooting</a></li>
</ul>
</li>
<li><a href="#_token-exchange">7. Using token exchange</a>
<ul class="sectlevel2">
<li><a href="#how-token-exchange-works">7.1. How token exchange works</a>
<ul class="sectlevel3">
<li><a href="#form-parameters">7.1.1. Form parameters</a></li>
<li><a href="#responses-from-a-token-exchange-request">7.1.2. Responses from a token exchange request</a></li>
</ul>
</li>
<li><a href="#_internal-token-to-internal-token-exchange">7.2. Internal token to internal token exchange</a>
<ul class="sectlevel3">
<li><a href="#_client_to_client_permission">7.2.1. Granting permission for the exchange</a></li>
<li><a href="#_internal_internal_making_request">7.2.2. Making the request</a></li>
</ul>
</li>
<li><a href="#internal-token-to-external-token-exchange">7.3. Internal token to external token exchange</a>
<ul class="sectlevel3">
<li><a href="#_grant_permission_external_exchange">7.3.1. Granting permission for the exchange</a></li>
<li><a href="#_internal_external_making_request">7.3.2. Making the request</a></li>
</ul>
</li>
<li><a href="#external-token-to-internal-token-exchange">7.4. External token to internal token exchange</a>
<ul class="sectlevel3">
<li><a href="#granting-permission-for-the-exchange">7.4.1. Granting permission for the exchange</a></li>
<li><a href="#making-the-request">7.4.2. Making the request</a></li>
</ul>
</li>
<li><a href="#impersonation">7.5. Impersonation</a>
<ul class="sectlevel3">
<li><a href="#granting-permission-for-the-exchange-2">7.5.1. Granting permission for the exchange</a></li>
<li><a href="#making-the-request-2">7.5.2. Making the request</a></li>
</ul>
</li>
<li><a href="#direct-naked-impersonation">7.6. Direct Naked Impersonation</a>
<ul class="sectlevel3">
<li><a href="#granting-permission-for-the-exchange-3">7.6.1. Granting permission for the exchange</a></li>
<li><a href="#making-the-request-3">7.6.2. Making the request</a></li>
</ul>
</li>
<li><a href="#expand-permission-model-with-service-accounts">7.7. Expand permission model with service accounts</a></li>
<li><a href="#exchange-vulnerabilities">7.8. Exchange vulnerabilities</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="exampleblock top-menu-guides">
<div class="content">
<div class="paragraph">
<p><strong>Securing Apps</strong> <span class="icon"><i class="fa fa-angle-down"></i></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.keycloak.org/guides#getting-started">Getting Started</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/25.0.5/server_admin/">Server Administration</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/25.0.5/server_development/">Server Developer</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/25.0.5/authorization_services/">Authorization Services</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/25.0.5/upgrading/">Upgrading</a></p>
</li>
<li>
<p><a href="https://www.keycloak.org/docs/25.0.5/release_notes/">Release Notes</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="exampleblock top-menu-version">
<div class="content">
<div class="paragraph">
<p>Version <strong>25.0.5</strong></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="planning-for-securing-applications-and-services"><a class="anchor" href="#planning-for-securing-applications-and-services"></a>1. Planning for securing applications and services</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/overview/overview.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/overview/overview.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/overview/overview.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>As an OAuth2, OpenID Connect, and SAML compliant server, Keycloak can secure any application and service as long
as the technology stack they are using supports any of these protocols. For more details about the security protocols
supported by Keycloak, consider looking at <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#sso-protocols">Server Administration Guide</a>.</p>
</div>
<div class="paragraph">
<p>Most of the support for some of these protocols is already available from the programming language, framework,
or reverse proxy they are using. Leveraging the support already available from the application ecosystem is a key aspect to make your
application fully compliant with security standards and best practices, so that you avoid vendor lock-in.</p>
</div>
<div class="paragraph">
<p>For some programming languages, Keycloak provides libraries that try to fill the gap for the lack of support of
a particular security protocol or to provide a more rich and tightly coupled integration with the server. These libraries
are known by <strong>Keycloak Client Adapters</strong>, and they should be used as a last resort if you cannot rely on what is available
from the application ecosystem.</p>
</div>
<div class="sect2">
<h3 id="basic-steps-to-secure-applications-and-services"><a class="anchor" href="#basic-steps-to-secure-applications-and-services"></a>1.1. Basic steps to secure applications and services</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/overview/basic-steps.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/overview/basic-steps.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/overview/basic-steps.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>These are the basic steps for securing an application or a service in Keycloak.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Register a client to a realm using one of these options:</p>
<div class="ulist">
<ul>
<li>
<p>The Keycloak Admin Console</p>
</li>
<li>
<p>The client registration service</p>
</li>
<li>
<p>The CLI</p>
</li>
</ul>
</div>
</li>
<li>
<p>Enable OpenID Connect or SAML protocols in your application using one these options:</p>
<div class="ulist">
<ul>
<li>
<p>Leveraging existing OpenID Connect and SAML support from the application ecosystem</p>
</li>
<li>
<p>Using a Keycloak Adapter</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This guide provides the detailed instructions for these steps. You can find more details
in the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/">Server Administration Guide</a> about how to register a client to Keycloak through the
administration console.</p>
</div>
</div>
<div class="sect2">
<h3 id="getting-started"><a class="anchor" href="#getting-started"></a>1.2. Getting Started</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/overview/getting-started.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/overview/getting-started.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/overview/getting-started.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/keycloak/keycloak-quickstarts">Keycloak Quickstarts Repository</a> provides examples about how to secure applications and services
using different programming languages and frameworks. By going through their documentation and codebase, you will
understand the bare minimum changes required in your application and service in order to secure it with Keycloak.</p>
</div>
<div class="paragraph">
<p>Also, see the following sections for recommendations for trusted and well-known client-side implementations for both OpenID
Connect and SAML protocols.</p>
</div>
<div class="sect3">
<h4 id="openid-connect"><a class="anchor" href="#openid-connect"></a>1.2.1. OpenID Connect</h4>
<div class="sect4">
<h5 id="java"><a class="anchor" href="#java"></a>Java</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/keycloak/keycloak-quickstarts/tree/latest/jakarta/servlet-authz-client">Wildfly Elytron OIDC</a></p>
</li>
<li>
<p><a href="https://github.com/keycloak/keycloak-quickstarts/tree/latest/spring/rest-authz-resource-server">Spring Boot</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="javascript-client-side"><a class="anchor" href="#javascript-client-side"></a>JavaScript (client-side)</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#_javascript_adapter">JavaScript</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="node-js-server-side"><a class="anchor" href="#node-js-server-side"></a>Node.js (server-side)</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#_nodejs_adapter">Node.js</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="c"><a class="anchor" href="#c"></a>C#</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/dylanplecki/KeycloakOwinAuthentication">OWIN</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="python"><a class="anchor" href="#python"></a>Python</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://pypi.org/project/oic/">oidc</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="android"><a class="anchor" href="#android"></a>Android</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/openid/AppAuth-Android">AppAuth</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="ios"><a class="anchor" href="#ios"></a>iOS</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/openid/AppAuth-iOS">AppAuth</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="apache-http-server"><a class="anchor" href="#apache-http-server"></a>Apache HTTP Server</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/OpenIDC/mod_auth_openidc">mod_auth_openidc</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="saml"><a class="anchor" href="#saml"></a>1.2.2. SAML</h4>
<div class="sect4">
<h5 id="java-2"><a class="anchor" href="#java-2"></a>Java</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#_saml_jboss_adapter">JBoss EAP</a></p>
</li>
<li>
<p><a href="#_saml_jboss_adapter">WildFly</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="apache-http-server-2"><a class="anchor" href="#apache-http-server-2"></a>Apache HTTP Server</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#_mod_auth_mellon">mod_auth_mellon</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="terminology"><a class="anchor" href="#terminology"></a>1.3. Terminology</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/overview/terminology.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/overview/terminology.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/overview/terminology.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>These terms are used in this guide:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Clients</code> are entities that interact with Keycloak to authenticate users and obtain tokens. Most often, clients are applications and services acting on behalf of users that provide a single sign-on experience to their users and access other services using the tokens issued by the server. Clients can also be entities only interested in obtaining tokens and acting on their own behalf for accessing other services.</p>
</li>
<li>
<p><code>Applications</code> include a wide range of applications that work for specific platforms for each protocol</p>
</li>
<li>
<p><code>Client adapters</code> are libraries that make it easy to secure applications and services with Keycloak. They provide a tight integration to the underlying platform and framework.</p>
</li>
<li>
<p><code>Creating a client</code> and <code>registering a client</code> are the same action. <code>Creating a Client</code> is the term used to create a client by using the Admin Console. <code>Registering a client</code> is the term used to register a client by using the Keycloak Client Registration Service.</p>
</li>
<li>
<p><code>A service account</code> is a type of client that is able to obtain tokens on its own behalf.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_oidc"><a class="anchor" href="#_oidc"></a>2. Using OpenID Connect to secure applications and services</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/oidc-overview.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/oidc-overview.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/oidc-overview.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>This section describes how you can secure applications and services with OpenID Connect using Keycloak.</p>
</div>
<div class="sect2">
<h3 id="available-endpoints"><a class="anchor" href="#available-endpoints"></a>2.1. Available Endpoints</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/available-endpoints.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/available-endpoints.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/available-endpoints.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>As a fully-compliant OpenID Connect Provider implementation, Keycloak exposes a set of endpoints that applications
and services can use to authenticate and authorize their users.</p>
</div>
<div class="paragraph">
<p>This section describes some of the key endpoints that your application and service should use when
interacting with Keycloak.</p>
</div>
<div class="sect3">
<h4 id="endpoints"><a class="anchor" href="#endpoints"></a>2.1.1. Endpoints</h4>
<div class="paragraph">
<p>The most important endpoint to understand is the <code>well-known</code> configuration endpoint. It lists endpoints and other configuration options relevant to the OpenID Connect implementation in Keycloak. The endpoint is:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/.well-known/openid-configuration</pre>
</div>
</div>
<div class="paragraph">
<p>To obtain the full URL, add the base URL for Keycloak and replace <code>{realm-name}</code> with the name of your realm. For example:</p>
</div>
<div class="paragraph">
<p>http://localhost:8080/realms/master/.well-known/openid-configuration</p>
</div>
<div class="paragraph">
<p>Some RP libraries retrieve all required endpoints from this endpoint, but for others you might need to list the endpoints individually.</p>
</div>
<div class="sect4">
<h5 id="authorization-endpoint"><a class="anchor" href="#authorization-endpoint"></a>Authorization endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/auth</pre>
</div>
</div>
<div class="paragraph">
<p>The authorization endpoint performs authentication of the end-user. This authentication is done by redirecting the user agent to this endpoint.</p>
</div>
<div class="paragraph">
<p>For more details see the <a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint">Authorization Endpoint</a> section in the OpenID Connect specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="token-endpoint"><a class="anchor" href="#token-endpoint"></a>Token endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/token</pre>
</div>
</div>
<div class="paragraph">
<p>The token endpoint is used to obtain tokens. Tokens can either be obtained by exchanging an authorization code or by supplying credentials directly depending on what flow is used.
The token endpoint is also used to obtain new access tokens when they expire.</p>
</div>
<div class="paragraph">
<p>For more details, see the <a href="https://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint">Token Endpoint</a> section in the OpenID Connect specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="userinfo-endpoint"><a class="anchor" href="#userinfo-endpoint"></a>Userinfo endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/userinfo</pre>
</div>
</div>
<div class="paragraph">
<p>The userinfo endpoint returns standard claims about the authenticated user; this endpoint is protected by a bearer token.</p>
</div>
<div class="paragraph">
<p>For more details, see the <a href="https://openid.net/specs/openid-connect-core-1_0.html#UserInfo">Userinfo Endpoint</a> section in the OpenID Connect specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="logout-endpoint"><a class="anchor" href="#logout-endpoint"></a>Logout endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/logout</pre>
</div>
</div>
<div class="paragraph">
<p>The logout endpoint logs out the authenticated user.</p>
</div>
<div class="paragraph">
<p>The user agent can be redirected to the endpoint, which causes the active user session to be logged out. The user agent is then redirected back to the application.</p>
</div>
<div class="paragraph">
<p>The endpoint can also be invoked directly by the application. To invoke this endpoint directly, the refresh token needs to be included as well as the credentials required to authenticate the client.</p>
</div>
</div>
<div class="sect4">
<h5 id="_certificate_endpoint"><a class="anchor" href="#_certificate_endpoint"></a>Certificate endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/certs</pre>
</div>
</div>
<div class="paragraph">
<p>The certificate endpoint returns the public keys enabled by the realm, encoded as a JSON Web Key (JWK). Depending on the realm settings, one or more keys can be enabled for verifying tokens. For more information, see the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/">Server Administration Guide</a> and the <a href="https://datatracker.ietf.org/doc/html/rfc7517">JSON Web Key specification</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_token_introspection_endpoint"><a class="anchor" href="#_token_introspection_endpoint"></a>Introspection endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/token/introspect</pre>
</div>
</div>
<div class="paragraph">
<p>The introspection endpoint is used to retrieve the active state of a token. In other words, you can use it to validate an access or refresh token.
This endpoint can only be invoked by confidential clients.</p>
</div>
<div class="paragraph">
<p>For more details on how to invoke on this endpoint, see <a href="https://datatracker.ietf.org/doc/html/rfc7662">OAuth 2.0 Token Introspection specification</a>.</p>
</div>
<div class="sect5">
<h6 id="introspection-endpoint-triggered-with-applicationjwt-header"><a class="anchor" href="#introspection-endpoint-triggered-with-applicationjwt-header"></a>Introspection endpoint triggered with application/jwt header</h6>
<div class="paragraph">
<p>You can invoke an introspection endpoint with the HTTP header <code>Accept: application/jwt</code> instead of <code>Accept: application/json</code>. In case of <code>application/jwt</code>, the response
may contain the additional claim <code>jwt</code> with the full JWT access token, which can be useful especially if the token to be introspected was a <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_using_lightweight_access_token">lightweight access token</a>. This requires that you enable <code>Support JWT claim in Introspection Response</code>
on the client advanced settings, which triggers the token introspection.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="dynamic-client-registration-endpoint"><a class="anchor" href="#dynamic-client-registration-endpoint"></a>Dynamic Client Registration endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/clients-registrations/openid-connect</pre>
</div>
</div>
<div class="paragraph">
<p>The dynamic client registration endpoint is used to dynamically register clients.</p>
</div>
<div class="paragraph">
<p>For more details, see the <a href="#_client_registration">Client Registration chapter</a> and the
<a href="https://openid.net/specs/openid-connect-registration-1_0.html">OpenID Connect Dynamic Client Registration specification</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_token_revocation_endpoint"><a class="anchor" href="#_token_revocation_endpoint"></a>Token Revocation endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/revoke</pre>
</div>
</div>
<div class="paragraph">
<p>The token revocation endpoint is used to revoke tokens. Both refresh tokens and access tokens are supported by this endpoint. When revoking a refresh token, the user consent for the corresponding client is also revoked.</p>
</div>
<div class="paragraph">
<p>For more details on how to invoke on this endpoint, see <a href="https://datatracker.ietf.org/doc/html/rfc7009">OAuth 2.0 Token Revocation specification</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="device-authorization-endpoint"><a class="anchor" href="#device-authorization-endpoint"></a>Device Authorization endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/auth/device</pre>
</div>
</div>
<div class="paragraph">
<p>The device authorization endpoint is used to obtain a device code and a user code. It can be invoked by confidential or public clients.</p>
</div>
<div class="paragraph">
<p>For more details on how to invoke on this endpoint, see <a href="https://datatracker.ietf.org/doc/html/rfc8628">OAuth 2.0 Device Authorization Grant specification</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_backchannel_authentication_endpoint"><a class="anchor" href="#_backchannel_authentication_endpoint"></a>Backchannel Authentication endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/ext/ciba/auth</pre>
</div>
</div>
<div class="paragraph">
<p>The backchannel authentication endpoint is used to obtain an auth_req_id that identifies the authentication request made by the client. It can only be invoked by confidential clients.</p>
</div>
<div class="paragraph">
<p>For more details on how to invoke on this endpoint, see <a href="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html">OpenID Connect Client Initiated Backchannel Authentication Flow specification</a>.</p>
</div>
<div class="paragraph">
<p>Also refer to other places of Keycloak documentation like <a href="#_client_initiated_backchannel_authentication_grant">Client Initiated Backchannel Authentication Grant section of this guide</a> and <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_client_initiated_backchannel_authentication_grant">Client Initiated Backchannel Authentication Grant section</a> of Server Administration Guide.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="supported-grant-types"><a class="anchor" href="#supported-grant-types"></a>2.2. Supported Grant Types</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/supported-grant-types.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/supported-grant-types.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/supported-grant-types.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>This section describes the different grant types available to relaying parties.</p>
</div>
<div class="sect3">
<h4 id="authorization-code"><a class="anchor" href="#authorization-code"></a>2.2.1. Authorization code</h4>
<div class="paragraph">
<p>The Authorization Code flow redirects the user agent to Keycloak. Once the user has successfully authenticated with Keycloak, an
Authorization Code is created and the user agent is redirected back to the application. The application then uses the authorization code along with its
credentials to obtain an Access Token, Refresh Token and ID Token from Keycloak.</p>
</div>
<div class="paragraph">
<p>The flow is targeted towards web applications, but is also recommended for native applications, including mobile applications, where it is possible to embed
a user agent.</p>
</div>
<div class="paragraph">
<p>For more details refer to the <a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth">Authorization Code Flow</a> in the OpenID Connect specification.</p>
</div>
</div>
<div class="sect3">
<h4 id="implicit"><a class="anchor" href="#implicit"></a>2.2.2. Implicit</h4>
<div class="paragraph">
<p>The Implicit flow works similarly to the Authorization Code flow, but instead of returning an Authorization Code, the Access Token and ID Token is
returned. This approach reduces the need for the extra invocation to exchange the Authorization Code for an Access Token. However, it does not include a Refresh
Token. This results in the need to permit Access Tokens with a long expiration; however, that approach is not practical because it is very hard to invalidate these tokens. Alternatively, you can
require a new redirect to obtain a new Access Token once the initial Access Token has expired. The Implicit flow is useful if the application only wants to
authenticate the user and deals with logout itself.</p>
</div>
<div class="paragraph">
<p>You can instead use a Hybrid flow where both the Access Token and an Authorization Code are returned.</p>
</div>
<div class="paragraph">
<p>One thing to note is that both the Implicit flow and Hybrid flow have potential security risks as the Access Token may be leaked through web server logs and
browser history. You can somewhat mitigate this problem by using short expiration for Access Tokens.</p>
</div>
<div class="paragraph">
<p>For more details, see the <a href="https://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth">Implicit Flow</a> in the OpenID Connect specification.</p>
</div>
<div class="paragraph">
<p>Per current <a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#name-implicit-grant">OAuth 2.0 Security Best Current Practice</a>, this flow should not be used.
This flow is removed from the future <a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-09">OAuth 2.1 specification</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_resource_owner_password_credentials_flow"><a class="anchor" href="#_resource_owner_password_credentials_flow"></a>2.2.3. Resource Owner Password Credentials</h4>
<div class="paragraph">
<p>Resource Owner Password Credentials, referred to as Direct Grant in Keycloak, allows exchanging user credentials for tokens.
Per current <a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#name-resource-owner-password-cre">OAuth 2.0 Security Best Practices</a>,
this flow should not be used, preferring alternative methods such as <a href="#device-authorization-grant">Device Authorization Grant</a> or <a href="#authorization-code">Authorization code</a>.</p>
</div>
<div class="paragraph">
<p>The limitations of using this flow include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>User credentials are exposed to the application</p>
</li>
<li>
<p>Applications need login pages</p>
</li>
<li>
<p>Application needs to be aware of the authentication scheme</p>
</li>
<li>
<p>Changes to authentication flow requires changes to application</p>
</li>
<li>
<p>No support for identity brokering or social login</p>
</li>
<li>
<p>Flows are not supported (user self-registration, required actions, and so on.)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Security concerns with this flow include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Involving more than Keycloak in handling of credentials</p>
</li>
<li>
<p>Increased vulnerable surface area where credential leaks can happen</p>
</li>
<li>
<p>Creating an ecosystem where users trust another application for entering their credentials and not Keycloak</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a client to be permitted to use the Resource Owner Password Credentials grant, the client has to have the <code>Direct Access Grants Enabled</code> option enabled.</p>
</div>
<div class="paragraph">
<p>This flow is not included in OpenID Connect, but is a part of the OAuth 2.0 specification.
It is removed from the future <a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-09">OAuth 2.1 specification</a>.</p>
</div>
<div class="paragraph">
<p>For more details, see the <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-4.3">Resource Owner Password Credentials Grant</a> chapter in the OAuth 2.0 specification.</p>
</div>
<div class="sect4">
<h5 id="example-using-curl"><a class="anchor" href="#example-using-curl"></a>Example using CURL</h5>
<div class="paragraph">
<p>The following example shows how to obtain an access token for a user in the realm <code>master</code> with username <code>user</code> and password <code>password</code>. The example is using
the confidential client <code>myclient</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl \
  -d &quot;client_id=myclient&quot; \
  -d &quot;client_secret=40cc097b-2a57-4c17-b36a-8fdf3fc2d578&quot; \
  -d &quot;username=user&quot; \
  -d &quot;password=password&quot; \
  -d &quot;grant_type=password&quot; \
  &quot;http://localhost:8080/realms/master/protocol/openid-connect/token&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="client-credentials"><a class="anchor" href="#client-credentials"></a>2.2.4. Client credentials</h4>
<div class="paragraph">
<p>Client Credentials are used when clients (applications and services) want to obtain access on behalf of themselves rather than on behalf of a user. For example, these credentials can
 be useful for background services that apply changes to the system in general rather than for a specific user.</p>
</div>
<div class="paragraph">
<p>Keycloak provides support for clients to authenticate either with a secret or with public/private keys.</p>
</div>
<div class="paragraph">
<p>This flow is not included in OpenID Connect, but is a part of the OAuth 2.0 specification.</p>
</div>
<div class="paragraph">
<p>For more details, see the <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-4.4">Client Credentials Grant</a> chapter in the OAuth 2.0 specification.</p>
</div>
</div>
<div class="sect3">
<h4 id="device-authorization-grant"><a class="anchor" href="#device-authorization-grant"></a>2.2.5. Device Authorization Grant</h4>
<div class="paragraph">
<p>Device Authorization Grant is used by clients running on internet-connected devices that have limited input capabilities or lack a suitable browser.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The application requests  that Keycloak provide a device code and a user code.</p>
</li>
<li>
<p>Keycloak creates a device code and a user code.</p>
</li>
<li>
<p>Keycloak returns a response including the device code and the user code to the application.</p>
</li>
<li>
<p>The application provides the user with the user code and the verification URI. The user accesses a verification URI to be authenticated by using another browser.</p>
</li>
<li>
<p>The application repeatedly polls Keycloak until Keycloak completes the user authorization.</p>
</li>
<li>
<p>If user authentication is complete, the application obtains the device code.</p>
</li>
<li>
<p>The application uses the device code along with its credentials to obtain an Access Token, Refresh Token and ID Token from Keycloak.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more details, see  the <a href="https://datatracker.ietf.org/doc/html/rfc8628">OAuth 2.0 Device Authorization Grant specification</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_client_initiated_backchannel_authentication_grant"><a class="anchor" href="#_client_initiated_backchannel_authentication_grant"></a>2.2.6. Client Initiated Backchannel Authentication Grant</h4>
<div class="paragraph">
<p>Client Initiated Backchannel Authentication Grant is used by clients who want to initiate the authentication flow by communicating with the OpenID Provider directly without redirect through the user&#8217;s browser like OAuth 2.0&#8217;s authorization code grant.</p>
</div>
<div class="paragraph">
<p>The client requests from Keycloak an auth_req_id that identifies the authentication request made by the client. Keycloak creates the auth_req_id.</p>
</div>
<div class="paragraph">
<p>After receiving this auth_req_id, this client repeatedly needs to poll Keycloak to obtain an Access Token, Refresh Token, and ID Token from Keycloak in return for the auth_req_id until the user is authenticated.</p>
</div>
<div class="paragraph">
<p>In case that client uses <code>ping</code> mode, it does not need to repeatedly poll the token endpoint, but it can wait for the notification sent by Keycloak to the specified Client Notification Endpoint.
The Client Notification Endpoint can be configured in the Keycloak Admin Console. The details of the contract for Client Notification Endpoint are described in the CIBA specification.</p>
</div>
<div class="paragraph">
<p>For more details, see <a href="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html">OpenID Connect Client Initiated Backchannel Authentication Flow specification</a>.</p>
</div>
<div class="paragraph">
<p>Also refer to other places of Keycloak documentation such as <a href="#_backchannel_authentication_endpoint">Backchannel Authentication Endpoint of this guide</a> and <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_client_initiated_backchannel_authentication_grant">Client Initiated Backchannel Authentication Grant section</a> of Server Administration Guide.
For the details about FAPI CIBA compliance, see the <a href="#_fapi-support">FAPI section of this guide</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_oidc-errors"><a class="anchor" href="#_oidc-errors"></a>2.3. Keycloak specific errors</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/oidc-errors.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/oidc-errors.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/oidc-errors.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak server can send errors to the client application in the OIDC authentication response with parameters <code>error=temporarily_unavailable</code> and <code>error_description=authentication_expired</code>.
Keycloak sends this error when a user is authenticated and has an SSO session, but the authentication session expired in the current browser tab and hence the Keycloak server cannot automatically do SSO
re-authentication of the user and redirect back to client with a successful response. When a client application receives this type of error, it is ideal to retry authentication immediately and send a new
OIDC authentication request to the Keycloak server, which should typically always authenticate the user due to the SSO session and redirect back. For more details, see
the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_authentication-sessions">Server Administration Guide</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="keycloak-java-adapters"><a class="anchor" href="#keycloak-java-adapters"></a>2.4. Keycloak Java adapters</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/java/java-adapters.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/java/java-adapters.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/java/java-adapters.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Keycloak Java Adapters were removed from Keycloak codebase and they are not supported anymore.</p>
</div>
<div class="paragraph">
<p>For more details about how to integrate Keycloak with Java applications, consider looking at the
<a href="https://github.com/keycloak/keycloak-quickstarts">Keycloak Quickstart GitHub Repository</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_javascript_adapter"><a class="anchor" href="#_javascript_adapter"></a>2.5. Keycloak JavaScript adapter</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/javascript-adapter.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/javascript-adapter.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/javascript-adapter.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak comes with a client-side JavaScript library called <code>keycloak-js</code> that can be used to secure web applications. The adapter also comes with built-in support for Cordova applications.</p>
</div>
<div class="sect3">
<h4 id="installation"><a class="anchor" href="#installation"></a>2.5.1. Installation</h4>
<div class="paragraph">
<p>The adapter is distributed in several ways, but we recommend that you install the <a href="https://www.npmjs.com/package/keycloak-js"><code>keycloak-js</code></a> package from NPM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">npm install keycloak-js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the library can be retrieved directly from the Keycloak server at <code>/js/keycloak.js</code> and is also distributed as a ZIP archive. We are however considering the inclusion of the adapter directly from the Keycloak server as deprecated, and this functionality might be removed in the future.</p>
</div>
</div>
<div class="sect3">
<h4 id="keycloak-server-configuration"><a class="anchor" href="#keycloak-server-configuration"></a>2.5.2. Keycloak server configuration</h4>
<div class="paragraph">
<p>One important thing to consider about using client-side applications is that the client has to be a public client as there is no secure way to store client credentials in a client-side application. This consideration makes it very important to make sure the redirect URIs you have configured for the client are correct and as specific as possible.</p>
</div>
<div class="paragraph">
<p>To use the adapter, create a client for your application in the Keycloak Admin Console. Make the client public by toggling <strong>Client authentication</strong>  to <strong>Off</strong>  on the <strong>Capability config</strong> page.</p>
</div>
<div class="paragraph">
<p>You also need to configure <code>Valid Redirect URIs</code> and <code>Web Origins</code>. Be as specific as possible as failing to do so may result in a security vulnerability.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-the-adapter"><a class="anchor" href="#using-the-adapter"></a>2.5.3. Using the adapter</h4>
<div class="paragraph">
<p>The following example shows how to initialize the adapter. Make sure that you replace the options passed to the <code>Keycloak</code> constructor with those of the client you have configured.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="reserved">import</span> Keycloak from <span class="string"><span class="delimiter">'</span><span class="content">keycloak-js</span><span class="delimiter">'</span></span>;

const keycloak = <span class="keyword">new</span> Keycloak({
    <span class="key">url</span>: <span class="string"><span class="delimiter">'</span><span class="content">http://keycloak-server${kc_base_path}</span><span class="delimiter">'</span></span>,
    <span class="key">realm</span>: <span class="string"><span class="delimiter">'</span><span class="content">myrealm</span><span class="delimiter">'</span></span>,
    <span class="key">clientId</span>: <span class="string"><span class="delimiter">'</span><span class="content">myapp</span><span class="delimiter">'</span></span>
});

<span class="keyword">try</span> {
    const authenticated = await keycloak.init();
    console.log(<span class="error">`</span>User is <span class="predefined">$</span>{authenticated ? <span class="string"><span class="delimiter">'</span><span class="content">authenticated</span><span class="delimiter">'</span></span> : <span class="string"><span class="delimiter">'</span><span class="content">not authenticated</span><span class="delimiter">'</span></span>}<span class="error">`</span>);
} <span class="keyword">catch</span> (error) {
    console.error(<span class="string"><span class="delimiter">'</span><span class="content">Failed to initialize adapter:</span><span class="delimiter">'</span></span>, error);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To authenticate, you call the <code>login</code> function. Two options exist to make the adapter automatically authenticate. You can pass <code>login-required</code> or <code>check-sso</code> to the <code>init()</code> function.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>login-required</code> authenticates the client if the user is logged in to Keycloak or displays the login page if the user is not logged in.</p>
</li>
<li>
<p><code>check-sso</code> only authenticates the client if the user is already logged in. If the user is not logged in, the browser is redirected back to the application and remains unauthenticated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can configure a <em>silent</em> <code>check-sso</code> option. With this feature enabled, your browser will not perform a full redirect to the Keycloak server and back to your application, but this action will be performed in a hidden iframe. Therefore, your application resources are only loaded and parsed once by the browser, namely when the application is initialized and not again after the redirect back from Keycloak to your application. This approach is particularly useful in case of SPAs (Single Page Applications).</p>
</div>
<div class="paragraph">
<p>To enable the <em>silent</em> <code>check-sso</code>, you provide a <code>silentCheckSsoRedirectUri</code> attribute in the init method. Make sure this URI is a valid endpoint in the application; it must be configured as a valid redirect for the client in the Keycloak Admin Console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.init({
    <span class="key">onLoad</span>: <span class="string"><span class="delimiter">'</span><span class="content">check-sso</span><span class="delimiter">'</span></span>,
    <span class="key">silentCheckSsoRedirectUri</span>: <span class="error">`</span><span class="predefined">$</span>{location.origin}/silent-check-sso.html<span class="error">`</span>
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The page at the silent check-sso redirect uri is loaded in the iframe after successfully checking your authentication state and retrieving the tokens from the Keycloak server.
It has no other task than sending the received tokens to the main application and should only look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="doctype">&lt;!doctype html&gt;</span>
<span class="tag">&lt;html&gt;</span>
<span class="tag">&lt;body&gt;</span>
    <span class="tag">&lt;script&gt;</span>
<span class="inline">        parent.postMessage(location.href, location.origin);</span>
    <span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that this page must be served by your application at the specified location in <code>silentCheckSsoRedirectUri</code> and is <em>not</em> part of the adapter.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<em>Silent</em> <code>check-sso</code> functionality is limited in some modern browsers. Please see the <a href="#_modern_browsers">Modern Browsers with Tracking Protection Section</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To enable <code>login-required</code> set <code>onLoad</code> to <code>login-required</code> and pass to the init method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.init({
    <span class="key">onLoad</span>: <span class="string"><span class="delimiter">'</span><span class="content">login-required</span><span class="delimiter">'</span></span>
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>After the user is authenticated the application can make requests to RESTful services secured by Keycloak by including the bearer token in the
<code>Authorization</code> header. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">async <span class="keyword">function</span> <span class="function">fetchUsers</span>() {
    const response = await fetch(<span class="string"><span class="delimiter">'</span><span class="content">/api/users</span><span class="delimiter">'</span></span>, {
        <span class="key">headers</span>: {
            <span class="key">accept</span>: <span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>,
            <span class="key">authorization</span>: <span class="error">`</span>Bearer <span class="predefined">$</span>{keycloak.token}<span class="error">`</span>
        }
    });

    <span class="keyword">return</span> response.json();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One thing to keep in mind is that the access token by default has a short life expiration so you may need to refresh the access token prior to sending the request. You refresh this token by calling the <code>updateToken()</code> method. This method returns a Promise, which makes it easy to invoke the service only if the token was successfully refreshed and displays an error to the user if it was not refreshed. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">try</span> {
    await keycloak.updateToken(<span class="integer">30</span>);
} <span class="keyword">catch</span> (error) {
    console.error(<span class="string"><span class="delimiter">'</span><span class="content">Failed to refresh token:</span><span class="delimiter">'</span></span>, error);
}

const users = await fetchUsers();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Both access and refresh token are stored in memory and are not persisted in any kind of storage. Therefore, these tokens should never be persisted to prevent hijacking attacks.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="session-status-iframe"><a class="anchor" href="#session-status-iframe"></a>2.5.4. Session Status iframe</h4>
<div class="paragraph">
<p>By default, the adapter creates a hidden iframe that is used to detect if a Single-Sign Out has occurred. This iframe does not require any network traffic. Instead the status is retrieved by looking at a special status cookie. This feature can be disabled by setting <code>checkLoginIframe: false</code> in the options passed to the <code>init()</code> method.</p>
</div>
<div class="paragraph">
<p>You should not rely on looking at this cookie directly. Its format can change and it&#8217;s also associated with the URL of the Keycloak server, not
your application.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Session Status iframe functionality is limited in some modern browsers. Please see <a href="#_modern_browsers">Modern Browsers with Tracking Protection Section</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_javascript_implicit_flow"><a class="anchor" href="#_javascript_implicit_flow"></a>2.5.5. Implicit and hybrid flow</h4>
<div class="paragraph">
<p>By default, the adapter uses the <a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth">Authorization Code</a> flow.</p>
</div>
<div class="paragraph">
<p>With this flow,  the Keycloak server returns an authorization code, not an authentication token, to the application. The JavaScript adapter exchanges the <code>code</code> for an access token and a refresh token after the browser is redirected back to the application.</p>
</div>
<div class="paragraph">
<p>Keycloak also supports the <a href="https://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth">Implicit</a> flow where an access token is sent immediately after successful authentication with Keycloak. This flow may have better performance than the standard flow because no additional request exists to exchange the code for tokens, but it has implications when the access token expires.</p>
</div>
<div class="paragraph">
<p>However, sending the access token in the URL fragment can be a security vulnerability. For example the token could be leaked through web server logs and or
browser history.</p>
</div>
<div class="paragraph">
<p>To enable implicit flow, you enable the <strong>Implicit Flow Enabled</strong> flag for the client in the Keycloak Admin Console. You also pass the parameter <code>flow</code> with the value <code>implicit</code> to <code>init</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.init({
    <span class="key">flow</span>: <span class="string"><span class="delimiter">'</span><span class="content">implicit</span><span class="delimiter">'</span></span>
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that only an access token is provided and no refresh token exists. This situation means that once the access token has expired, the application has to redirect to Keycloak again to obtain a new access token.</p>
</div>
<div class="paragraph">
<p>Keycloak also supports the <a href="https://openid.net/specs/openid-connect-core-1_0.html#HybridFlowAuth">Hybrid</a> flow.</p>
</div>
<div class="paragraph">
<p>This flow requires the client to have both the <strong>Standard Flow</strong>  and <strong>Implicit Flow</strong>  enabled in the Admin Console. The Keycloak server then sends both the code and tokens to your application. The access token can be used immediately while the code can be exchanged for access and refresh tokens. Similar to the implicit flow, the hybrid flow is good for performance because the access token is available immediately.
But, the token is still sent in the URL, and the security vulnerability mentioned earlier may still apply.</p>
</div>
<div class="paragraph">
<p>One advantage in the Hybrid flow is that the refresh token is made available to the application.</p>
</div>
<div class="paragraph">
<p>For the Hybrid flow, you need to pass the parameter <code>flow</code> with value <code>hybrid</code> to the <code>init</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.init({
    <span class="key">flow</span>: <span class="string"><span class="delimiter">'</span><span class="content">hybrid</span><span class="delimiter">'</span></span>
});</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="hybrid-apps-with-cordova"><a class="anchor" href="#hybrid-apps-with-cordova"></a>2.5.6. Hybrid Apps with Cordova</h4>
<div class="paragraph">
<p>Keycloak supports hybrid mobile apps developed with <a href="https://cordova.apache.org/">Apache Cordova</a>. The adapter has two modes for this: <code>cordova</code> and <code>cordova-native</code>:</p>
</div>
<div class="paragraph">
<p>The default is <code>cordova</code>, which the adapter automatically selects if no adapter type has been explicitly configured and <code>window.cordova</code> is present. When logging in, it opens an <a href="https://cordova.apache.org/docs/en/latest/reference/cordova-plugin-inappbrowser/">InApp Browser</a> that lets the user interact with Keycloak and afterwards returns to the app by redirecting to <code><a href="http://localhost" class="bare">http://localhost</a></code>. Because of this behavior, you whitelist this URL as a valid redirect-uri in the client configuration section of the Admin Console.</p>
</div>
<div class="paragraph">
<p>While this mode is easy to set up, it also has some disadvantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The InApp-Browser is a browser embedded in the app and is not the phone&#8217;s default browser. Therefore it will have different settings and stored credentials will not be available.</p>
</li>
<li>
<p>The InApp-Browser might also be slower, especially when rendering more complex themes.</p>
</li>
<li>
<p>There are security concerns to consider, before using this mode, such as that it is possible for the app to gain access to the credentials of the user, as it has full control of the browser rendering the login page, so do not allow its use in apps you do not trust.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The alternative mode  is`cordova-native`, which takes a different approach. It opens the login page using the system&#8217;s browser. After the user has authenticated, the browser redirects back into the application using a special URL. From there, the Keycloak adapter can finish the login by reading the code or token from the URL.</p>
</div>
<div class="paragraph">
<p>You can activate the native mode by passing the adapter type <code>cordova-native</code> to the <code>init()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.init({
    <span class="key">adapter</span>: <span class="string"><span class="delimiter">'</span><span class="content">cordova-native</span><span class="delimiter">'</span></span>
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>This adapter requires two additional plugins:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/google/cordova-plugin-browsertab">cordova-plugin-browsertab</a>: allows the app to open webpages in the system&#8217;s browser</p>
</li>
<li>
<p><a href="https://github.com/e-imaxina/cordova-plugin-deeplinks">cordova-plugin-deeplinks</a>: allow the browser to redirect back to your app by special URLs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The technical details for linking to an app differ on each platform and special setup is needed.
Please refer to the Android and iOS sections of the <a href="https://github.com/e-imaxina/cordova-plugin-deeplinks/blob/master/README.md">deeplinks plugin documentation</a> for further instructions.</p>
</div>
<div class="paragraph">
<p>Different kinds of links exist for opening apps:
* custom schemes, such as <code>myapp://login</code> or <code>android-app://com.example.myapp/https/example.com/login</code>
* <a href="https://developer.apple.com/ios/universal-links/">Universal Links (iOS)</a>) / <a href="https://developer.android.com/training/app-links/deep-linking">Deep Links (Android)</a>.
While the former are easier to set up and tend to work more reliably, the latter offer extra security because they are unique and only the owner of a domain can register them. Custom-URLs are deprecated on iOS.  For best reliability, we recommend that you use universal links combined with a fallback site that uses a custom-url link.</p>
</div>
<div class="paragraph">
<p>Furthermore, we recommend the following steps to improve compatibility with the adapter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Universal Links on iOS seem to work more reliably with <code>response-mode</code> set to <code>query</code></p>
</li>
<li>
<p>To prevent Android from opening a new instance of your app on redirect add the following snippet to <code>config.xml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;preference</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AndroidLaunchMode</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">singleTask</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="custom-adapters"><a class="anchor" href="#custom-adapters"></a>2.5.7. Custom Adapters</h4>
<div class="paragraph">
<p>In some situations, you may need to run the adapter in environments that are not supported by default, such as Capacitor. To use the JavasScript client in these environments, you can pass a custom adapter. For example, a third-party library could provide such an adapter to make it possible to reliably run the adapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="reserved">import</span> Keycloak from <span class="string"><span class="delimiter">'</span><span class="content">keycloak-js</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> KeycloakCapacitorAdapter from <span class="string"><span class="delimiter">'</span><span class="content">keycloak-capacitor-adapter</span><span class="delimiter">'</span></span>;

const keycloak = <span class="keyword">new</span> Keycloak();

keycloak.init({
    <span class="key">adapter</span>: KeycloakCapacitorAdapter,
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>This specific package does not exist, but it gives a pretty good example of how such an adapter could be passed into the client.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also possible to make your own adapter, to do so you will have to implement the methods described in the <code>KeycloakAdapter</code> interface. For example the following TypeScript code ensures that all the methods are properly implemented:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="typescript">import Keycloak, { KeycloakAdapter } from 'keycloak-js';

// Implement the 'KeycloakAdapter' interface so that all required methods are guaranteed to be present.
const MyCustomAdapter: KeycloakAdapter = {
    login(options) {
        // Write your own implementation here.
    }

    // The other methods go here...
};

const keycloak = new Keycloak();

keycloak.init({
    adapter: MyCustomAdapter,
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Naturally you can also do this without TypeScript by omitting the type information, but ensuring implementing the interface properly will then be left entirely up to you.</p>
</div>
</div>
<div class="sect3">
<h4 id="_modern_browsers"><a class="anchor" href="#_modern_browsers"></a>2.5.8. Modern Browsers with Tracking Protection</h4>
<div class="paragraph">
<p>In the latest versions of some browsers, various cookies policies are applied to prevent tracking of the users by third parties, such as SameSite in Chrome or completely blocked third-party cookies. Those policies are likely to become more restrictive and adopted by other browsers over time. Eventually cookies in third-party contexts may become completely unsupported and blocked by the browsers. As a result, the affected adapter features might ultimately be deprecated.</p>
</div>
<div class="paragraph">
<p>The adapter relies on third-party cookies for Session Status iframe, <em>silent</em> <code>check-sso</code> and partially also for regular (non-silent) <code>check-sso</code>. Those features have limited functionality or are completely disabled based on how restrictive the browser is regarding cookies. The adapter tries to detect this setting and reacts accordingly.</p>
</div>
<div class="sect4">
<h5 id="browsers-with-samesitelax-by-default-policy"><a class="anchor" href="#browsers-with-samesitelax-by-default-policy"></a>Browsers with "SameSite=Lax by Default" Policy</h5>
<div class="paragraph">
<p>All features are supported if SSL / TLS connection is configured on the Keycloak side as well as on the application side.  For example, Chrome is affected starting with version 84.</p>
</div>
</div>
<div class="sect4">
<h5 id="browsers-with-blocked-third-party-cookies"><a class="anchor" href="#browsers-with-blocked-third-party-cookies"></a>Browsers with Blocked Third-Party Cookies</h5>
<div class="paragraph">
<p>Session Status iframe is not supported and is automatically disabled if such browser behavior is detected by the adapter. This means the adapter cannot use a session cookie for Single Sign-Out detection and must rely purely on tokens. As a result, when a user logs out in another window, the application using the adapter will not be logged out until the application tries to refresh the Access Token. Therefore, consider setting the Access Token Lifespan to a relatively short time, so that the logout is detected as soon as possible. For more details, see <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_timeouts">Session and Token Timeouts</a>.</p>
</div>
<div class="paragraph">
<p><em>Silent</em> <code>check-sso</code> is not supported and falls back to regular (non-silent) <code>check-sso</code> by default. This behavior can be changed by setting <code>silentCheckSsoFallback: false</code> in the options passed to the <code>init</code> method. In this case, <code>check-sso</code> will be completely disabled if restrictive browser behavior is detected.</p>
</div>
<div class="paragraph">
<p>Regular <code>check-sso</code> is affected as well. Since Session Status iframe is unsupported, an additional redirect to Keycloak has to be made when the adapter is initialized to check the user&#8217;s login status. This check is different from the standard behavior when the iframe is used to tell whether the user is logged in, and the redirect is performed only when the user is logged out.</p>
</div>
<div class="paragraph">
<p>An affected browser is for example Safari starting with version 13.1.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="api-reference"><a class="anchor" href="#api-reference"></a>2.5.9. API Reference</h4>
<div class="sect4">
<h5 id="constructor"><a class="anchor" href="#constructor"></a>Constructor</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">new</span> Keycloak();
<span class="keyword">new</span> Keycloak(<span class="string"><span class="delimiter">'</span><span class="content">http://localhost/keycloak.json</span><span class="delimiter">'</span></span>);
<span class="keyword">new</span> Keycloak({ <span class="key">url</span>: <span class="string"><span class="delimiter">'</span><span class="content">http://localhost</span><span class="delimiter">'</span></span>, <span class="key">realm</span>: <span class="string"><span class="delimiter">'</span><span class="content">myrealm</span><span class="delimiter">'</span></span>, <span class="key">clientId</span>: <span class="string"><span class="delimiter">'</span><span class="content">myApp</span><span class="delimiter">'</span></span> });</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="properties"><a class="anchor" href="#properties"></a>Properties</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">authenticated</dt>
<dd>
<p>Is <code>true</code> if the user is authenticated, <code>false</code> otherwise.</p>
</dd>
<dt class="hdlist1">token</dt>
<dd>
<p>The base64 encoded token that can be sent in the <code>Authorization</code> header in requests to services.</p>
</dd>
<dt class="hdlist1">tokenParsed</dt>
<dd>
<p>The parsed token as a JavaScript object.</p>
</dd>
<dt class="hdlist1">subject</dt>
<dd>
<p>The user id.</p>
</dd>
<dt class="hdlist1">idToken</dt>
<dd>
<p>The base64 encoded ID token.</p>
</dd>
<dt class="hdlist1">idTokenParsed</dt>
<dd>
<p>The parsed id token as a JavaScript object.</p>
</dd>
<dt class="hdlist1">realmAccess</dt>
<dd>
<p>The realm roles associated with the token.</p>
</dd>
<dt class="hdlist1">resourceAccess</dt>
<dd>
<p>The resource roles associated with the token.</p>
</dd>
<dt class="hdlist1">refreshToken</dt>
<dd>
<p>The base64 encoded refresh token that can be used to retrieve a new token.</p>
</dd>
<dt class="hdlist1">refreshTokenParsed</dt>
<dd>
<p>The parsed refresh token as a JavaScript object.</p>
</dd>
<dt class="hdlist1">timeSkew</dt>
<dd>
<p>The estimated time difference between the browser time and the Keycloak server in seconds. This value is just an estimation, but is accurate
enough when determining if a token is expired or not.</p>
</dd>
<dt class="hdlist1">responseMode</dt>
<dd>
<p>Response mode passed in init (default value is fragment).</p>
</dd>
<dt class="hdlist1">flow</dt>
<dd>
<p>Flow passed in init.</p>
</dd>
<dt class="hdlist1">adapter</dt>
<dd>
<p>Allows you to override the way that redirects and other browser-related functions will be handled by the library.
Available options:</p>
<div class="ulist">
<ul>
<li>
<p>"default" - the library uses the browser api for redirects (this is the default)</p>
</li>
<li>
<p>"cordova" - the library will try to use the InAppBrowser cordova plugin to load keycloak login/registration pages (this is used automatically when the library is working in a cordova ecosystem)</p>
</li>
<li>
<p>"cordova-native" - the library tries to open the login and registration page using the phone&#8217;s system browser using the BrowserTabs cordova plugin. This requires extra setup for redirecting back to the app (see <a href="#hybrid-apps-with-cordova">Hybrid Apps with Cordova</a>).</p>
</li>
<li>
<p>"custom" - allows you to implement a custom adapter (only for advanced use cases)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">responseType</dt>
<dd>
<p>Response type sent to Keycloak with login requests. This is determined based on the flow value used during initialization, but can be overridden by setting this value.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="methods"><a class="anchor" href="#methods"></a>Methods</h5>
<div class="paragraph">
<p><strong>init(options)</strong></p>
</div>
<div class="paragraph">
<p>Called to initialize the adapter.</p>
</div>
<div class="paragraph">
<p>Options is an Object, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>useNonce - Adds a cryptographic nonce to verify that the authentication response matches the request (default is <code>true</code>).</p>
</li>
<li>
<p>onLoad - Specifies an action to do on load. Supported values are <code>login-required</code> or <code>check-sso</code>.</p>
</li>
<li>
<p>silentCheckSsoRedirectUri - Set the redirect uri for silent authentication check if onLoad is set to 'check-sso'.</p>
</li>
<li>
<p>silentCheckSsoFallback - Enables fall back to regular <code>check-sso</code> when <em>silent</em> <code>check-sso</code> is not supported by the browser (default is <code>true</code>).</p>
</li>
<li>
<p>token - Set an initial value for the token.</p>
</li>
<li>
<p>refreshToken - Set an initial value for the refresh token.</p>
</li>
<li>
<p>idToken - Set an initial value for the id token (only together with token or refreshToken).</p>
</li>
<li>
<p>scope - Set the default scope parameter to the Keycloak login endpoint. Use a space-delimited list of scopes. Those typically
reference <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_client_scopes">Client scopes</a> defined on a particular client. Note that the scope <code>openid</code> will
always be added to the list of scopes by the adapter. For example, if you enter the scope options <code>address phone</code>, then the request
to Keycloak will contain the scope parameter <code>scope=openid address phone</code>. Note that the default scope specified here is overwritten if the <code>login()</code> options specify scope explicitly.</p>
</li>
<li>
<p>timeSkew - Set an initial value for skew between local time and Keycloak server in seconds (only together with token or refreshToken).</p>
</li>
<li>
<p>checkLoginIframe - Set to enable/disable monitoring login state (default is <code>true</code>).</p>
</li>
<li>
<p>checkLoginIframeInterval - Set the interval to check login state (default is 5 seconds).</p>
</li>
<li>
<p>responseMode - Set the OpenID Connect response mode send to Keycloak server at login request. Valid values are <code>query</code> or <code>fragment</code>. Default value is <code>fragment</code>, which means that after successful authentication will Keycloak redirect to JavaScript application with OpenID Connect parameters added in URL fragment. This is generally safer and recommended over <code>query</code>.</p>
</li>
<li>
<p>flow - Set the OpenID Connect flow. Valid values are <code>standard</code>, <code>implicit</code> or <code>hybrid</code>.</p>
</li>
<li>
<p>enableLogging - Enables logging messages from Keycloak to the console (default is <code>false</code>).</p>
</li>
<li>
<p>pkceMethod - The method for Proof Key Code Exchange (<a href="https://datatracker.ietf.org/doc/html/rfc7636">PKCE</a>) to use. Configuring this value enables the PKCE mechanism. Available options:</p>
<div class="ulist">
<ul>
<li>
<p>"S256" - The SHA256 based PKCE method (default)</p>
</li>
<li>
<p>false - PKCE is disabled.</p>
</li>
</ul>
</div>
</li>
<li>
<p>acrValues - Generates the <code>acr_values</code> parameter which refers to authentication context class reference and allows clients to declare the required assurance level requirements, e.g. authentication mechanisms. See <a href="https://openid.net/specs/openid-connect-modrna-authentication-1_0.html#acr_values">Section 4. acr_values request values and level of assurance in OpenID Connect MODRNA Authentication Profile 1.0</a>.</p>
</li>
<li>
<p>messageReceiveTimeout - Set a timeout in milliseconds for waiting for message responses from the Keycloak server. This is used, for example, when waiting for a message during 3rd party cookies check. The default value is 10000.</p>
</li>
<li>
<p>locale - When onLoad is 'login-required', sets the 'ui_locales' query param in compliance with <a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest">section 3.1.2.1 of the OIDC 1.0 specification</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Returns a promise that resolves when initialization completes.</p>
</div>
<div class="paragraph">
<p><strong>login(options)</strong></p>
</div>
<div class="paragraph">
<p>Redirects to login form.</p>
</div>
<div class="paragraph">
<p>Options is an optional Object, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>redirectUri - Specifies the uri to redirect to after login.</p>
</li>
<li>
<p>prompt - This parameter allows to slightly customize the login flow on the Keycloak server side.
For example, enforce displaying the login screen in case of value <code>login</code>. Or enforce displaying of consent screen for the value <code>consent</code> in case that client has <code>Consent Required</code>.
Finally it is possible use the value <code>none</code> to make sure that login screen is not displayed to the user, which is useful just to check SSO for the case when user was already
authenticated before (This is related to the <code>onLoad</code> check with value <code>check-sso</code> described above).</p>
</li>
<li>
<p>maxAge - Used just if user is already authenticated. Specifies maximum time since the authentication of user happened. If user is already authenticated for longer time than <code>maxAge</code>, the SSO is ignored and he will need to re-authenticate again.</p>
</li>
<li>
<p>loginHint - Used to pre-fill the username/email field on the login form.</p>
</li>
<li>
<p>scope - Override the scope configured in <code>init</code> with a different value for this specific login.</p>
</li>
<li>
<p>idpHint - Used to tell Keycloak to skip showing the login page and automatically redirect to the specified identity
provider instead. More info in the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_client_suggested_idp">Identity Provider documentation</a>.</p>
</li>
<li>
<p>acr - Contains the information about <code>acr</code> claim, which will be sent inside <code>claims</code> parameter to the Keycloak server. Typical usage
is for step-up authentication. Example of use <code>{ values: ["silver", "gold"], essential: true }</code>. See OpenID Connect specification
and <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_step-up-flow">Step-up authentication documentation</a> for more details.</p>
</li>
<li>
<p>acrValues - Generates the <code>acr_values</code> parameter which refers to authentication context class reference and allows clients to declare the required assurance level requirements, e.g. authentication mechanisms. See <a href="https://openid.net/specs/openid-connect-modrna-authentication-1_0.html#acr_values">Section 4. acr_values request values and level of assurance in OpenID Connect MODRNA Authentication Profile 1.0</a>.</p>
</li>
<li>
<p>action - If the value is <code>register</code>, the user is redirected to the registration page. See <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_registration-rc-client-flows">Registration requested by client section</a> for more details.
If the value is <code>UPDATE_PASSWORD</code> or another supported required action, the user will be redirected to the reset password page or the other required action page. However, if the user is not authenticated, the user will be sent to the login page and redirected after authentication.
See <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#con-aia_server_administration_guide">Application Initiated Action section</a> for more details.</p>
</li>
<li>
<p>locale - Sets the 'ui_locales' query param in compliance with <a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthRequest">section 3.1.2.1 of the OIDC 1.0 specification</a>.</p>
</li>
<li>
<p>cordovaOptions - Specifies the arguments that are passed to the Cordova in-app-browser (if applicable). Options <code>hidden</code> and <code>location</code> are not affected by these arguments. All available options are defined at <a href="https://cordova.apache.org/docs/en/latest/reference/cordova-plugin-inappbrowser/" class="bare">https://cordova.apache.org/docs/en/latest/reference/cordova-plugin-inappbrowser/</a>. Example of use: <code>{ zoom: "no", hardwareback: "yes" }</code>;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>createLoginUrl(options)</strong></p>
</div>
<div class="paragraph">
<p>Returns the URL to login form.</p>
</div>
<div class="paragraph">
<p>Options is an optional Object, which supports same options as the function <code>login</code> .</p>
</div>
<div class="paragraph">
<p><strong>logout(options)</strong></p>
</div>
<div class="paragraph">
<p>Redirects to logout.</p>
</div>
<div class="paragraph">
<p>Options is an Object, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>redirectUri - Specifies the uri to redirect to after logout.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>createLogoutUrl(options)</strong></p>
</div>
<div class="paragraph">
<p>Returns the URL to log out the user.</p>
</div>
<div class="paragraph">
<p>Options is an Object, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>redirectUri - Specifies the uri to redirect to after logout.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>register(options)</strong></p>
</div>
<div class="paragraph">
<p>Redirects to registration form. Shortcut for login with option action = 'register'</p>
</div>
<div class="paragraph">
<p>Options are same as for the login method but 'action' is set to 'register'</p>
</div>
<div class="paragraph">
<p><strong>createRegisterUrl(options)</strong></p>
</div>
<div class="paragraph">
<p>Returns the url to registration page. Shortcut for createLoginUrl with option action = 'register'</p>
</div>
<div class="paragraph">
<p>Options are same as for the createLoginUrl method but 'action' is set to 'register'</p>
</div>
<div class="paragraph">
<p><strong>accountManagement()</strong></p>
</div>
<div class="paragraph">
<p>Redirects to the Account Console.</p>
</div>
<div class="paragraph">
<p><strong>createAccountUrl(options)</strong></p>
</div>
<div class="paragraph">
<p>Returns the URL to the Account Console.</p>
</div>
<div class="paragraph">
<p>Options is an Object, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>redirectUri - Specifies the uri to redirect to when redirecting back to the application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>hasRealmRole(role)</strong></p>
</div>
<div class="paragraph">
<p>Returns true if the token has the given realm role.</p>
</div>
<div class="paragraph">
<p><strong>hasResourceRole(role, resource)</strong></p>
</div>
<div class="paragraph">
<p>Returns true if the token has the given role for the resource (resource is optional, if not specified clientId is used).</p>
</div>
<div class="paragraph">
<p><strong>loadUserProfile()</strong></p>
</div>
<div class="paragraph">
<p>Loads the users profile.</p>
</div>
<div class="paragraph">
<p>Returns a promise that resolves with the profile.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">try</span> {
    const profile = await keycloak.loadUserProfile();
    console.log(<span class="string"><span class="delimiter">'</span><span class="content">Retrieved user profile:</span><span class="delimiter">'</span></span>, profile);
} <span class="keyword">catch</span> (error) {
    console.error(<span class="string"><span class="delimiter">'</span><span class="content">Failed to load user profile:</span><span class="delimiter">'</span></span>, error);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>isTokenExpired(minValidity)</strong></p>
</div>
<div class="paragraph">
<p>Returns true if the token has less than minValidity seconds left before it expires (minValidity is optional, if not specified 0 is used).</p>
</div>
<div class="paragraph">
<p><strong>updateToken(minValidity)</strong></p>
</div>
<div class="paragraph">
<p>If the token expires within minValidity seconds (minValidity is optional, if not specified 5 is used) the token is refreshed.
If -1 is passed as the minValidity, the token will be forcibly refreshed.
If the session status iframe is enabled, the session status is also checked.</p>
</div>
<div class="paragraph">
<p>Returns a promise that resolves with a boolean indicating whether or not the token has been refreshed.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">try</span> {
    const refreshed = await keycloak.updateToken(<span class="integer">5</span>);
    console.log(refreshed ? <span class="string"><span class="delimiter">'</span><span class="content">Token was refreshed</span><span class="delimiter">'</span></span> : <span class="string"><span class="delimiter">'</span><span class="content">Token is still valid</span><span class="delimiter">'</span></span>);
} <span class="keyword">catch</span> (error) {
    console.error(<span class="string"><span class="delimiter">'</span><span class="content">Failed to refresh the token:</span><span class="delimiter">'</span></span>, error);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>clearToken()</strong></p>
</div>
<div class="paragraph">
<p>Clear authentication state, including tokens.
This can be useful if application has detected the session was expired, for example if updating token fails.</p>
</div>
<div class="paragraph">
<p>Invoking this results in onAuthLogout callback listener being invoked.</p>
</div>
</div>
<div class="sect4">
<h5 id="callback-events"><a class="anchor" href="#callback-events"></a>Callback Events</h5>
<div class="paragraph">
<p>The adapter supports setting callback listeners for certain events. Keep in mind that these have to be set before the call to the <code>init()</code> method.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.onAuthSuccess = () =&gt; console.log(<span class="string"><span class="delimiter">'</span><span class="content">Authenticated!</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The available events are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>onReady(authenticated)</strong> - Called when the adapter is initialized.</p>
</li>
<li>
<p><strong>onAuthSuccess</strong> - Called when a user is successfully authenticated.</p>
</li>
<li>
<p><strong>onAuthError</strong> - Called if there was an error during authentication.</p>
</li>
<li>
<p><strong>onAuthRefreshSuccess</strong> - Called when the token is refreshed.</p>
</li>
<li>
<p><strong>onAuthRefreshError</strong> - Called if there was an error while trying to refresh the token.</p>
</li>
<li>
<p><strong>onAuthLogout</strong> - Called if the user is logged out (will only be called if the session status iframe is enabled, or in Cordova mode).</p>
</li>
<li>
<p><strong>onTokenExpired</strong> - Called when the access token is expired. If a refresh token is available the token can be refreshed with updateToken, or in cases where it is not (that is, with implicit flow) you can redirect to the login screen to obtain a new access token.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nodejs_adapter"><a class="anchor" href="#_nodejs_adapter"></a>2.6. Keycloak Node.js adapter</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/nodejs-adapter.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/nodejs-adapter.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/nodejs-adapter.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak provides a Node.js adapter built on top of <a href="https://github.com/senchalabs/connect">Connect</a> to protect server-side JavaScript apps - the goal was to be flexible enough to integrate with frameworks like <a href="https://expressjs.com/">Express.js</a>.</p>
</div>
<div class="paragraph">
<p>The library can be downloaded directly from <a href="https://www.npmjs.com/package/keycloak-connect"> Keycloak organization</a> and the source is available at
<a href="https://github.com/keycloak/keycloak-nodejs-connect">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>To use the Node.js adapter, first you must create a client for your application in the Keycloak Admin Console. The adapter supports public, confidential, and bearer-only access type. Which one to choose depends on the use-case scenario.</p>
</div>
<div class="paragraph">
<p>Once the client is created, click <strong>Action</strong> at the top right and choose <strong>Download adapter config</strong>. For <strong>Format, choose *Keycloak OIDC JSON</strong> and click <strong>Download</strong>. The downloaded <code>keycloak.json</code> file is at the root folder of your project.</p>
</div>
<div class="sect3">
<h4 id="installation-2"><a class="anchor" href="#installation-2"></a>2.6.1. Installation</h4>
<div class="paragraph">
<p>Assuming you have already installed <a href="https://nodejs.org">Node.js</a>, create a folder for your application:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir myapp &amp;&amp; cd myapp</pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>npm init</code> command to create a <code>package.json</code> for your application. Now add the Keycloak connect adapter in the dependencies list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">    "dependencies": {
        "keycloak-connect": "25.0.5"
    }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="usage"><a class="anchor" href="#usage"></a>2.6.2. Usage</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Instantiate a Keycloak class</dt>
<dd>
<p>The <code>Keycloak</code> class provides a central point for configuration
and integration with your application.  The simplest creation
involves no arguments.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In the root directory of your project create a file called <code>server.js</code> and add the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    const session = require(<span class="string"><span class="delimiter">'</span><span class="content">express-session</span><span class="delimiter">'</span></span>);
    const Keycloak = require(<span class="string"><span class="delimiter">'</span><span class="content">keycloak-connect</span><span class="delimiter">'</span></span>);

    const memoryStore = <span class="keyword">new</span> session.MemoryStore();
    const keycloak = <span class="keyword">new</span> Keycloak({ <span class="key">store</span>: memoryStore });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install the <code>express-session</code> dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    npm install express-session</pre>
</div>
</div>
<div class="paragraph">
<p>To start the <code>server.js</code> script, add the following command in the 'scripts' section of the <code>package.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    "scripts": {
        "test": "echo \"Error: no test specified\" &amp;&amp; exit 1",
        "start": "node server.js"
    },</pre>
</div>
</div>
<div class="paragraph">
<p>Now we have the ability to run our server with following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    npm run start</pre>
</div>
</div>
<div class="paragraph">
<p>By default, this will locate a file named <code>keycloak.json</code> alongside
the main executable of your application, in our case on the root folder, to initialize Keycloak specific
settings such as public key, realm name, various URLs.</p>
</div>
<div class="paragraph">
<p>In that case a Keycloak deployment is necessary to access Keycloak admin console.</p>
</div>
<div class="paragraph">
<p>Please visit links on how to deploy a Keycloak admin console with
<a href="https://www.keycloak.org/getting-started/getting-started-podman">Podman</a> or <a href="https://www.keycloak.org/getting-started/getting-started-docker">Docker</a></p>
</div>
<div class="paragraph">
<p>Now we are ready to obtain the <code>keycloak.json</code> file by visiting the Keycloak Admin Console &#8594; clients (left sidebar) &#8594; choose your client &#8594; Installation &#8594; Format Option &#8594; Keycloak OIDC JSON &#8594; Download</p>
</div>
<div class="paragraph">
<p>Paste the downloaded file on the root folder of our project.</p>
</div>
<div class="paragraph">
<p>Instantiation with this method results in all the reasonable defaults
being used. As alternative, it&#8217;s also possible to provide a configuration
object, rather than the <code>keycloak.json</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    const kcConfig = {
        <span class="key">clientId</span>: <span class="string"><span class="delimiter">'</span><span class="content">myclient</span><span class="delimiter">'</span></span>,
        <span class="key">bearerOnly</span>: <span class="predefined-constant">true</span>,
        <span class="key">serverUrl</span>: <span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080</span><span class="delimiter">'</span></span>,
        <span class="key">realm</span>: <span class="string"><span class="delimiter">'</span><span class="content">myrealm</span><span class="delimiter">'</span></span>,
        <span class="key">realmPublicKey</span>: <span class="string"><span class="delimiter">'</span><span class="content">MIIBIjANB...</span><span class="delimiter">'</span></span>
    };

    const keycloak = <span class="keyword">new</span> Keycloak({ <span class="key">store</span>: memoryStore }, kcConfig);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Applications can also redirect users to their preferred identity provider by using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    const keycloak = <span class="keyword">new</span> Keycloak({ <span class="key">store</span>: memoryStore, <span class="key">idpHint</span>: myIdP }, kcConfig);</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Configuring a web session store</dt>
<dd>
<p>If you want to use web sessions to manage
server-side state for authentication, you need to initialize the
<code>Keycloak(&#8230;&#8203;)</code> with at least a <code>store</code> parameter, passing in the actual
session store that <code>express-session</code> is using.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    const session = require(<span class="string"><span class="delimiter">'</span><span class="content">express-session</span><span class="delimiter">'</span></span>);
    const memoryStore = <span class="keyword">new</span> session.MemoryStore();

    <span class="comment">// Configure session</span>
    app.use(
      session({
        <span class="key">secret</span>: <span class="string"><span class="delimiter">'</span><span class="content">mySecret</span><span class="delimiter">'</span></span>,
        <span class="key">resave</span>: <span class="predefined-constant">false</span>,
        <span class="key">saveUninitialized</span>: <span class="predefined-constant">true</span>,
        <span class="key">store</span>: memoryStore,
      })
    );

    const keycloak = <span class="keyword">new</span> Keycloak({ <span class="key">store</span>: memoryStore });</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Passing a custom scope value</dt>
<dd>
<p>By default, the scope value <code>openid</code> is passed as a query parameter to Keycloak&#8217;s login URL, but you can add an additional custom value:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    const keycloak = <span class="keyword">new</span> Keycloak({ <span class="key">scope</span>: <span class="string"><span class="delimiter">'</span><span class="content">offline_access</span><span class="delimiter">'</span></span> });</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="installing-middleware"><a class="anchor" href="#installing-middleware"></a>2.6.3. Installing middleware</h4>
<div class="paragraph">
<p>Once instantiated, install the middleware into your connect-capable app:</p>
</div>
<div class="paragraph">
<p>In order to do so, first we have to install Express:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    npm install express</pre>
</div>
</div>
<div class="paragraph">
<p>then require Express in our project as outlined below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    const express = require(<span class="string"><span class="delimiter">'</span><span class="content">express</span><span class="delimiter">'</span></span>);
    const app = express();</code></pre>
</div>
</div>
<div class="paragraph">
<p>and configure Keycloak middleware in Express, by adding at the code below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.use( keycloak.middleware() );</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last but not least, let&#8217;s set up our server to listen for HTTP requests on port 3000 by adding the following code to <code>main.js</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.listen(<span class="integer">3000</span>, <span class="keyword">function</span> () {
        console.log(<span class="string"><span class="delimiter">'</span><span class="content">App listening on port 3000</span><span class="delimiter">'</span></span>);
    });</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-for-proxies"><a class="anchor" href="#configuration-for-proxies"></a>2.6.4. Configuration for proxies</h4>
<div class="paragraph">
<p>If the application is running behind a proxy that terminates an SSL connection
Express must be configured per the <a href="https://expressjs.com/en/guide/behind-proxies.html">express behind proxies</a> guide.
Using an incorrect proxy configuration can result in invalid redirect URIs
being generated.</p>
</div>
<div class="paragraph">
<p>Example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    const app = express();

    app.set( <span class="string"><span class="delimiter">'</span><span class="content">trust proxy</span><span class="delimiter">'</span></span>, <span class="predefined-constant">true</span> );

    app.use( keycloak.middleware() );</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="protecting-resources"><a class="anchor" href="#protecting-resources"></a>2.6.5. Protecting resources</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Simple authentication</dt>
<dd>
<p>To enforce that a user must be authenticated before accessing a resource,
simply use a no-argument version of <code>keycloak.protect()</code>:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get( <span class="string"><span class="delimiter">'</span><span class="content">/complain</span><span class="delimiter">'</span></span>, keycloak.protect(), complaintHandler );</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Role-based authorization</dt>
<dd>
<p>To secure a resource with an application role for the current app:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get( <span class="string"><span class="delimiter">'</span><span class="content">/special</span><span class="delimiter">'</span></span>, keycloak.protect(<span class="string"><span class="delimiter">'</span><span class="content">special</span><span class="delimiter">'</span></span>), specialHandler );</code></pre>
</div>
</div>
<div class="paragraph">
<p>To secure a resource with an application role for a <strong>different</strong> app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get( <span class="string"><span class="delimiter">'</span><span class="content">/extra-special</span><span class="delimiter">'</span></span>, keycloak.protect(<span class="string"><span class="delimiter">'</span><span class="content">other-app:special</span><span class="delimiter">'</span></span>), extraSpecialHandler );</code></pre>
</div>
</div>
<div class="paragraph">
<p>To secure a resource with a realm role:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get( <span class="string"><span class="delimiter">'</span><span class="content">/admin</span><span class="delimiter">'</span></span>, keycloak.protect( <span class="string"><span class="delimiter">'</span><span class="content">realm:admin</span><span class="delimiter">'</span></span> ), adminHandler );</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Resource-Based Authorization</dt>
<dd>
<p>Resource-Based Authorization allows you to protect resources, and their specific methods/actions,<strong>*</strong>* based on a set of policies defined in Keycloak, thus externalizing authorization from your application. This is achieved by exposing a <code>keycloak.enforcer</code> method which you can use to protect resources.*</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get(<span class="string"><span class="delimiter">'</span><span class="content">/apis/me</span><span class="delimiter">'</span></span>, keycloak.enforcer(<span class="string"><span class="delimiter">'</span><span class="content">user:profile</span><span class="delimiter">'</span></span>), userProfileHandler);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>keycloak-enforcer</code> method operates in two modes, depending on the value of the <code>response_mode</code> configuration option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get(<span class="string"><span class="delimiter">'</span><span class="content">/apis/me</span><span class="delimiter">'</span></span>, keycloak.enforcer(<span class="string"><span class="delimiter">'</span><span class="content">user:profile</span><span class="delimiter">'</span></span>, {<span class="key">response_mode</span>: <span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span>}), userProfileHandler);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>response_mode</code> is set to <code>token</code>, permissions are obtained from the server on behalf of the subject represented by the bearer token that was sent to your application. In this case, a new access token is issued by Keycloak with the permissions granted by the server. If the server did not respond with a token with the expected permissions, the request is denied. When using this mode, you should be able to obtain the token from the request as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get(<span class="string"><span class="delimiter">'</span><span class="content">/apis/me</span><span class="delimiter">'</span></span>, keycloak.enforcer(<span class="string"><span class="delimiter">'</span><span class="content">user:profile</span><span class="delimiter">'</span></span>, {<span class="key">response_mode</span>: <span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span>}), <span class="keyword">function</span> (req, res) {
        const token = req.kauth.grant.access_token.content;
        const permissions = token.authorization ? token.authorization.permissions : <span class="predefined-constant">undefined</span>;

        <span class="comment">// show user profile</span>
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Prefer this mode when your application is using sessions and you want to cache previous decisions from the server, as well automatically handle refresh tokens. This mode is especially useful for applications acting as a client and resource server.</p>
</div>
<div class="paragraph">
<p>If <code>response_mode</code> is set to <code>permissions</code> (default mode), the server only returns the list of granted permissions, without issuing a new access token. In addition to not issuing a new token, this method exposes the permissions granted by the server through the <code>request</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get(<span class="string"><span class="delimiter">'</span><span class="content">/apis/me</span><span class="delimiter">'</span></span>, keycloak.enforcer(<span class="string"><span class="delimiter">'</span><span class="content">user:profile</span><span class="delimiter">'</span></span>, {<span class="key">response_mode</span>: <span class="string"><span class="delimiter">'</span><span class="content">permissions</span><span class="delimiter">'</span></span>}), <span class="keyword">function</span> (req, res) {
        const permissions = req.permissions;

        <span class="comment">// show user profile</span>
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Regardless of the <code>response_mode</code> in use, the <code>keycloak.enforcer</code> method will first try to check the permissions within the bearer token that was sent to your application. If the bearer token already carries the expected permissions, there is no need
to interact with the server to obtain a decision. This is specially useful when your clients are capable of obtaining access tokens from the server with the expected permissions before accessing a protected resource, so they can use some capabilities provided by Keycloak Authorization Services such as incremental authorization and avoid additional requests to the server when <code>keycloak.enforcer</code> is enforcing access to the resource.</p>
</div>
<div class="paragraph">
<p>By default, the policy enforcer will use the <code>client_id</code> defined to the application (for instance, via <code>keycloak.json</code>) to
 reference a client in Keycloak that supports Keycloak Authorization Services. In this case, the client can not be public given
 that it is actually a resource server.</p>
</div>
<div class="paragraph">
<p>If your application is acting as both a public client(frontend) and resource server(backend), you can use the following configuration to reference a different
client in Keycloak with the policies that you want to enforce:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">      keycloak.enforcer(<span class="string"><span class="delimiter">'</span><span class="content">user:profile</span><span class="delimiter">'</span></span>, {<span class="key">resource_server_id</span>: <span class="string"><span class="delimiter">'</span><span class="content">my-apiserver</span><span class="delimiter">'</span></span>})</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is recommended to use distinct clients in Keycloak to represent your frontend and backend.</p>
</div>
<div class="paragraph">
<p>If the application you are protecting is enabled with Keycloak authorization services and you have defined client credentials
 in <code>keycloak.json</code>, you can push additional claims to the server and make them available to your policies in order to make decisions.
For that, you can define a <code>claims</code> configuration option which expects a <code>function</code> that returns a JSON with the claims you want to push:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">      app.get(<span class="string"><span class="delimiter">'</span><span class="content">/protected/resource</span><span class="delimiter">'</span></span>, keycloak.enforcer([<span class="string"><span class="delimiter">'</span><span class="content">resource:view</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">resource:write</span><span class="delimiter">'</span></span>], {
          <span class="function">claims</span>: <span class="keyword">function</span>(request) {
            <span class="keyword">return</span> {
              <span class="key"><span class="delimiter">&quot;</span><span class="content">http.uri</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">/protected/resource</span><span class="delimiter">&quot;</span></span>],
              <span class="key"><span class="delimiter">&quot;</span><span class="content">user.agent</span><span class="delimiter">&quot;</span></span>: <span class="comment">// get user agent  from request</span>
            }
          }
        }), <span class="keyword">function</span> (req, res) {
          <span class="comment">// access granted</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details about how to configure Keycloak to protected your application resources, please take a look at the <a href="https://www.keycloak.org/docs/25.0.5/authorization_services/">Authorization Services Guide</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Advanced authorization</dt>
<dd>
<p>To secure resources based on parts of the URL itself, assuming a role exists
for each section:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    <span class="keyword">function</span> <span class="function">protectBySection</span>(token, request) {
      <span class="keyword">return</span> token.hasRole( request.params.section );
    }

    app.get( <span class="string"><span class="delimiter">'</span><span class="content">/:section/:page</span><span class="delimiter">'</span></span>, keycloak.protect( protectBySection ), sectionHandler );</code></pre>
</div>
</div>
<div class="paragraph">
<p>Advanced Login Configuration:</p>
</div>
<div class="paragraph">
<p>By default, all unauthorized requests will be redirected to the Keycloak login page unless your client is bearer-only.
However, a confidential or public client may host both browsable and API endpoints. To prevent redirects on unauthenticated
API requests and instead return an HTTP 401, you can override the redirectToLogin function.</p>
</div>
<div class="paragraph">
<p>For example, this override checks if the URL contains /api/ and disables login redirects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    Keycloak.prototype.<span class="function">redirectToLogin</span> = <span class="keyword">function</span>(req) {
    const apiReqMatcher = <span class="regexp"><span class="delimiter">/</span><span class="content">\/</span><span class="content">api</span><span class="content">\/</span><span class="delimiter">/</span><span class="modifier">i</span></span>;
    <span class="keyword">return</span> !apiReqMatcher.test(req.originalUrl || req.url);
    };</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="additional-urls"><a class="anchor" href="#additional-urls"></a>2.6.6. Additional URLs</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Explicit user-triggered logout</dt>
<dd>
<p>By default, the middleware catches calls to <code>/logout</code> to send the user through a
Keycloak-centric logout workflow. This can be changed by specifying a <code>logout</code>
configuration parameter to the <code>middleware()</code> call:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.use( keycloak.middleware( { <span class="key">logout</span>: <span class="string"><span class="delimiter">'</span><span class="content">/logoff</span><span class="delimiter">'</span></span> } ));</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the user-triggered logout is invoked a query parameter <code>redirect_url</code> can be passed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>https://example.com/logoff?redirect_url=https%3A%2F%2Fexample.com%3A3000%2Flogged%2Fout</code></pre>
</div>
</div>
<div class="paragraph">
<p>This parameter is then used as the redirect url of the OIDC logout endpoint and the user will be redirected to
<code>https://example.com/logged/out</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Keycloak Admin Callbacks</dt>
<dd>
<p>Also, the middleware supports callbacks from the Keycloak console to log out a single
session or all sessions.  By default, these type of admin callbacks occur relative
to the root URL of <code>/</code> but can be changed by providing an <code>admin</code> parameter
to the <code>middleware()</code> call:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.use( keycloak.middleware( { <span class="key">admin</span>: <span class="string"><span class="delimiter">'</span><span class="content">/callbacks</span><span class="delimiter">'</span></span> } );</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="complete-example"><a class="anchor" href="#complete-example"></a>2.6.7. Complete example</h4>
<div class="paragraph">
<p>A complete example using the Node.js adapter usage can be found in <a href="https://github.com/keycloak/keycloak-quickstarts/tree/latest/nodejs/resource-server">Keycloak quickstarts for Node.js</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mod_auth_openidc"><a class="anchor" href="#_mod_auth_openidc"></a>2.7. mod_auth_openidc Apache HTTPD Module</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/mod-auth-openidc.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/mod-auth-openidc.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/mod-auth-openidc.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Keycloak does not provide any official support to mod_auth_openidc. The instructions below are best-effort and may not be up-to-date.
We recommend that you stick to official mod_auth_openidc documentation for more details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/OpenIDC/mod_auth_openidc">mod_auth_openidc</a> is an Apache HTTP plugin for OpenID Connect. If your language/environment supports using Apache HTTPD
as a proxy, then you can use <em>mod_auth_openidc</em> to secure your web application with OpenID Connect.  Configuration of this module
is beyond the scope of this document.  Please see the <em>mod_auth_openidc</em> GitHub repo for more details on configuration.</p>
</div>
<div class="paragraph">
<p>To configure <em>mod_auth_openidc</em> you&#8217;ll need</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The client_id.</p>
</li>
<li>
<p>The client_secret.</p>
</li>
<li>
<p>The redirect_uri to your application.</p>
</li>
<li>
<p>The Keycloak openid-configuration url</p>
</li>
<li>
<p><em>mod_auth_openidc</em> specific Apache HTTPD module config.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An example configuration would look like the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>LoadModule auth_openidc_module modules/mod_auth_openidc.so

ServerName ${HOSTIP}

&lt;VirtualHost *:80&gt;

    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    #this is required by mod_auth_openidc
    OIDCCryptoPassphrase a-random-secret-used-by-apache-oidc-and-balancer

    OIDCProviderMetadataURL ${KC_ADDR}/realms/${KC_REALM}/.well-known/openid-configuration

    OIDCClientID ${CLIENT_ID}
    OIDCClientSecret ${CLIENT_SECRET}
    OIDCRedirectURI http://${HOSTIP}/${CLIENT_APP_NAME}/redirect_uri

    # maps the preferred_username claim to the REMOTE_USER environment variable
    OIDCRemoteUserClaim preferred_username

    &lt;Location /${CLIENT_APP_NAME}/&gt;
        AuthType openid-connect
        Require valid-user
    &lt;/Location&gt;
&lt;/VirtualHost&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Further information on how to configure mod_auth_openidc can be found on the <a href="https://github.com/OpenIDC/mod_auth_openidc">mod_auth_openidc</a>
project page.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fapi-support"><a class="anchor" href="#_fapi-support"></a>2.8. Financial-grade API (FAPI) Support</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/fapi-support.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/fapi-support.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/fapi-support.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak makes it easier for administrators to make sure that their clients are compliant with these specifications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://openid.net/specs/openid-financial-api-part-1-1_0.html">Financial-grade API Security Profile 1.0 - Part 1: Baseline</a></p>
</li>
<li>
<p><a href="https://openid.net/specs/openid-financial-api-part-2-1_0.html">Financial-grade API Security Profile 1.0 - Part 2: Advanced</a></p>
</li>
<li>
<p><a href="https://openid.net/specs/openid-financial-api-ciba-ID1.html">Financial-grade API: Client Initiated Backchannel Authentication Profile</a> (FAPI CIBA)</p>
</li>
<li>
<p><a href="https://openid.bitbucket.io/fapi/fapi-2_0-security-profile.html">FAPI 2.0 Security Profile (Draft)</a></p>
</li>
<li>
<p><a href="https://openid.bitbucket.io/fapi/fapi-2_0-message-signing.html">FAPI 2.0 Message Signing (Draft)</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This compliance means that the Keycloak server will verify the requirements
for the authorization server, which are mentioned in the specifications. Keycloak adapters do not have any specific support for the FAPI, hence the required validations on the client (application)
side may need to be still done manually or through some other third-party solutions.</p>
</div>
<div class="sect3">
<h4 id="fapi-client-profiles"><a class="anchor" href="#fapi-client-profiles"></a>2.8.1. FAPI client profiles</h4>
<div class="paragraph">
<p>To make sure that your clients are FAPI compliant, you can configure Client Policies in your realm as described in the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_client_policies">Server Administration Guide</a>
and link them to the global client profiles for FAPI support, which are automatically available in each realm. You can use either <code>fapi-1-baseline</code> or <code>fapi-1-advanced</code> profile based on which FAPI
profile you need your clients to conform with. You can use also profiles <code>fapi-2-security-profile</code> or <code>fapi-2-message-signing</code> for the compliance with FAPI 2 Draft specifications.</p>
</div>
<div class="paragraph">
<p>In case you want to use <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_oidc_clients">Pushed Authorization Request (PAR)</a>, it is recommended that your client use
both the <code>fapi-1-baseline</code> profile and <code>fapi-1-advanced</code> for PAR requests. Specifically, the <code>fapi-1-baseline</code> profile contains <code>pkce-enforcer</code> executor, which makes sure
that client use PKCE with secured S256 algorithm. This is not required for FAPI Advanced clients unless they use PAR requests.</p>
</div>
<div class="paragraph">
<p>In case you want to use <a href="#_backchannel_authentication_endpoint">CIBA</a> in a FAPI compliant way, make sure that your clients use both <code>fapi-1-advanced</code> and <code>fapi-ciba</code> client profiles.
There is a need to use the <code>fapi-1-advanced</code> profile, or other client profile containing the requested executors, as the <code>fapi-ciba</code> profile contains just CIBA-specific executors.
When enforcing the requirements of the FAPI CIBA specification, there is a need for more requirements, such as enforcement of confidential clients or certificate-bound access tokens.</p>
</div>
</div>
<div class="sect3">
<h4 id="open-finance-brasil-financial-grade-api-security-profile"><a class="anchor" href="#open-finance-brasil-financial-grade-api-security-profile"></a>2.8.2. Open Finance Brasil Financial-grade API Security Profile</h4>
<div class="paragraph">
<p>Keycloak is compliant with the <a href="https://openfinancebrasil.atlassian.net/wiki/spaces/OF/pages/245760001/EN+Open+Finance+Brasil+Financial-grade+API+Security+Profile+1.0+Implementers+Draft+3">Open Finance Brasil Financial-grade API Security Profile 1.0 Implementers Draft 3</a>.
This one is stricter in some requirements than the <a href="#_fapi-support">FAPI 1 Advanced</a> specification and hence it may be needed to configure <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_client_policies">Client Policies</a>
in the more strict way to enforce some of the requirements. Especially:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If your client does not use PAR, make sure that it uses encrypted OIDC request objects. This can be achieved by using a client profile with the <code>secure-request-object</code> executor configured with <code>Encryption Required</code> enabled.</p>
</li>
<li>
<p>Make sure that for JWS, the client uses the <code>PS256</code> algorithm. For JWE, the client should use the <code>RSA-OAEP</code> with <code>A256GCM</code>. This may need to be set in all the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_oidc_clients">Client Settings</a> where these algorithms are applicable.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="australia-consumer-data-right-cdr-security-profile"><a class="anchor" href="#australia-consumer-data-right-cdr-security-profile"></a>2.8.3. Australia Consumer Data Right (CDR) Security Profile</h4>
<div class="paragraph">
<p>Keycloak is compliant with the <a href="https://consumerdatastandardsaustralia.github.io/standards/#security-profile">Australia Consumer Data Right Security Profile</a>.</p>
</div>
<div class="paragraph">
<p>If you want to apply the Australia CDR security profile, you need to use <code>fapi-1-advanced</code> profile because the Australia CDR security profile is based on FAPI 1.0 Advanced security profile. If your client also applies PAR, make sure that client applies RFC 7637 Proof Key for Code Exchange (PKCE) because the Australia CDR security profile requires that you apply PKCE when applying PAR. This can be achieved by using a client profile with the <code>pkce-enforcer</code> executor.</p>
</div>
</div>
<div class="sect3">
<h4 id="tls-considerations"><a class="anchor" href="#tls-considerations"></a>2.8.4. TLS considerations</h4>
<div class="paragraph">
<p>As confidential information is being exchanged, all interactions shall be encrypted with TLS (HTTPS). Moreover, there are some requirements in the FAPI specification for
the cipher suites and TLS protocol versions used. To match these requirements, you can consider configure allowed ciphers. This configuration can be done by setting
the <code>https-protocols</code> and <code>https-cipher-suites</code> options. Keycloak uses <code>TLSv1.3</code> by default and hence it is possibly not needed to change the default settings. However it
may be needed to adjust ciphers if you need to fall back to lower TLS version for some reason. For more details, see <a href="https://www.keycloak.org/server/enabletls">Configuring TLS</a> guide.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_oauth21-support"><a class="anchor" href="#_oauth21-support"></a>2.9. OAuth 2.1 Support</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/oauth21-support.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/oauth21-support.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/oauth21-support.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak makes it easier for administrators to make sure that their clients are compliant with these specifications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-10">The OAuth 2.1 Authorization Framework - draft specification</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This compliance means that the Keycloak server will verify the requirements
for the authorization server, which are mentioned in the specifications. Keycloak adapters do not have any specific support for the OAuth 2.1, hence the required validations on the client (application)
side may need to be still done manually or through some other third-party solutions.</p>
</div>
<div class="sect3">
<h4 id="oauth-2-1-client-profiles"><a class="anchor" href="#oauth-2-1-client-profiles"></a>2.9.1. OAuth 2.1 client profiles</h4>
<div class="paragraph">
<p>To make sure that your clients are OAuth 2.1 compliant, you can configure Client Policies in your realm as described in the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_client_policies">Server Administration Guide</a>
and link them to the global client profiles for OAuth 2.1 support, which are automatically available in each realm. You can use either <code>oauth-2-1-for-confidential-client</code> profile for confidential clients or <code>oauth-2-1-for-public-client</code> profile for public clients.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
OAuth 2.1 specification is still a draft and it may change in the future. Hence the Keycloak built-in OAuth 2.1 client profiles can change as well.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When using OAuth 2.1 profile for public clients, it is recommended to use DPoP preview feature as described in the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_dpop-bound-tokens">Server Administration Guide</a> because DPoP binds an access token and a refresh token together with the public part of a client&#8217;s key pair. This binding prevents an attacker from using stolen tokens.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="recommendations"><a class="anchor" href="#recommendations"></a>2.10. Recommendations</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/oidc/recommendations.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/oidc/recommendations.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/oidc/recommendations.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>This section describes some recommendations when securing your applications with Keycloak.</p>
</div>
<div class="sect3">
<h4 id="validating-access-tokens"><a class="anchor" href="#validating-access-tokens"></a>2.10.1. Validating access tokens</h4>
<div class="paragraph">
<p>If you need to manually validate access tokens issued by Keycloak, you can invoke the <a href="#_token_introspection_endpoint">Introspection Endpoint</a>.
The downside to this approach is that you have to make a network invocation to the Keycloak server.  This can be slow and possibly overload the
server if you have too many validation requests going on at the same time.  Keycloak issued access tokens are <a href="https://datatracker.ietf.org/doc/html/rfc7519">JSON Web Tokens (JWT)</a> digitally signed and encoded using <a href="https://datatracker.ietf.org/doc/html/rfc7515">JSON Web Signature (JWS)</a>.
Because they are encoded in this way, you can locally validate access tokens using the public key of the issuing realm.  You can either hard code the
realm&#8217;s public key in your validation code, or lookup and cache the public key using the <a href="#_certificate_endpoint">certificate endpoint</a> with the Key ID (KID) embedded within the
JWS.  Depending on what language you code in, many third party libraries exist and they can help you with JWS validation.</p>
</div>
</div>
<div class="sect3">
<h4 id="redirect-uris"><a class="anchor" href="#redirect-uris"></a>2.10.2. Redirect URIs</h4>
<div class="paragraph">
<p>When using the redirect based flows, be sure to use valid redirect uris for your clients. The redirect uris should be as specific as possible. This
especially applies to client-side (public clients) applications. Failing to do so could result in:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open redirects - this can allow attackers to create spoof links that looks like they are coming from your domain</p>
</li>
<li>
<p>Unauthorized entry - when users are already authenticated with Keycloak, an attacker can use a public client where redirect uris have not be configured correctly to gain access by redirecting the user without the users knowledge</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In production for web applications always use <code>https</code> for all redirect URIs. Do not allow redirects to http.</p>
</div>
<div class="paragraph">
<p>A few special redirect URIs also exist:</p>
</div>
<div id="_installed_applications_url" class="dlist">
<dl>
<dt class="hdlist1"><code>http://127.0.0.1</code></dt>
<dd>
<p>This redirect URI is useful for native applications and allows the native application to create a web server on a random port that can be used to obtain the
authorization code. This redirect uri allows any port. Note that per <a href="https://datatracker.ietf.org/doc/html/rfc8252#section-8.3">OAuth 2.0 for Native Apps</a>, the use of
<code>localhost</code> is <strong>not</strong> recommended and the IP literal <code>127.0.0.1</code> should be used instead.</p>
</dd>
</dl>
</div>
<div id="_installed_applications_urn" class="dlist">
<dl>
<dt class="hdlist1"><code>urn:ietf:wg:oauth:2.0:oob</code></dt>
<dd>
<p>If you cannot start a web server in the client (or a browser is not available), you can use the special <code>urn:ietf:wg:oauth:2.0:oob</code> redirect uri.
When this redirect uri is used, Keycloak displays a page with the code in the title and in a box on the page.
The application can either detect that the browser title has changed, or the user can copy and paste the code manually to the application.
With this redirect uri, a user can use a different device to obtain a code to paste back to the application.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_saml"><a class="anchor" href="#_saml"></a>3. Using SAML to secure applications and services</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/saml-overview.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/saml-overview.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/saml-overview.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>This section describes how you can secure applications and services with SAML using either Keycloak client adapters or generic SAML provider libraries.</p>
</div>
<div class="sect2">
<h3 id="keycloak-java-adapters-2"><a class="anchor" href="#keycloak-java-adapters-2"></a>3.1. Keycloak Java adapters</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/java-adapters.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/java-adapters.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/java-adapters.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak comes with a range of different adapters for Java application. Selecting the correct adapter depends on the target platform.</p>
</div>
<div class="sect3">
<h4 id="_saml-general-config"><a class="anchor" href="#_saml-general-config"></a>3.1.1. General Adapter Config</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Each SAML client adapter supported by Keycloak can be configured by a simple XML text file.
This is what one might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;keycloak-saml-adapter</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:keycloak:saml:adapter</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:keycloak:saml:adapter https://www.keycloak.org/schema/keycloak_saml_adapter_1_10.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;SP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8081/sales-post-sig/</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">sslPolicy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EXTERNAL</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">nameIDPolicyFormat</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">logoutPage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/logout.jsp</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">forceAuthentication</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">isPassive</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">turnOffChangeSessionIdOnLogin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">autodetectBearerOnly</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;Keys&gt;</span>
            <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
                <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;PrivateKey</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/sales-post-sig/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">test123</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/sales-post-sig/</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/KeyStore&gt;</span>
            <span class="tag">&lt;/Key&gt;</span>
        <span class="tag">&lt;/Keys&gt;</span>
        <span class="tag">&lt;PrincipalNameMapping</span> <span class="attribute-name">policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_NAME_ID</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;RoleIdentifiers&gt;</span>
            <span class="tag">&lt;Attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Role</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/RoleIdentifiers&gt;</span>
        <span class="tag">&lt;RoleMappingsProvider</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties-based-role-mapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties.resource.location</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/role-mappings.properties</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/RoleMappingsProvider&gt;</span>
        <span class="tag">&lt;IDP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">signaturesRequired</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;SingleSignOnService</span> <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">bindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8081/realms/demo/protocol/saml</span><span class="delimiter">&quot;</span></span>
                    <span class="tag">/&gt;</span>

            <span class="tag">&lt;SingleLogoutService</span>
                    <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">responseBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">postBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8081/realms/demo/protocol/saml</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">redirectBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8081/realms/demo/protocol/saml</span><span class="delimiter">&quot;</span></span>
                    <span class="tag">/&gt;</span>
            <span class="tag">&lt;Keys&gt;</span>
                <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                        <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;/KeyStore&gt;</span>
                <span class="tag">&lt;/Key&gt;</span>
            <span class="tag">&lt;/Keys&gt;</span>
        <span class="tag">&lt;/IDP&gt;</span>
     <span class="tag">&lt;/SP&gt;</span>
<span class="tag">&lt;/keycloak-saml-adapter&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some of these configuration switches may be adapter specific and some are common across all adapters.
For Java adapters you can use <code>${&#8230;&#8203;}</code> enclosure as System property replacement.
For example <code>${jboss.server.config.dir}</code>.</p>
</div>
<div class="sect4">
<h5 id="sp-element"><a class="anchor" href="#sp-element"></a>SP element</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/sp_element.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/sp_element.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/sp_element.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Here is the explanation of the SP element attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sp</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">sslPolicy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ssl</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">nameIDPolicyFormat</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">format</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">forceAuthentication</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">isPassive</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">keepDOMAssertion</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">autodetectBearerOnly</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...
<span class="tag">&lt;/SP&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">entityID</dt>
<dd>
<p>This is the identifier for this client.
The IdP needs this value to determine who the client is that is communicating with it. This setting is <em>REQUIRED</em>.</p>
</dd>
<dt class="hdlist1">sslPolicy</dt>
<dd>
<p>This is the SSL policy the adapter will enforce.
Valid values are: <code>ALL</code>, <code>EXTERNAL</code>, and <code>NONE</code>.
For <code>ALL</code>, all requests must come in via HTTPS.
For <code>EXTERNAL</code>, only non-private IP addresses must come over the wire via HTTPS.
For <code>NONE</code>, no requests are required to come over via HTTPS.
This setting is <em>OPTIONAL</em>. Default value is <code>EXTERNAL</code>.</p>
</dd>
<dt class="hdlist1">nameIDPolicyFormat</dt>
<dd>
<p>SAML clients can request a specific NameID Subject format.
Fill in this value if you want a specific format.
It must be a standard SAML format identifier: <code>urn:oasis:names:tc:SAML:2.0:nameid-format:transient</code>.
This setting is <em>OPTIONAL</em>.
By default, no special format is requested.</p>
</dd>
<dt class="hdlist1">forceAuthentication</dt>
<dd>
<p>SAML clients can request that a user is re-authenticated even if they are already logged in at the IdP.
Set this to <code>true</code> to enable. This setting is <em>OPTIONAL</em>.
Default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">isPassive</dt>
<dd>
<p>SAML clients can request that a user is never asked to authenticate even if they are not logged in at the IdP.
Set this to <code>true</code> if you want this.
Do not use together with <code>forceAuthentication</code> as they are opposite. This setting is <em>OPTIONAL</em>.
Default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">turnOffChangeSessionIdOnLogin</dt>
<dd>
<p>The session ID is changed by default on a successful login on some platforms to plug a security attack vector.
Change this to <code>true</code> to disable this.  It is recommended you do not turn it off.
Default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">autodetectBearerOnly</dt>
<dd>
<p>This should be set to <em>true</em> if your application serves both a web application and web services (for example SOAP or REST).
It allows you to redirect unauthenticated users of the web application to the Keycloak login page,
but send an HTTP <code>401</code> status code to unauthenticated SOAP or REST clients instead as they would not understand a redirect to the login page.
Keycloak auto-detects SOAP or REST clients based on typical headers like <code>X-Requested-With</code>, <code>SOAPAction</code> or <code>Accept</code>.
The default value is <em>false</em>.</p>
</dd>
<dt class="hdlist1">logoutPage</dt>
<dd>
<p>This sets the page to display after logout. If the page is a full URL, such as <code><a href="http://web.example.com/logout.html" class="bare">http://web.example.com/logout.html</a></code>,
the user is redirected after logout to that page using the HTTP <code>302</code> status code. If a link without scheme part is specified,
such as <code>/logout.jsp</code>, the page is displayed after logout, <em>regardless of whether it lies in a protected area according
to <code>security-constraint</code> declarations in web.xml</em>, and the page is resolved relative to the deployment context root.</p>
</dd>
<dt class="hdlist1">keepDOMAssertion</dt>
<dd>
<p>This attribute should be set to <em>true</em> to make the adapter store the DOM representation of the assertion in its
original form inside the <code>SamlPrincipal</code> associated to the request. The assertion document can be retrieved using
the method <code>getAssertionDocument</code> inside the principal. This is specially useful when re-playing a signed assertion.
The returned document is the one that was generated parsing the SAML response received by the Keycloak server.
This setting is <em>OPTIONAL</em> and its default value is <em>false</em> (the document is not saved inside the principal).</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_saml-sp-keys"><a class="anchor" href="#_saml-sp-keys"></a>Service Provider keys and key elements</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/sp-keys.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/sp-keys.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/sp-keys.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>If the IdP requires that the client application (or SP) sign all of its requests and/or if the IdP will encrypt assertions, you must define the keys used to do this.
For client-signed documents you must define both the private and public key or certificate that is used to sign documents.
For encryption, you only have to define the private key that is used to decrypt it.</p>
</div>
<div class="paragraph">
<p>There are two ways to describe your keys.
They can be stored within a Java KeyStore or you can copy/paste the keys directly within <code>keycloak-saml.xml</code> in the PEM format.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">        <span class="tag">&lt;Keys&gt;</span>
            <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
               ...
            <span class="tag">&lt;/Key&gt;</span>
        <span class="tag">&lt;/Keys&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Key</code> element has two optional attributes <code>signing</code> and <code>encryption</code>.
When set to true these tell the adapter what the key will be used for.
If both attributes are set to true, then the key will be used for both signing documents and decrypting encrypted assertions.
You must set at least one of these attributes to true.</p>
</div>
<div class="sect5">
<h6 id="_saml-keystore"><a class="anchor" href="#_saml-keystore"></a>KeyStore element</h6>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/sp-keys/keystore_element.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/sp-keys/keystore_element.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/sp-keys/keystore_element.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Within the <code>Key</code> element you can load your keys and certificates from a Java Keystore.  This is declared within
a <code>KeyStore</code> element.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">        <span class="tag">&lt;Keys&gt;</span>
            <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
                <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;PrivateKey</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myPrivate</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">test123</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCertAlias</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/KeyStore&gt;</span>
            <span class="tag">&lt;/Key&gt;</span>
        <span class="tag">&lt;/Keys&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the XML config attributes that are defined with the <code>KeyStore</code> element.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">file</dt>
<dd>
<p>File path to the key store. This option is <em>OPTIONAL</em>.  The file or resource attribute must be set.</p>
</dd>
<dt class="hdlist1">resource</dt>
<dd>
<p>WAR resource path to the KeyStore.
This is a path used in method call to ServletContext.getResourceAsStream(). This option is <em>OPTIONAL</em>.  The file or resource attribute must be set.</p>
</dd>
<dt class="hdlist1">password</dt>
<dd>
<p>The password of the KeyStore. This option is <em>REQUIRED</em>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If you are defining keys that the SP will use to sign document, you must also specify references to your private keys
and certificates within the Java KeyStore.
The <code>PrivateKey</code> and <code>Certificate</code> elements in the above example define an <code>alias</code> that points to the key or cert
within the keystore.  Keystores require an additional password to access private keys.
In the <code>PrivateKey</code> element you must define this password within a <code>password</code> attribute.</p>
</div>
</div>
<div class="sect5">
<h6 id="key-pems"><a class="anchor" href="#key-pems"></a>Key PEMS</h6>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/sp-keys/key_pems.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/sp-keys/key_pems.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/sp-keys/key_pems.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Within the <code>Key</code> element you declare your keys and certificates directly using the sub elements
<code>PrivateKeyPem</code>, <code>PublicKeyPem</code>, and <code>CertificatePem</code>.
The values contained in these elements must conform to the PEM key format.
You usually use this option if you are generating keys using <code>openssl</code> or similar command line tool.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Keys&gt;</span>
   <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;PrivateKeyPem&gt;</span>
         2341251234AB31234==231BB998311222423522334
      <span class="tag">&lt;/PrivateKeyPem&gt;</span>
      <span class="tag">&lt;CertificatePem&gt;</span>
         211111341251234AB31234==231BB998311222423522334
      <span class="tag">&lt;/CertificatePem&gt;</span>
   <span class="tag">&lt;/Key&gt;</span>
<span class="tag">&lt;/Keys&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sp-principalnamemapping-element"><a class="anchor" href="#sp-principalnamemapping-element"></a>SP PrincipalNameMapping element</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/sp_principalname_mapping_element.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/sp_principalname_mapping_element.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/sp_principalname_mapping_element.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>This element is optional.
When creating a Java Principal object that you obtain from methods such as <code>HttpServletRequest.getUserPrincipal()</code>, you can define what name is returned by the <code>Principal.getName()</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SP</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
  <span class="tag">&lt;PrincipalNameMapping</span> <span class="attribute-name">policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_NAME_ID</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/SP&gt;</span>

<span class="tag">&lt;SP</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
  <span class="tag">&lt;PrincipalNameMapping</span> <span class="attribute-name">policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_ATTRIBUTE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">attribute</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/SP&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>policy</code> attribute defines the policy used to populate this value.
The possible values for this attribute are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">FROM_NAME_ID</dt>
<dd>
<p>This policy just uses whatever the SAML subject value is.  This is the default setting</p>
</dd>
<dt class="hdlist1">FROM_ATTRIBUTE</dt>
<dd>
<p>This will pull the value from one of the attributes declared in the SAML assertion received from the server.
You&#8217;ll need to specify the name of the SAML assertion attribute to use within the <code>attribute</code> XML attribute.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="roleidentifiers-element"><a class="anchor" href="#roleidentifiers-element"></a>RoleIdentifiers element</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/roleidentifiers_element.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/roleidentifiers_element.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/roleidentifiers_element.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The <code>RoleIdentifiers</code> element defines what SAML attributes within the assertion received from the user should be used
as role identifiers within the Jakarta EE Security Context for the user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;RoleIdentifiers&gt;</span>
     <span class="tag">&lt;Attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Role</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;Attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">member</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;Attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/RoleIdentifiers&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default <code>Role</code> attribute values are converted to Jakarta EE roles.
Some IdPs send roles using a <code>member</code> or <code>memberOf</code> attribute assertion.
You can define one or more <code>Attribute</code> elements to specify which SAML attributes must be converted into roles.</p>
</div>
</div>
<div class="sect4">
<h5 id="rolemappingsprovider-element"><a class="anchor" href="#rolemappingsprovider-element"></a>RoleMappingsProvider element</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/sp_role_mappings_provider_element.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/sp_role_mappings_provider_element.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/sp_role_mappings_provider_element.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The <code>RoleMappingsProvider</code> is an optional element that allows for the specification of the id and configuration of the
<code>org.keycloak.adapters.saml.RoleMappingsProvider</code> SPI implementation that is to be used by the SAML adapter.</p>
</div>
<div class="paragraph">
<p>When Keycloak is used as the IDP, it is possible to use the built-in role mappers to map any roles before adding them to the
SAML assertion. However, the SAML adapters can be used to send SAML requests to third party IDPs and in this case it might be
necessary to map the roles extracted from the assertion into a different set of roles as required by the SP. The
<code>RoleMappingsProvider</code> SPI allows for the configuration of pluggable role mappers that can be used to perform the necessary
mappings.</p>
</div>
<div class="paragraph">
<p>The configuration of the provider looks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">...
<span class="tag">&lt;RoleIdentifiers&gt;</span>
    ...
<span class="tag">&lt;/RoleIdentifiers&gt;</span>
<span class="tag">&lt;RoleMappingsProvider</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties-based-role-mapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties.resource.location</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/role-mappings.properties</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/RoleMappingsProvider&gt;</span>
<span class="tag">&lt;IDP&gt;</span>
    ...
<span class="tag">&lt;/IDP&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>id</code> attribute identifies which of the installed providers is to be used. The <code>Property</code> sub-element can be used multiple times
to specify configuration properties for the provider.</p>
</div>
<div class="sect5">
<h6 id="properties-based-role-mappings-provider"><a class="anchor" href="#properties-based-role-mappings-provider"></a>Properties Based role mappings provider</h6>
<div class="paragraph">
<p>Keycloak includes a <code>RoleMappingsProvider</code> implementation that performs the role mappings using a <code>properties</code> file. This
provider is identified by the id <code>properties-based-role-mapper</code> and is implemented by the <code>org.keycloak.adapters.saml.PropertiesBasedRoleMapper</code>
class.</p>
</div>
<div class="paragraph">
<p>This provider relies on two configuration properties that can be used to specify the location of the <code>properties</code> file
that will be used. First, it checks if the <code>properties.file.location</code> property has been specified, using the configured
value to locate the <code>properties</code> file in the filesystem. If the configured file is not located, the provider throws a
<code>RuntimeException</code>. The following snippet shows an example of provider using the <code>properties.file.configuration</code>
option to load the <code>roles.properties</code> file from the <code>/opt/mappers/</code> directory in the filesystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;RoleMappingsProvider</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties-based-role-mapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties.file.location</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/opt/mappers/roles.properties</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/RoleMappingsProvider&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>properties.file.location</code> configuration has not been set, the provider checks the <code>properties.resource.location</code>
property, using the configured value to load the <code>properties</code> file from the <code>WAR</code> resource. If this configuration property is
also not present, the provider attempts to load the file from <code>/WEB-INF/role-mappings.properties</code> by default. Failure to load the file
from the resource will result in the provider throwing a <code>RuntimeException</code>. The following snippet shows an example of provider
using the <code>properties.resource.location</code> to load the <code>roles.properties</code> file from the application&#8217;s <code>/WEB-INF/conf/</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;RoleMappingsProvider</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties-based-role-mapper</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties.resource.location</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/conf/roles.properties</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/RoleMappingsProvider&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>properties</code> file can contain both roles and principals as keys, and a list of zero or more roles separated by comma
as values. When invoked, the implementation iterates through the set of roles that were extracted from the assertion and checks,
for each role, if a mapping exists. If the role maps to an empty role, it is discarded. If it maps to a set of one or more
different roles, then these roles are set in the result set. If no mapping is found for the role then it is included as is
in the result set.</p>
</div>
<div class="paragraph">
<p>Once the roles have been processed, the implementation checks if the principal extracted from the assertion contains an entry
<code>properties</code> file. If a mapping for the principal exists, any roles listed as value are added to the result set. This
allows the assignment of extra roles to a principal.</p>
</div>
<div class="paragraph">
<p>As an example, let&#8217;s assume the provider has been configured with the following properties file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>roleA=roleX,roleY
roleB=

kc_user=roleZ</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the principal <code>kc_user</code> is extracted from the assertion with roles <code>roleA</code>, <code>roleB</code> and <code>roleC</code>, the final set of roles
assigned to the principal will be <code>roleC</code>, <code>roleX</code>, <code>roleY</code> and <code>roleZ</code> because <code>roleA</code> is being mapped into both <code>roleX</code>
and <code>roleY</code>, <code>roleB</code> was mapped into an empty role - thus being discarded, <code>roleC</code> is used as is and finally an additional role
was added to the <code>kc_user</code> principal (<code>roleZ</code>).</p>
</div>
<div class="paragraph">
<p>Note: to use spaces in role names for mappings, use unicode replacements for space. For example, incoming 'role A' would appear as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>role\u0020A=roleX,roleY</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="adding-your-own-role-mappings-provider"><a class="anchor" href="#adding-your-own-role-mappings-provider"></a>Adding your own role mappings provider</h6>
<div class="paragraph">
<p>To add a custom role mappings provider one simply needs to implement the <code>org.keycloak.adapters.saml.RoleMappingsProvider</code> SPI.
For more details see the <code>SAML Role Mappings SPI</code> section in <a href="https://www.keycloak.org/docs/25.0.5/server_development/">Server Developer Guide</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="idp-element"><a class="anchor" href="#idp-element"></a>IDP Element</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/idp_element.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/idp_element.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/idp_element.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Everything in the IDP element describes the settings for the identity provider (authentication server) the SP is communicating with.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;IDP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">signaturesRequired</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">signatureAlgorithm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RSA_SHA1</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">signatureCanonicalizationMethod</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/10/xml-exc-c14n#</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...
<span class="tag">&lt;/IDP&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the attribute config options you can specify within the <code>IDP</code> element declaration.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">entityID</dt>
<dd>
<p>This is the issuer ID of the IDP. This setting is <em>REQUIRED</em>.</p>
</dd>
<dt class="hdlist1">signaturesRequired</dt>
<dd>
<p>If set to <code>true</code>, the client adapter will sign every document it sends to the IDP.
Also, the client will expect that the IDP will be signing any documents sent to it.
This switch sets the default for all request and response types, but you will see later that you have some fine grain control over this.
This setting is <em>OPTIONAL</em> and will default to <code>false</code>.</p>
</dd>
<dt class="hdlist1">signatureAlgorithm</dt>
<dd>
<p> This is the signature algorithm that the IDP expects signed documents to use.
 Allowed values are: <code>RSA_SHA1</code>, <code>RSA_SHA256</code>, <code>RSA_SHA512</code>, and <code>DSA_SHA1</code>.
 This setting is <em>OPTIONAL</em>
 and defaults to <code>RSA_SHA256</code>. Note that <code>SHA1</code> based algorithms are deprecated and can be removed in the future.
We recommend the use of some more secure algorithm instead of <code>*_SHA1</code>. Also, with <code>*_SHA1</code> algorithms, verifying signatures
 do not work if the SAML server (usually Keycloak) runs on Java 17 or higher.</p>
</dd>
<dt class="hdlist1">signatureCanonicalizationMethod</dt>
<dd>
<p>This is the signature canonicalization method that the IDP expects signed documents to use.  This setting is  <em>OPTIONAL</em>.
The default value is <code>http://www.w3.org/2001/10/xml-exc-c14n#</code> and should be good for most IDPs.</p>
</dd>
<dt class="hdlist1">metadataUrl</dt>
<dd>
<p>The URL used to retrieve the IDP metadata, currently this is only used to pick up signing and encryption keys periodically which allow cycling of these keys on the IDP without manual changes on the SP side.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_sp-idp-allowedclockskew"><a class="anchor" href="#_sp-idp-allowedclockskew"></a>IDP AllowedClockSkew sub element</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/idp_allowedclockskew_subelement.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/idp_allowedclockskew_subelement.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/idp_allowedclockskew_subelement.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The <code>AllowedClockSkew</code> optional sub element defines the allowed clock skew between IDP and SP.
The default value is 0.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;AllowedClockSkew</span> <span class="attribute-name">unit</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MILLISECONDS</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>3500<span class="tag">&lt;/AllowedClockSkew&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">unit</dt>
<dd>
<p>It is possible to define the time unit attached to the value for this element.
Allowed values are MICROSECONDS, MILLISECONDS, MINUTES, NANOSECONDS and SECONDS.
This is <em>OPTIONAL</em>.
The default value is <code>SECONDS</code>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_sp-idp-singlesignonservice"><a class="anchor" href="#_sp-idp-singlesignonservice"></a>IDP SingleSignOnService sub element</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/idp_singlesignonservice_subelement.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/idp_singlesignonservice_subelement.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/idp_singlesignonservice_subelement.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The <code>SingleSignOnService</code> sub element defines the login SAML endpoint of the IDP.
The client adapter will send requests
to the IDP formatted via the settings within this element when it wants to log in.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SingleSignOnService</span> <span class="attribute-name">signRequest</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">validateResponseSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">post</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">bindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the config attributes you can define on this element:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">signRequest</dt>
<dd>
<p>Should the client sign authn requests? This setting is <em>OPTIONAL</em>.
Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">validateResponseSignature</dt>
<dd>
<p>Should the client expect the IDP to sign the assertion response document sent back from an authn request?
This setting <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">requestBinding</dt>
<dd>
<p>This is the SAML binding type used for communicating with the IDP.  This setting is <em>OPTIONAL</em>.
The default value is <code>POST</code>, but you can set it to <code>REDIRECT</code> as well.</p>
</dd>
<dt class="hdlist1">responseBinding</dt>
<dd>
<p>SAML allows the client to request what binding type it wants authn responses to use.
The values of this can be <code>POST</code> or <code>REDIRECT</code>.  This setting is <em>OPTIONAL</em>.
The default is that the client will not request a specific binding type for responses.</p>
</dd>
<dt class="hdlist1">assertionConsumerServiceUrl</dt>
<dd>
<p>URL of the assertion consumer service (ACS) where the IDP login service should send responses to.
This setting is <em>OPTIONAL</em>. By default it is unset, relying on the configuration in the IdP.
When set, it must end in <code>/saml</code>, for example <code>http://sp.domain.com/my/endpoint/for/saml</code>. The value
of this property is sent in <code>AssertionConsumerServiceURL</code> attribute of SAML <code>AuthnRequest</code> message.
This property is typically  accompanied by the <code>responseBinding</code> attribute.</p>
</dd>
<dt class="hdlist1">bindingUrl</dt>
<dd>
<p>This is the URL for the IDP login service that the client will send requests to. This setting is <em>REQUIRED</em>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="idp-singlelogoutservice-sub-element"><a class="anchor" href="#idp-singlelogoutservice-sub-element"></a>IDP SingleLogoutService sub element</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/idp_singlelogoutservice_subelement.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/idp_singlelogoutservice_subelement.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/idp_singlelogoutservice_subelement.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The <code>SingleLogoutService</code> sub element defines the logout SAML endpoint of the IDP.   The client adapter will send requests
to the IDP formatted via the settings within this element when it wants to log out.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SingleLogoutService</span> <span class="attribute-name">validateRequestSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">validateResponseSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">signRequest</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">signResponse</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">redirect</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">responseBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">post</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">postBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">posturl</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">redirectBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">redirecturl</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">signRequest</dt>
<dd>
<p>Should the client sign logout requests it makes to the IDP? This setting is <em>OPTIONAL</em>.
Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">signResponse</dt>
<dd>
<p>Should the client sign logout responses it sends to the IDP requests? This setting is <em>OPTIONAL</em>.
Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">validateRequestSignature</dt>
<dd>
<p>Should the client expect signed logout request documents from the IDP? This setting is <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">validateResponseSignature</dt>
<dd>
<p>Should the client expect signed logout response documents from the IDP? This setting is <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">requestBinding</dt>
<dd>
<p>This is the SAML binding type used for communicating SAML requests to the IDP. This setting is <em>OPTIONAL</em>.
The default value is <code>POST</code>, but you can set it to REDIRECT as well.</p>
</dd>
<dt class="hdlist1">responseBinding</dt>
<dd>
<p>This is the SAML binding type used for communicating SAML responses to the IDP. The values of this can be <code>POST</code> or <code>REDIRECT</code>.  This setting is <em>OPTIONAL</em>.
The default value is <code>POST</code>, but you can set it to <code>REDIRECT</code> as well.</p>
</dd>
<dt class="hdlist1">postBindingUrl</dt>
<dd>
<p>This is the URL for the IDP&#8217;s logout service when using the POST binding. This setting is <em>REQUIRED</em> if using the <code>POST</code> binding.</p>
</dd>
<dt class="hdlist1">redirectBindingUrl</dt>
<dd>
<p>This is the URL for the IDP&#8217;s logout service when using the REDIRECT binding. This setting is <em>REQUIRED</em> if using the REDIRECT binding.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_sp-idp-keys"><a class="anchor" href="#_sp-idp-keys"></a>IDP Keys sub element</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/idp_keys_subelement.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/idp_keys_subelement.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/idp_keys_subelement.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The Keys sub element of IDP is only used to define the certificate or public key to use to verify documents signed by the IDP.
It is defined in the same way as the <a href="#_saml-sp-keys">SP&#8217;s Keys element</a>.
But again, you only have to define one certificate or public key reference. Note that, if both IDP and SP are realized by
Keycloak server and adapter, respectively, there is no need to specify the keys for signature validation, see below.</p>
</div>
<div id="_sp-idp-keys-automatic" class="paragraph">
<p>It is possible to configure SP to obtain public keys for IDP signature validation
from published certificates automatically, provided both SP and IDP are
implemented by Keycloak.
This is done by removing all declarations of signature validation keys in Keys
sub element. If the Keys sub element would then remain empty, it can be omitted
completely. The keys are then automatically obtained by SP from SAML descriptor,
location of which is derived from SAML endpoint URL specified in the
<a href="#_sp-idp-singlesignonservice">IDP SingleSignOnService sub element</a>.
Settings of the HTTP client that is used for SAML descriptor retrieval usually
needs no additional configuration, however it can be configured in the
<a href="#_sp-idp-httpclient">IDP HttpClient sub element</a>.</p>
</div>
<div class="paragraph">
<p>It is also possible to specify multiple keys for signature verification. This is done by declaring multiple Key elements
within Keys sub element that have <code>signing</code> attribute set to <code>true</code>.
This is useful for example in situation when the IDP signing keys are rotated: There is
usually a transition period when new SAML protocol messages and assertions are signed
with the new key but those signed by previous key should still be accepted.</p>
</div>
<div class="paragraph">
<p>It is not possible to configure Keycloak to both obtain the keys
for signature verification automatically and define additional static signature
verification keys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">       <span class="tag">&lt;IDP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
            <span class="tag">&lt;Keys&gt;</span>
                <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                        <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;/KeyStore&gt;</span>
                <span class="tag">&lt;/Key&gt;</span>
            <span class="tag">&lt;/Keys&gt;</span>
        <span class="tag">&lt;/IDP&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_sp-idp-httpclient"><a class="anchor" href="#_sp-idp-httpclient"></a>IDP HttpClient sub element</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/general-config/idp_httpclient_subelement.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/general-config/idp_httpclient_subelement.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/general-config/idp_httpclient_subelement.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The <code>HttpClient</code> optional sub element defines the properties of HTTP client used
for automatic obtaining of certificates containing public keys for IDP signature
verification via SAML descriptor of the IDP when
<a href="#_sp-idp-keys-automatic">enabled</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;HttpClient</span> <span class="attribute-name">connectionPoolSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">disableTrustManager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">allowAnyHostname</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">clientKeystore</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:keystore.jks</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">clientKeystorePassword</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pwd</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">truststore</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:truststore.jks</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">truststorePassword</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pwd</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">proxyUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://proxy/</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">socketTimeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">connectionTimeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">6000</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">connectionTtl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">500</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">connectionPoolSize</dt>
<dd>
<p>This config option defines how many connections to the Keycloak server should be pooled.
This is <em>OPTIONAL</em>.
The default value is <code>10</code>.</p>
</dd>
<dt class="hdlist1">disableTrustManager</dt>
<dd>
<p>If the Keycloak server requires HTTPS and this config option is set to <code>true</code> you do not have to specify a truststore.
This setting should only be used during development and <strong>never</strong> in production as it will disable verification of SSL certificates.
This is <em>OPTIONAL</em>.
The default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">allowAnyHostname</dt>
<dd>
<p>If the Keycloak server requires HTTPS and this config option is set to <code>true</code>
the Keycloak server&#8217;s certificate is validated via the truststore,
but host name validation is not done.
This setting should only be used during development and <strong>never</strong> in production
as it will partly disable verification of SSL certificates.
This setting may be useful in test environments. This is <em>OPTIONAL</em>.
The default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">truststore</dt>
<dd>
<p>The value is the file path to a truststore file.
If you prefix the path with <code>classpath:</code>, then the truststore will be obtained from the deployment&#8217;s classpath instead.
Used for outgoing HTTPS communications to the Keycloak server.
Client making HTTPS requests need a way to verify the host of the server they are talking to.
This is what the truststore does.
The keystore contains one or more trusted host certificates or certificate authorities.
You can create this truststore by extracting the public certificate of the Keycloak server&#8217;s SSL keystore.
This is <em>REQUIRED</em> unless <code>disableTrustManager</code> is <code>true</code>.</p>
</dd>
<dt class="hdlist1">truststorePassword</dt>
<dd>
<p>Password for the truststore.
This is <em>REQUIRED</em> if <code>truststore</code> is set and the truststore requires a password.</p>
</dd>
<dt class="hdlist1">clientKeystore</dt>
<dd>
<p>This is the file path to a keystore file.
This keystore contains client certificate for two-way SSL when the adapter makes HTTPS requests to the Keycloak server.
This is <em>OPTIONAL</em>.</p>
</dd>
<dt class="hdlist1">clientKeystorePassword</dt>
<dd>
<p>Password for the client keystore and for the client&#8217;s key.
This is <em>REQUIRED</em> if <code>clientKeystore</code> is set.</p>
</dd>
<dt class="hdlist1">proxyUrl</dt>
<dd>
<p>URL to HTTP proxy to use for HTTP connections.
This is <em>OPTIONAL</em>.</p>
</dd>
<dt class="hdlist1">socketTimeout</dt>
<dd>
<p>Timeout for socket waiting for data after establishing the connection in milliseconds.
Maximum time of inactivity between two data packets.
A timeout value of zero is interpreted as an infinite timeout.
A negative value is interpreted as undefined (system default if applicable).
The default value is <code>-1</code>.
This is <em>OPTIONAL</em>.</p>
</dd>
<dt class="hdlist1">connectionTimeout</dt>
<dd>
<p>Timeout for establishing the connection with the remote host in milliseconds.
A timeout value of zero is interpreted as an infinite timeout.
A negative value is interpreted as undefined (system default if applicable).
The default value is <code>-1</code>.
This is <em>OPTIONAL</em>.</p>
</dd>
<dt class="hdlist1">connectionTtl</dt>
<dd>
<p>Connection time-to-live for client in milliseconds.
A value less than or equal to zero is interpreted as an infinite value.
The default value is <code>-1</code>.
This is <em>OPTIONAL</em>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_saml_jboss_adapter"><a class="anchor" href="#_saml_jboss_adapter"></a>3.1.2. JBoss EAP/WildFly adapter</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/saml-jboss-adapter.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/saml-jboss-adapter.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/saml-jboss-adapter.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>To be able to secure WAR apps deployed on JBoss EAP or WildFly, you must install and configure the Keycloak SAML Adapter Subsystem.</p>
</div>
<div class="paragraph">
<p>You then provide a keycloak config, <code>/WEB-INF/keycloak-saml.xml</code> file in your WAR and change the auth-method to KEYCLOAK-SAML within web.xml.</p>
</div>
</div>
<div class="sect3">
<h4 id="_saml-jboss-adapter-installation"><a class="anchor" href="#_saml-jboss-adapter-installation"></a>3.1.3. Installing adapters from a Galleon feature pack</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/jboss-adapter/jboss_adapter_installation.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/jboss-adapter/jboss_adapter_installation.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/jboss-adapter/jboss_adapter_installation.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>For the WildFly 29 or newer, the SAML adapter is provided as a Galleon feature pack. More details about this is
in the <a href="https://docs.wildfly.org/30/WildFly_Elytron_Security.html#Keycloak_SAML_Integration">WildFly documentation</a>. The same option will be provided
for JBoss EAP 8 GA.</p>
</div>
<div class="paragraph">
<p>Keycloak provided adapter ZIP download in the past, but it is not provided anymore. For the older WildFly versions, it is recommended to upgrade
to newer WildFly/EAP and use Galleon. Otherwise, you will need to stick with the older Keycloak adapters, but those are not maintained and officially supported.
For JBoss EAP 7, it is possible to stick with the Red Hat Single Sign-On 7.6 adapters, which is still supported.</p>
</div>
<div class="paragraph">
<p>For more details on how to integrate Keycloak with JakartaEE applications running on latest Wildfly/EAP, take a look at the Jakarta EE quickstart in the <a href="https://github.com/keycloak/keycloak-quickstarts">Keycloak Quickstart GitHub Repository</a>.</p>
</div>
<div class="paragraph">
<p>Below are the details on how to configure the SAML adapter secured by Galleon.</p>
</div>
<div class="sect4">
<h5 id="_saml-jboss-adapter-samesite-setting"><a class="anchor" href="#_saml-jboss-adapter-samesite-setting"></a>Setting SameSite value for JSESSIONID cookie</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/jboss-adapter/jboss-adapter-samesite-setting.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/jboss-adapter/jboss-adapter-samesite-setting.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/jboss-adapter/jboss-adapter-samesite-setting.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Browsers are planning to set the default value for the <code>SameSite</code> attribute for cookies to <code>Lax</code>. This setting means
that cookies will be sent to applications only if the request originates in the same domain. This behavior can affect
the SAML POST binding which may become non-functional. To preserve full functionality of the SAML adapter, we recommend
setting the <code>SameSite</code> value to <code>None</code> for the <code>JSESSIONID</code> cookie created by your container. Not doing so may result in
resetting the container&#8217;s session with each request to Keycloak.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To avoid setting the <code>SameSite</code> attribute to <code>None</code>, consider switching to the REDIRECT binding
if it is acceptable, or to OIDC protocol where this workaround is not necessary.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To set the <code>SameSite</code> value to <code>None</code> for the <code>JSESSIONID</code> cookie in Wildfly/EAP, add a file <code>undertow-handlers.conf</code>
with the following content to the <code>WEB-INF</code> directory of your application.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>samesite-cookie(mode=None, cookie-pattern=JSESSIONID)</pre>
</div>
</div>
<div class="paragraph">
<p>The support for this configuration is available in Wildfly from version 19.1.0.</p>
</div>
</div>
<div class="sect4">
<h5 id="securing-a-war"><a class="anchor" href="#securing-a-war"></a>Securing a WAR</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/jboss-adapter/required_per_war_configuration.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/jboss-adapter/required_per_war_configuration.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/jboss-adapter/required_per_war_configuration.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>This section describes how to secure a WAR directly by adding config and editing files within your WAR package.</p>
</div>
<div class="paragraph">
<p>The first thing you must do is create a <code>keycloak-saml.xml</code> adapter config file within the <code>WEB-INF</code> directory of your WAR.
The format of this config file is described in the <a href="#_saml-general-config">General Adapter Config</a> section.</p>
</div>
<div class="paragraph">
<p>Next you must set the <code>auth-method</code> to <code>KEYCLOAK-SAML</code> in <code>web.xml</code>.
You also have to use standard servlet security to specify role-base constraints on your URLs.
Here&#8217;s an example <em>web.xml</em> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;web-app</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://jakarta.ee/xml/ns/jakartaee</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://jakarta.ee/xml/ns/jakartaee https://jakarta.ee/xml/ns/jakartaee/web-app_6_0.xsd</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">6.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;module-name&gt;</span>customer-portal<span class="tag">&lt;/module-name&gt;</span>

    <span class="tag">&lt;security-constraint&gt;</span>
        <span class="tag">&lt;web-resource-collection&gt;</span>
            <span class="tag">&lt;web-resource-name&gt;</span>Admins<span class="tag">&lt;/web-resource-name&gt;</span>
            <span class="tag">&lt;url-pattern&gt;</span>/admin/*<span class="tag">&lt;/url-pattern&gt;</span>
        <span class="tag">&lt;/web-resource-collection&gt;</span>
        <span class="tag">&lt;auth-constraint&gt;</span>
            <span class="tag">&lt;role-name&gt;</span>admin<span class="tag">&lt;/role-name&gt;</span>
        <span class="tag">&lt;/auth-constraint&gt;</span>
        <span class="tag">&lt;user-data-constraint&gt;</span>
            <span class="tag">&lt;transport-guarantee&gt;</span>CONFIDENTIAL<span class="tag">&lt;/transport-guarantee&gt;</span>
        <span class="tag">&lt;/user-data-constraint&gt;</span>
    <span class="tag">&lt;/security-constraint&gt;</span>
    <span class="tag">&lt;security-constraint&gt;</span>
        <span class="tag">&lt;web-resource-collection&gt;</span>
            <span class="tag">&lt;web-resource-name&gt;</span>Customers<span class="tag">&lt;/web-resource-name&gt;</span>
            <span class="tag">&lt;url-pattern&gt;</span>/customers/*<span class="tag">&lt;/url-pattern&gt;</span>
        <span class="tag">&lt;/web-resource-collection&gt;</span>
        <span class="tag">&lt;auth-constraint&gt;</span>
            <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
        <span class="tag">&lt;/auth-constraint&gt;</span>
        <span class="tag">&lt;user-data-constraint&gt;</span>
            <span class="tag">&lt;transport-guarantee&gt;</span>CONFIDENTIAL<span class="tag">&lt;/transport-guarantee&gt;</span>
        <span class="tag">&lt;/user-data-constraint&gt;</span>
    <span class="tag">&lt;/security-constraint&gt;</span>

    <span class="tag">&lt;login-config&gt;</span>
        <span class="tag">&lt;auth-method&gt;</span>KEYCLOAK-SAML<span class="tag">&lt;/auth-method&gt;</span>
        <span class="tag">&lt;realm-name&gt;</span>this is ignored currently<span class="tag">&lt;/realm-name&gt;</span>
    <span class="tag">&lt;/login-config&gt;</span>

    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>admin<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All standard servlet settings except the <code>auth-method</code> setting.</p>
</div>
</div>
<div class="sect4">
<h5 id="securing-wars-using-the-keycloak-saml-subsystem"><a class="anchor" href="#securing-wars-using-the-keycloak-saml-subsystem"></a>Securing WARs using the Keycloak SAML Subsystem</h5>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/jboss-adapter/securing_wars.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/jboss-adapter/securing_wars.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/jboss-adapter/securing_wars.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>You do not have to open a WAR to secure it with Keycloak.
Alternatively, you can externally secure it via the Keycloak SAML Adapter Subsystem.
While you don&#8217;t have to specify KEYCLOAK-SAML as an <code>auth-method</code>, you still have to define the <code>security-constraints</code> in <code>web.xml</code>.
You do not, however, have to create a <code>WEB-INF/keycloak-saml.xml</code> file.
This metadata is instead defined within the XML in your server&#8217;s <code>domain.xml</code> or <code>standalone.xml</code> subsystem configuration section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;extensions&gt;</span>
  <span class="tag">&lt;extension</span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.keycloak-saml-adapter-subsystem</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/extensions&gt;</span>

<span class="tag">&lt;profile&gt;</span>
  <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-saml:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;secure-deployment</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WAR MODULE NAME.war</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;SP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">APPLICATION URL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
      <span class="tag">&lt;/SP&gt;</span>
    <span class="tag">&lt;/secure-deployment&gt;</span>
  <span class="tag">&lt;/subsystem&gt;</span>
<span class="tag">&lt;/profile&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>secure-deployment</code> <code>name</code> attribute identifies the WAR you want to secure.
Its value is the <code>module-name</code> defined in <code>web.xml</code> with <code>.war</code> appended.
The rest of the configuration uses the same XML syntax as <code>keycloak-saml.xml</code> configuration defined in <a href="#_saml-general-config">General Adapter Config</a>.</p>
</div>
<div class="paragraph">
<p>An example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-saml:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;secure-deployment</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">saml-post-encryption.war</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;SP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/sales-post-enc/</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">sslPolicy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EXTERNAL</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">nameIDPolicyFormat</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">logoutPage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/logout.jsp</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">forceAuthentication</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;Keys&gt;</span>
        <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">encryption</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;PrivateKey</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/sales-post-enc/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">test123</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/sales-post-enc/</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/KeyStore&gt;</span>
        <span class="tag">&lt;/Key&gt;</span>
      <span class="tag">&lt;/Keys&gt;</span>
      <span class="tag">&lt;PrincipalNameMapping</span> <span class="attribute-name">policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_NAME_ID</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;RoleIdentifiers&gt;</span>
        <span class="tag">&lt;Attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Role</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/RoleIdentifiers&gt;</span>
      <span class="tag">&lt;IDP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;SingleSignOnService</span> <span class="attribute-name">signRequest</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">validateResponseSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">bindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/realms/saml-demo/protocol/saml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

        <span class="tag">&lt;SingleLogoutService</span>
            <span class="attribute-name">validateRequestSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">validateResponseSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">signRequest</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">signResponse</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">responseBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">postBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/realms/saml-demo/protocol/saml</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">redirectBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/realms/saml-demo/protocol/saml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;Keys&gt;</span>
          <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
            <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">saml-demo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/KeyStore&gt;</span>
          <span class="tag">&lt;/Key&gt;</span>
        <span class="tag">&lt;/Keys&gt;</span>
      <span class="tag">&lt;/IDP&gt;</span>
    <span class="tag">&lt;/SP&gt;</span>
   <span class="tag">&lt;/secure-deployment&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="registering-with-an-identity-provider"><a class="anchor" href="#registering-with-an-identity-provider"></a>3.1.4. Registering with an Identity Provider</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/idp-registration.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/idp-registration.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/idp-registration.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>For each servlet-based adapter, the endpoint you register for the assert consumer service URL and single logout service
must be the base URL of your servlet application with <code>/saml</code> appended to it, that is, <code>https://example.com/contextPath/saml</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="logout"><a class="anchor" href="#logout"></a>3.1.5. Logout</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/logout.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/logout.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/logout.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>There are multiple ways you can log out from a web application.
For Jakarta EE servlet containers, you can call <code>HttpServletRequest.logout()</code>. For any other browser application, you can point
the browser at any url of your web application that has a security constraint and pass in a query parameter GLO, i.e. <code>http://myapp?GLO=true</code>.
This will log you out if you have an SSO session with your browser.</p>
</div>
<div class="sect4">
<h5 id="_saml_logout_in_cluster"><a class="anchor" href="#_saml_logout_in_cluster"></a>Logout in clustered environment</h5>
<div class="paragraph">
<p>Internally, the SAML adapter stores a mapping between the SAML session index, principal name (when known), and HTTP session ID.
This mapping can be maintained in JBoss application server family (WildFly 10/11, EAP 6/7) across cluster for distributable
applications. As a precondition, the HTTP sessions need to be distributed across cluster (i.e. application is marked with
<code>&lt;distributable/&gt;</code> tag in application&#8217;s <code>web.xml</code>).</p>
</div>
<div class="paragraph">
<p>To enable the functionality, add the following section to your <code>/WEB_INF/web.xml</code> file:</p>
</div>
<div class="paragraph">
<p>For EAP 7, WildFly 10/11:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;context-param&gt;</span>
    <span class="tag">&lt;param-name&gt;</span>keycloak.sessionIdMapperUpdater.classes<span class="tag">&lt;/param-name&gt;</span>
    <span class="tag">&lt;param-value&gt;</span>org.keycloak.adapters.saml.wildfly.infinispan.InfinispanSessionCacheIdMapperUpdater<span class="tag">&lt;/param-value&gt;</span>
<span class="tag">&lt;/context-param&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For EAP 6:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;context-param&gt;</span>
    <span class="tag">&lt;param-name&gt;</span>keycloak.sessionIdMapperUpdater.classes<span class="tag">&lt;/param-name&gt;</span>
    <span class="tag">&lt;param-value&gt;</span>org.keycloak.adapters.saml.jbossweb.infinispan.InfinispanSessionCacheIdMapperUpdater<span class="tag">&lt;/param-value&gt;</span>
<span class="tag">&lt;/context-param&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the session cache of the deployment is named <code><em>deployment-cache</em></code>, the cache used for SAML mapping will be named
as <code><em>deployment-cache</em>.ssoCache</code>. The name of the cache can be overridden by a context parameter
<code>keycloak.sessionIdMapperUpdater.infinispan.cacheName</code>. The cache container containing the cache will be the same as
the one containing the deployment session cache, but can be overridden by a context parameter
<code>keycloak.sessionIdMapperUpdater.infinispan.containerName</code>.</p>
</div>
<div class="paragraph">
<p>By default, the configuration of the SAML mapping cache will be derived from session cache. The configuration can
be manually overridden in cache configuration section of the server just the same as other caches.</p>
</div>
<div class="paragraph">
<p>Currently, to provide reliable service, it is recommended to use replicated cache for the SAML session cache.
Using distributed cache may lead to results where the SAML logout request would land to a node with no access
to SAML session index to HTTP session mapping which would lead to unsuccessful logout.</p>
</div>
</div>
<div class="sect4">
<h5 id="_saml_logout_in_cross_dc"><a class="anchor" href="#_saml_logout_in_cross_dc"></a>Logout in cross-site scenario</h5>
<div class="paragraph">
<p>The cross-site scenario only applies to WildFly 10 and higher, and EAP 7 and higher.</p>
</div>
<div class="paragraph">
<p>Special handling is needed for handling sessions that span multiple data centers. Imagine the following scenario:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Login requests are handled within cluster in data center 1.</p>
</li>
<li>
<p>Admin issues logout request for a particular SAML session, the request lands in data center 2.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The data center 2 has to log out all sessions that are present in data center 1 (and all other data centers that
share HTTP sessions).</p>
</div>
<div class="paragraph">
<p>To cover this case, the SAML session cache described <a href="#_saml_logout_in_cluster">above</a> needs to be replicated
not only within individual clusters but across all the data centers for example
<a href="https://docs.redhat.com/en/documentation/red_hat_data_grid/6.6/html/administration_and_configuration_guide/chap-externalize_sessions#Externalize_HTTP_Session_from_JBoss_EAP_6.x_to_JBoss_Data_Grid">via standalone Infinispan/JDG server</a>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A cache has to be added to the standalone Infinispan/JDG server.</p>
</li>
<li>
<p>The cache from previous item has to be added as a remote store for the respective SAML session cache.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once remote store is found to be present on SAML session cache during deployment, it is watched for changes
and the local SAML session cache is updated accordingly.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="obtaining-assertion-attributes"><a class="anchor" href="#obtaining-assertion-attributes"></a>3.1.6. Obtaining assertion attributes</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/assertion-api.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/assertion-api.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/assertion-api.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>After a successful SAML login, your application code may want to obtain attribute values passed with the SAML assertion.
<code>HttpServletRequest.getUserPrincipal()</code> returns a <code>Principal</code> object that you can typecast into a Keycloak specific class
called <code>org.keycloak.adapters.saml.SamlPrincipal</code>.
This object allows you to look at the raw assertion and also has convenience functions to look up attribute values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.keycloak.adapters.saml</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">SamlPrincipal</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span>, <span class="predefined-type">Principal</span> {
    <span class="comment">/**
     * Get full saml assertion
     *
     * @return
     */</span>
    <span class="directive">public</span> AssertionType getAssertion() {
       ...
    }

    <span class="comment">/**
     * Get SAML subject sent in assertion
     *
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getSamlSubject() {
        ...
    }

    <span class="comment">/**
     * Subject nameID format
     *
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getNameIDFormat() {
        ...
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        ...
    }

    <span class="comment">/**
     * Convenience function that gets Attribute value by attribute name
     *
     * @param name
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getAttributes(<span class="predefined-type">String</span> name) {
        ...

    }

    <span class="comment">/**
     * Convenience function that gets Attribute value by attribute friendly name
     *
     * @param friendlyName
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getFriendlyAttributes(<span class="predefined-type">String</span> friendlyName) {
        ...
    }

    <span class="comment">/**
     * Convenience function that gets first  value of an attribute by attribute name
     *
     * @param name
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getAttribute(<span class="predefined-type">String</span> name) {
        ...
    }

    <span class="comment">/**
     * Convenience function that gets first  value of an attribute by attribute name
     *
     *
     * @param friendlyName
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getFriendlyAttribute(<span class="predefined-type">String</span> friendlyName) {
        ...
    }

    <span class="comment">/**
     * Get set of all assertion attribute names
     *
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; getAttributeNames() {
        ...
    }

    <span class="comment">/**
     * Get set of all assertion friendly attribute names
     *
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; getFriendlyNames() {
        ...
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="error-handling"><a class="anchor" href="#error-handling"></a>3.1.7. Error Handling</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/error_handling.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/error_handling.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/error_handling.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak has some error handling facilities for servlet based client adapters.
When an error is encountered in authentication, the client adapter will call <code>HttpServletResponse.sendError()</code>.
You can set up an <code>error-page</code> within your <code>web.xml</code> file to handle the error however you want.
The client adapter can throw 400, 401, 403, and 500 errors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;error-page&gt;</span>
    <span class="tag">&lt;error-code&gt;</span>403<span class="tag">&lt;/error-code&gt;</span>
    <span class="tag">&lt;location&gt;</span>/ErrorHandler<span class="tag">&lt;/location&gt;</span>
<span class="tag">&lt;/error-page&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The client adapter also sets an <code>HttpServletRequest</code> attribute that you can retrieve.
The attribute name is <code>org.keycloak.adapters.spi.AuthenticationError</code>.
Typecast this object to: <code>org.keycloak.adapters.saml.SamlAuthenticationError</code>.
This class can tell you exactly what happened.
If this attribute is not set, then the adapter was not responsible for the error code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SamlAuthenticationError</span> <span class="directive">implements</span> AuthenticationError {
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">enum</span> Reason {
        EXTRACTION_FAILURE,
        INVALID_SIGNATURE,
        ERROR_STATUS
    }

    <span class="directive">public</span> Reason getReason() {
        <span class="keyword">return</span> reason;
    }
    <span class="directive">public</span> StatusResponseType getStatus() {
        <span class="keyword">return</span> status;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>3.1.8. Troubleshooting</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/debugging.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/debugging.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/debugging.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The best way to troubleshoot problems is to turn on debugging for SAML in both the client adapter and Keycloak Server. Using your logging framework, set the log level to <code>DEBUG</code> for the <code>org.keycloak.saml</code> package. Turning this on allows you to see the SAML requests and response documents being sent to and from the server.</p>
</div>
</div>
<div class="sect3">
<h4 id="_saml_multi_tenancy"><a class="anchor" href="#_saml_multi_tenancy"></a>3.1.9. Multi Tenancy</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/multi-tenancy.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/multi-tenancy.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/multi-tenancy.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>SAML offers Multi Tenancy, meaning that a single target application (WAR) can be secured with multiple Keycloak realms. The realms can be located on the same Keycloak instance or on different instances.</p>
</div>
<div class="paragraph">
<p>To do this, the application must have multiple <code>keycloak-saml.xml</code> adapter configuration files.</p>
</div>
<div class="paragraph">
<p>While you could have multiple instances of your WAR with different adapter configuration files deployed to different context-paths, this may be inconvenient and you may also want to select the realm based on something other than context-path.</p>
</div>
<div class="paragraph">
<p>Keycloak makes it possible to have a custom config resolver, so you can choose which adapter config is used for each request. In SAML, the configuration is only interesting in the login processing; once the user is logged in, the session is authenticated and it does not matter if the <code>keycloak-saml.xml</code> returned is different. For that reason, returning the same configuration for the same session is the correct way to go.</p>
</div>
<div class="paragraph">
<p>To achieve this, create an implementation of <code>org.keycloak.adapters.saml.SamlConfigResolver</code>. The following example uses the <code>Host</code> header to locate the proper configuration and load it and the associated elements from the applications' Java classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example</span>;

<span class="keyword">import</span> <span class="include">java.io.InputStream</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.adapters.saml.SamlConfigResolver</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.adapters.saml.SamlDeployment</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.adapters.saml.config.parsers.DeploymentBuilder</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.adapters.saml.config.parsers.ResourceLoader</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.adapters.spi.HttpFacade</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.saml.common.exceptions.ParsingException</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">SamlMultiTenantResolver</span> <span class="directive">implements</span> SamlConfigResolver {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SamlDeployment resolve(HttpFacade.Request request) {
        <span class="predefined-type">String</span> host = request.getHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Host</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">String</span> realm = <span class="predefined-constant">null</span>;
        <span class="keyword">if</span> (host.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">tenant1</span><span class="delimiter">&quot;</span></span>)) {
            realm = <span class="string"><span class="delimiter">&quot;</span><span class="content">tenant1</span><span class="delimiter">&quot;</span></span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (host.contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">tenant2</span><span class="delimiter">&quot;</span></span>)) {
            realm = <span class="string"><span class="delimiter">&quot;</span><span class="content">tenant2</span><span class="delimiter">&quot;</span></span>;
        } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Not able to guess the keycloak-saml.xml to load</span><span class="delimiter">&quot;</span></span>);
        }

        <span class="predefined-type">InputStream</span> is = getClass().getResourceAsStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> + realm + <span class="string"><span class="delimiter">&quot;</span><span class="content">-keycloak-saml.xml</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span> (is == <span class="predefined-constant">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Not able to find the file /</span><span class="delimiter">&quot;</span></span> + realm + <span class="string"><span class="delimiter">&quot;</span><span class="content">-keycloak-saml.xml</span><span class="delimiter">&quot;</span></span>);
        }

        ResourceLoader loader = <span class="keyword">new</span> ResourceLoader() {
            <span class="annotation">@Override</span>
            <span class="directive">public</span> <span class="predefined-type">InputStream</span> getResourceAsStream(<span class="predefined-type">String</span> path) {
                <span class="keyword">return</span> getClass().getResourceAsStream(path);
            }
        };

        <span class="keyword">try</span> {
            <span class="keyword">return</span> <span class="keyword">new</span> DeploymentBuilder().build(is, loader);
        } <span class="keyword">catch</span> (ParsingException e) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cannot load SAML deployment</span><span class="delimiter">&quot;</span></span>, e);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must also configure which <code>SamlConfigResolver</code> implementation to use with the <code>keycloak.config.resolver</code> context-param in your <code>web.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;web-app&gt;</span>
    ...
    <span class="tag">&lt;context-param&gt;</span>
        <span class="tag">&lt;param-name&gt;</span>keycloak.config.resolver<span class="tag">&lt;/param-name&gt;</span>
        <span class="tag">&lt;param-value&gt;</span>example.SamlMultiTenantResolver<span class="tag">&lt;/param-value&gt;</span>
    <span class="tag">&lt;/context-param&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="migration-from-older-versions"><a class="anchor" href="#migration-from-older-versions"></a>3.1.10. Migration from older versions</h4>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/java/MigrationFromOlderVersions.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/java/MigrationFromOlderVersions.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/java/MigrationFromOlderVersions.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="sect4">
<h5 id="migrating-to-1-9-0"><a class="anchor" href="#migrating-to-1-9-0"></a>Migrating to 1.9.0</h5>
<div class="sect5">
<h6 id="saml-sp-client-adapter-changes"><a class="anchor" href="#saml-sp-client-adapter-changes"></a>SAML SP Client Adapter changes</h6>
<div class="paragraph">
<p>Keycloak SAML SP Client Adapter now requires a specific endpoint, <code>/saml</code> to be registered with your IdP.
The SamlFilter must also be bound to /saml in addition to any other binding it has.
This had to be done because SAML POST binding would eat the request input stream and this would be really bad for clients that relied on it.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mod_auth_mellon"><a class="anchor" href="#_mod_auth_mellon"></a>3.2. mod_auth_mellon Apache HTTPD Module</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/mod-auth-mellon.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/mod-auth-mellon.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/mod-auth-mellon.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Keycloak does not provide any official support to mod_auth_mellon. The instructions below are best-effort and may not be up-to-date.
We recommend that you stick to official mod_auth_mellon documentation for more details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/latchset/mod_auth_mellon">mod_auth_mellon</a> module is an Apache HTTPD plugin for SAML. If your language/environment supports using Apache HTTPD as a proxy, then you can use mod_auth_mellon to secure your web application with SAML. For more details on this module see the <em>mod_auth_mellon</em> GitHub repo.</p>
</div>
<div class="paragraph">
<p>To configure mod_auth_mellon you need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An Identity Provider (IdP) entity descriptor XML file, which describes the connection to Keycloak or another SAML IdP</p>
</li>
<li>
<p>An SP entity descriptor XML file, which describes the SAML connections and configuration for the application you are securing.</p>
</li>
<li>
<p>A private key PEM file, which is a text file in the PEM format that defines the private key the application uses to sign documents.</p>
</li>
<li>
<p>A certificate PEM file, which is a text file that defines the certificate for your application.</p>
</li>
<li>
<p>mod_auth_mellon-specific Apache HTTPD module configuration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you have already defined and registered the client application within a realm on the Keycloak application server, Keycloak can generate all the files you need except the Apache HTTPD module configuration.</p>
</div>
<div class="paragraph">
<p>Perform the following procedure to generate the Apache HTTPD module configuration.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Go to the Installation page of your SAML client.</p>
</li>
<li>
<p>Select the <strong>Mod Auth Mellon</strong> files option.</p>
<div class="paragraph">
<div class="title">mod_auth_mellon config download</div>
<p><span class="image"><img src="./images/mod-auth-mellon-config-download.png" alt="mod auth mellon config download"></span></p>
</div>
</li>
<li>
<p>Click <strong>Download</strong> to download a ZIP file that contains the XML descriptor and PEM files you need.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="configuring-mod_auth_mellon-with-keycloak"><a class="anchor" href="#configuring-mod_auth_mellon-with-keycloak"></a>3.2.1. Configuring mod_auth_mellon with Keycloak</h4>
<div class="paragraph">
<p>There are two hosts involved:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The host on which Keycloak is running, which will be referred to as $idp_host because Keycloak is a SAML identity provider (IdP).</p>
</li>
<li>
<p>The host on which the web application is running, which will be referred to as $sp_host. In SAML an application using an IdP is called a service provider (SP).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of the following steps need to performed on $sp_host with root privileges.</p>
</div>
<div class="sect4">
<h5 id="installing-the-packages"><a class="anchor" href="#installing-the-packages"></a>Installing the packages</h5>
<div class="paragraph">
<p>To install the necessary packages, you will need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Apache Web Server (httpd)</p>
</li>
<li>
<p>Mellon SAML SP add-on module for Apache</p>
</li>
<li>
<p>Tools to create X509 certificates</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To install the necessary packages, run this command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>yum install httpd mod_auth_mellon mod_ssl openssl</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="creating-a-configuration-directory-for-apache-saml"><a class="anchor" href="#creating-a-configuration-directory-for-apache-saml"></a>Creating a configuration directory for Apache SAML</h5>
<div class="paragraph">
<p>It is advisable to keep configuration files related to Apache&#8217;s use of SAML in one location.</p>
</div>
<div class="paragraph">
<p>Create a new directory named saml2 located under the Apache configuration root /etc/httpd:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir /etc/httpd/saml2</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuring-the-mellon-service-provider"><a class="anchor" href="#configuring-the-mellon-service-provider"></a>Configuring the Mellon Service Provider</h5>
<div class="paragraph">
<p>Configuration files for Apache add-on modules are located in the /etc/httpd/conf.d directory and have a file name extension of .conf. You need to create the /etc/httpd/conf.d/mellon.conf file and place Mellon&#8217;s configuration directives in it.</p>
</div>
<div class="paragraph">
<p>Mellon&#8217;s configuration directives can roughly be broken down into two classes of information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Which URLs to protect with SAML authentication</p>
</li>
<li>
<p>What SAML parameters will be used when a protected URL is referenced.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Apache configuration directives typically follow a hierarchical tree structure in the URL space, which are known as locations. You need to specify one or more URL locations for Mellon to protect. You have flexibility in how you add the configuration parameters that apply to each location. You can either add all the necessary parameters to the location block or you can add Mellon parameters to a common location high up in the URL location hierarchy that specific protected locations inherit (or some combination of the two). Since it is common for an SP to operate in the same way no matter which location triggers SAML actions, the example configuration used here places common Mellon configuration directives in the root of the hierarchy and then specific locations to be protected by Mellon can be defined with minimal directives. This strategy avoids duplicating the same parameters for each protected location.</p>
</div>
<div class="paragraph">
<p>This example has just one protected location: https://$sp_host/private.</p>
</div>
<div class="paragraph">
<p>To configure the Mellon service provider, perform the following procedure.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create the file /etc/httpd/conf.d/mellon.conf with this content:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="tag">&lt;Location</span> <span class="error">/</span> <span class="tag">&gt;</span>
    MellonEnable info
    MellonEndpointPath /mellon/
    MellonSPMetadataFile /etc/httpd/saml2/mellon_metadata.xml
    MellonSPPrivateKeyFile /etc/httpd/saml2/mellon.key
    MellonSPCertFile /etc/httpd/saml2/mellon.crt
    MellonIdPMetadataFile /etc/httpd/saml2/idp_metadata.xml
 <span class="tag">&lt;/Location&gt;</span>
 <span class="tag">&lt;Location</span> <span class="error">/</span><span class="attribute-name">private</span> <span class="tag">&gt;</span>
    AuthType Mellon
    MellonEnable auth
    Require valid-user
 <span class="tag">&lt;/Location&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some of the files referenced in the code above are created in later steps.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setting-the-samesite-value-for-the-cookie-used-by-mod_auth_mellon"><a class="anchor" href="#setting-the-samesite-value-for-the-cookie-used-by-mod_auth_mellon"></a>3.2.2. Setting the SameSite value for the cookie used by mod_auth_mellon</h4>
<div class="paragraph">
<p>Browsers are planning to set the default value for the <code>SameSite</code> attribute for cookies to <code>Lax</code>. This setting means
that cookies will be sent to applications only if the request originates in the same domain. This behavior can affect
the SAML POST binding which may become non-functional. To preserve full functionality of the <em>mod_auth_mellon</em> module,
we recommend setting the <code>SameSite</code> value to <code>None</code> for the cookie created by <em>mod_auth_mellon</em>. Not doing so may result
in an inability to login using Keycloak.</p>
</div>
<div class="paragraph">
<p>To set the <code>SameSite</code> value to <code>None</code>, add the following configuration to <code>&lt;Location / &gt;</code> tag within your <code>mellon.conf</code>
file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">MellonSecureCookie On
MellonCookieSameSite none</code></pre>
</div>
</div>
<div class="paragraph">
<p>The support for this configuration is available in the <em>mod_auth_mellon</em> module from version 0.16.0.</p>
</div>
<div class="sect4">
<h5 id="creating-the-service-provider-metadata"><a class="anchor" href="#creating-the-service-provider-metadata"></a>Creating the Service Provider metadata</h5>
<div class="paragraph">
<p>In SAML IdPs and SPs exchange SAML metadata, which is in XML format. The schema for the metadata is a standard, thus assuring participating SAML entities can consume each other&#8217;s metadata. You need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Metadata for the IdP that the SP utilizes</p>
</li>
<li>
<p>Metadata describing the SP provided to the IdP</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One of the components of SAML metadata is X509 certificates. These certificates are used for two purposes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sign SAML messages so the receiving end can prove the message originated from the expected party.</p>
</li>
<li>
<p>Encrypt the message during transport (seldom used because SAML messages typically occur on TLS-protected transports)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use your own certificates if you already have a Certificate Authority (CA) or you can generate a self-signed certificate. For simplicity in this example a self-signed certificate is used.</p>
</div>
<div class="paragraph">
<p>Because Mellon&#8217;s SP metadata must reflect the capabilities of the installed version of mod_auth_mellon, must be valid SP metadata XML, and must contain an X509 certificate (whose creation can be obtuse unless you are familiar with X509 certificate generation) the most expedient way to produce the SP metadata is to use a tool included in the mod_auth_mellon package (mellon_create_metadata.sh). The generated metadata can always be edited later because it is a text file. The tool also creates your X509 key and certificate.</p>
</div>
<div class="paragraph">
<p>SAML IdPs and SPs identify themselves using a unique name known as an EntityID. To use the Mellon metadata creation tool you need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The EntityID, which is typically the URL of the SP, and often the URL of the SP where the SP metadata can be retrieved</p>
</li>
<li>
<p>The URL where SAML messages for the SP will be consumed, which Mellon calls the MellonEndPointPath.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To create the SP metadata, perform the following procedure.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a few helper shell variables:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>fqdn=`hostname`
mellon_endpoint_url="https://${fqdn}/mellon"
mellon_entity_id="${mellon_endpoint_url}/metadata"
file_prefix="$(echo "$mellon_entity_id" | sed 's/[^A-Za-z.]/_/g' | sed 's/__*/_/g')"</code></pre>
</div>
</div>
</li>
<li>
<p>Invoke the Mellon metadata creation tool by running this command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/usr/libexec/mod_auth_mellon/mellon_create_metadata.sh $mellon_entity_id $mellon_endpoint_url</code></pre>
</div>
</div>
</li>
<li>
<p>Move the generated files to their destination (referenced in the /etc/httpd/conf.d/mellon.conf file created above):</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>mv ${file_prefix}.cert /etc/httpd/saml2/mellon.crt
mv ${file_prefix}.key /etc/httpd/saml2/mellon.key
mv ${file_prefix}.xml /etc/httpd/saml2/mellon_metadata.xml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="adding-the-mellon-service-provider-to-the-keycloak-identity-provider"><a class="anchor" href="#adding-the-mellon-service-provider-to-the-keycloak-identity-provider"></a>Adding the Mellon Service Provider to the Keycloak Identity Provider</h5>
<div class="paragraph">
<p>Assumption: The Keycloak IdP has already been installed on the $idp_host.</p>
</div>
<div class="paragraph">
<p>Keycloak supports multiple tenancy where all users, clients, and so on are grouped in what is called a realm. Each realm is independent of other realms. You can use an existing realm in your Keycloak, but this example shows how to create a new realm called test_realm and use that realm.</p>
</div>
<div class="paragraph">
<p>All these operations are performed using the Keycloak Admin Console. You must have the admin username and password for $idp_host to perform the following procedure.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Open the Admin Console and log on by entering the admin username and password.</p>
<div class="paragraph">
<p>After logging into the Admin Console, there will be an existing realm. When Keycloak is first set up a root realm, master, is created by default. Any previously created realms are listed in the upper left corner of the Admin Console in a drop-down list.</p>
</div>
</li>
<li>
<p>From the realm drop-down list select <strong>Add realm</strong>.</p>
</li>
<li>
<p>In the Name field type <code>test_realm</code> and click <strong>Create</strong>.</p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="adding-the-mellon-service-provider-as-a-client-of-the-realm"><a class="anchor" href="#adding-the-mellon-service-provider-as-a-client-of-the-realm"></a>Adding the Mellon Service Provider as a client of the realm</h6>
<div class="paragraph">
<p>In Keycloak SAML SPs are known as clients. To add the SP we must be in the Clients section of the realm.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click the Clients menu item on the left and click <strong>Create</strong> in the upper right corner to create a new client.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="adding-the-mellon-sp-client"><a class="anchor" href="#adding-the-mellon-sp-client"></a>Adding the Mellon SP client</h6>
<div class="paragraph">
<p>To add the Mellon SP client, perform the following procedure.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Set the client protocol to SAML.</p>
</li>
<li>
<p>From the Client Protocol drop down list, select <strong>saml</strong>.</p>
</li>
<li>
<p>Provide the Mellon SP metadata file created above (/etc/httpd/saml2/mellon_metadata.xml).</p>
<div class="paragraph">
<p>Depending on where your browser is running you might have to copy the SP metadata from $sp_host to the machine on which your browser is running so the browser can find the file.</p>
</div>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="editing-the-mellon-sp-client"><a class="anchor" href="#editing-the-mellon-sp-client"></a>Editing the Mellon SP client</h6>
<div class="paragraph">
<p>Use this procedure to set important client configuration parameters.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Ensure "Force POST Binding" is On.</p>
</li>
<li>
<p>Add paosResponse to the Valid Redirect URIs list:</p>
</li>
<li>
<p>Copy the postResponse URL in "Valid Redirect URIs" and paste it into the empty add text fields just below the "+".</p>
</li>
<li>
<p>Change "postResponse" to "paosResponse". (The paosResponse URL is needed for SAML ECP.)</p>
</li>
<li>
<p>Click <strong>Save</strong> at the bottom.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Many SAML SPs determine authorization based on a user&#8217;s membership in a group. The Keycloak IdP can manage user group information but it does not supply the user&#8217;s groups unless the IdP is configured to supply it as a SAML attribute.</p>
</div>
<div class="paragraph">
<p>Perform the following procedure to configure the IdP to supply the user&#8217;s groups as a SAML attribute.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Click the Mappers tab of the client.</p>
</li>
<li>
<p>In the upper right corner of the Mappers page, click <strong>Create</strong>.</p>
</li>
<li>
<p>From the Mapper Type drop-down list select <strong>Group list</strong>.</p>
</li>
<li>
<p>Set Name to "group list".</p>
</li>
<li>
<p>Set the SAML attribute name to "groups".</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The remaining steps are performed on $sp_host.</p>
</div>
</div>
<div class="sect5">
<h6 id="retrieving-the-identity-provider-metadata"><a class="anchor" href="#retrieving-the-identity-provider-metadata"></a>Retrieving the Identity Provider metadata</h6>
<div class="paragraph">
<p>Now that you have created the realm on the IdP you need to retrieve the IdP metadata associated with it so the Mellon SP recognizes it. In the /etc/httpd/conf.d/mellon.conf file created previously, the MellonIdPMetadataFile is specified as /etc/httpd/saml2/idp_metadata.xml but until now that file has not existed on $sp_host.</p>
</div>
<div class="paragraph">
<p>Use this procedure to retrieve that file from the IdP.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Use this command, substituting with the correct value for $idp_host:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>curl -k -o /etc/httpd/saml2/idp_metadata.xml \
https://$idp_host/realms/test_realm/protocol/saml/descriptor</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mellon is now fully configured.</p>
</div>
</li>
<li>
<p>To run a syntax check for Apache configuration files, use this command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>apachectl configtest</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Configtest is equivalent to the -t argument to apachectl. If the configuration test shows any errors, correct them before proceeding.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Restart the Apache server:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>systemctl restart httpd.service</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You have now set up both Keycloak as a SAML IdP in the test_realm and mod_auth_mellon as SAML SP protecting the URL $sp_host/protected (and everything beneath it) by authenticating against the <code>$idp_host</code> IdP.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_saml-errors"><a class="anchor" href="#_saml-errors"></a>3.3. Keycloak specific errors</h3>
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/saml/saml-errors.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/saml/saml-errors.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/saml/saml-errors.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>Keycloak server can send an error to the client application in the SAML response, which may contain a SAML status such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;samlp:Status&gt;</span>
  <span class="tag">&lt;samlp:StatusCode</span> <span class="attribute-name">Value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:oasis:names:tc:SAML:2.0:status:Responder</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;samlp:StatusCode</span> <span class="attribute-name">Value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:oasis:names:tc:SAML:2.0:status:AuthnFailed</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/samlp:StatusCode&gt;</span>
  <span class="tag">&lt;samlp:StatusMessage&gt;</span>authentication_expired<span class="tag">&lt;/samlp:StatusMessage&gt;</span>
<span class="tag">&lt;/samlp:Status&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Keycloak sends this error when a user is authenticated and has an SSO session, but the authentication session expired in the current browser tab and hence Keycloak server cannot automatically do SSO
re-authentication of the user and redirect back to client with successful response. When a client application receives this type of error, it is ideal to retry authentication immediately and send a new
SAML request to the Keycloak server, which should typically always authenticate the user due to the SSO session and redirect back. More details in
the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_authentication-sessions">Server Administration Guide</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-a-docker-registry-to-use-keycloak"><a class="anchor" href="#configuring-a-docker-registry-to-use-keycloak"></a>4. Configuring a Docker registry to use Keycloak</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/docker/docker-overview.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/docker/docker-overview.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/docker/docker-overview.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Docker authentication is disabled by default. To enable see the <a href="https://www.keycloak.org/server/features">Enabling and disabling features</a> guide.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This section describes how you can configure a Docker registry to use Keycloak as its authentication server.</p>
</div>
<div class="paragraph">
<p>For more information on how to set up and configure a Docker registry, see the <a href="https://distribution.github.io/distribution/about/configuration/">Docker Registry Configuration Guide</a>.</p>
</div>
<div class="sect2">
<h3 id="docker-registry-configuration-file-installation"><a class="anchor" href="#docker-registry-configuration-file-installation"></a>4.1. Docker registry configuration file installation</h3>
<div class="paragraph">
<p>For users with more advanced Docker registry configurations, it is generally recommended to provide your own registry configuration file.  The Keycloak Docker provider supports this mechanism via the <em>Registry Config File</em> Format Option.  Choosing this option will generate output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>auth:
  token:
    realm: http://localhost:8080/realms/master/protocol/docker-v2/auth
    service: docker-test
    issuer: http://localhost:8080/realms/master</code></pre>
</div>
</div>
<div class="paragraph">
<p>This output can then be copied into any existing registry config file.  See the <a href="https://distribution.github.io/distribution/about/configuration/">registry config file specification</a> for more information on how the file should be set up, or start with <a href="https://github.com/distribution/distribution/blob/main/cmd/registry/config-example.yml">a basic example</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Don&#8217;t forget to configure the <code>rootcertbundle</code> field with the location of the Keycloak realm&#8217;s public key.  The auth configuration will not work without this argument.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="docker-registry-environment-variable-override-installation"><a class="anchor" href="#docker-registry-environment-variable-override-installation"></a>4.2. Docker registry environment variable override installation</h3>
<div class="paragraph">
<p>Often times it is appropriate to use a simple environment variable override for develop or POC Docker registries. While this approach is usually not recommended for production use, it can be helpful when one requires quick-and-dirty way to stand up a registry. Simply use the <em>Variable Override</em> Format Option from the client details, and an output should appear like the one below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>REGISTRY_AUTH_TOKEN_REALM: http://localhost:8080/realms/master/protocol/docker-v2/auth
REGISTRY_AUTH_TOKEN_SERVICE: docker-test
REGISTRY_AUTH_TOKEN_ISSUER: http://localhost:8080/realms/master</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Don&#8217;t forget to configure the <code>REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE</code> override with the location of the Keycloak realm&#8217;s public key.  The auth configuration will not work without this argument.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="docker-compose-yaml-file"><a class="anchor" href="#docker-compose-yaml-file"></a>4.3. Docker Compose YAML File</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This installation method is meant to be an easy way to get a docker registry authenticating against a Keycloak server.  It is intended for development purposes only and should never be used in a production or production-like environment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The zip file installation mechanism provides a quickstart for developers who want to understand how the Keycloak server can interact with the Docker registry.  In order to configure:</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>From the desired realm, create a client configuration. At this point you will not have a Docker registry - the quickstart will take care of that part.</p>
</li>
<li>
<p>Choose the "Docker Compose YAML" option from the from <em>Action</em> menu and select the <strong>Download adapter config</strong> option to download the ZIP file.</p>
</li>
<li>
<p>Unzip the archive to the desired location, and open the directory.</p>
</li>
<li>
<p>Start the Docker registry with <code>docker-compose up</code></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
it is recommended that you configure the Docker registry client in a realm other than 'master', since the HTTP Basic auth flow will not present forms.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the above configuration has taken place, and the keycloak server and Docker registry are running, docker authentication should be successful:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[user ~]# docker login localhost:5000 -u $username
Password: *******
Login Succeeded</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_client_registration"><a class="anchor" href="#_client_registration"></a>5. Using the client registration service</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/client-registration.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/client-registration.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/client-registration.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>In order for an application or service to utilize Keycloak it has to register a client in Keycloak.
An admin can do this through the admin console (or admin REST endpoints), but clients can also register themselves through the Keycloak client
registration service.</p>
</div>
<div class="paragraph">
<p>The Client Registration Service provides built-in support for Keycloak Client Representations, OpenID Connect Client Meta Data and SAML Entity Descriptors.
The Client Registration Service endpoint is <code>/realms/&lt;realm&gt;/clients-registrations/&lt;provider&gt;</code>.</p>
</div>
<div class="paragraph">
<p>The built-in supported <code>providers</code> are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>default - Keycloak Client Representation (JSON)</p>
</li>
<li>
<p>install - Keycloak Adapter Configuration (JSON)</p>
</li>
<li>
<p>openid-connect - OpenID Connect Client Metadata Description (JSON)</p>
</li>
<li>
<p>saml2-entity-descriptor - SAML Entity Descriptor (XML)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following sections will describe how to use the different providers.</p>
</div>
<div class="sect2">
<h3 id="authentication"><a class="anchor" href="#authentication"></a>5.1. Authentication</h3>
<div class="paragraph">
<p>To invoke the Client Registration Services you usually need a token. The token can be a bearer token, an initial access token or a registration access token.
There is an alternative to register new client without any token as well, but then you need to configure Client Registration Policies (see below).</p>
</div>
<div class="sect3">
<h4 id="bearer-token"><a class="anchor" href="#bearer-token"></a>5.1.1. Bearer token</h4>
<div class="paragraph">
<p>The bearer token can be issued on behalf of a user or a Service Account. The following permissions are required to invoke the endpoints (see <a href="https://www.keycloak.org/docs/25.0.5/server_admin/">Server Administration Guide</a> for more details):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create-client or manage-client - To create clients</p>
</li>
<li>
<p>view-client or manage-client - To view clients</p>
</li>
<li>
<p>manage-client - To update or delete client</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you are using a bearer token to create clients it&#8217;s recommend to use a token from a Service Account with only the <code>create-client</code> role (see <a href="https://www.keycloak.org/docs/25.0.5/server_admin/">Server Administration Guide</a> for more details).</p>
</div>
</div>
<div class="sect3">
<h4 id="_initial_access_token"><a class="anchor" href="#_initial_access_token"></a>5.1.2. Initial Access Token</h4>
<div class="paragraph">
<p>The recommended approach to registering new clients is by using initial access tokens.
An initial access token can only be used to create clients and has a configurable expiration as well as a configurable limit on how many clients can be created.</p>
</div>
<div class="paragraph">
<p>An initial access token can be created through the admin console.
To create a new initial access token first select the realm in the admin console, then click on <code>Client</code> in the menu on the left, followed by
<code>Initial access token</code> in the tabs displayed in the page.</p>
</div>
<div class="paragraph">
<p>You will now be able to see any existing initial access tokens. If you have access you can delete tokens that are no longer required. You can only retrieve the
value of the token when you are creating it. To create a new token click on <code>Create</code>. You can now optionally add how long the token should be valid, also how
many clients can be created using the token. After you click on <code>Save</code> the token value is displayed.</p>
</div>
<div class="paragraph">
<p>It is important that you copy/paste this token now as you won&#8217;t be able to retrieve it later. If you forget to copy/paste it, then delete the token and create another one.</p>
</div>
<div class="paragraph">
<p>The token value is used as a standard bearer token when invoking the Client Registration Services, by adding it to the Authorization header in the request.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Authorization: bearer eyJhbGciOiJSUz...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_registration_access_token"><a class="anchor" href="#_registration_access_token"></a>5.1.3. Registration Access Token</h4>
<div class="paragraph">
<p>When you create a client through the Client Registration Service the response will include a registration access token.
The registration access token provides access to retrieve the client configuration later, but also to update or delete the client.
The registration access token is included with the request in the same way as a bearer token or initial access token.</p>
</div>
<div class="paragraph">
<p>By default, registration access token rotation is enabled. This means a registration access token is only valid once. When the token is used, the response will include a new token. Note that registration access token rotation can be disabled by using <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_client_policies">Client Policies</a>.</p>
</div>
<div class="paragraph">
<p>If a client was created outside of the Client Registration Service it won&#8217;t have a registration access token associated with it.
You can create one through the admin console. This can also be useful if you lose the token for a particular client.
To create a new token find the client in the admin console and click on <code>Credentials</code>. Then click on <code>Generate registration access token</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="keycloak-representations"><a class="anchor" href="#keycloak-representations"></a>5.2. Keycloak Representations</h3>
<div class="paragraph">
<p>The <code>default</code> client registration provider can be used to create, retrieve, update and delete a client.
It uses Keycloak Client Representation format which provides support for configuring clients exactly as they can be configured through the admin
console, including for example configuring protocol mappers.</p>
</div>
<div class="paragraph">
<p>To create a client create a Client Representation (JSON) then perform an HTTP POST request to <code>/realms/&lt;realm&gt;/clients-registrations/default</code>.</p>
</div>
<div class="paragraph">
<p>It will return a Client Representation that also includes the registration access token.
You should save the registration access token somewhere if you want to retrieve the config, update or delete the client later.</p>
</div>
<div class="paragraph">
<p>To retrieve the Client Representation perform an HTTP GET request to <code>/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code>.</p>
</div>
<div class="paragraph">
<p>It will also return a new registration access token.</p>
</div>
<div class="paragraph">
<p>To update the Client Representation perform an HTTP PUT request with the updated Client Representation to:
<code>/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code>.</p>
</div>
<div class="paragraph">
<p>It will also return a new registration access token.</p>
</div>
<div class="paragraph">
<p>To delete the Client Representation perform an HTTP DELETE request to:
<code>/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code></p>
</div>
</div>
<div class="sect2">
<h3 id="keycloak-adapter-configuration"><a class="anchor" href="#keycloak-adapter-configuration"></a>5.3. Keycloak adapter configuration</h3>
<div class="paragraph">
<p>The <code>installation</code> client registration provider can be used to retrieve the adapter configuration for a client.
In addition to token authentication you can also authenticate with client credentials using HTTP basic authentication.
To do this include the following header in the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Authorization: basic BASE64(client-id + ':' + client-secret)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To retrieve the Adapter Configuration then perform an HTTP GET request to <code>/realms/&lt;realm&gt;/clients-registrations/install/&lt;client id&gt;</code>.</p>
</div>
<div class="paragraph">
<p>No authentication is required for public clients.
This means that for the JavaScript adapter you can load the client configuration directly from Keycloak using the above URL.</p>
</div>
</div>
<div class="sect2">
<h3 id="openid-connect-dynamic-client-registration"><a class="anchor" href="#openid-connect-dynamic-client-registration"></a>5.4. OpenID Connect Dynamic Client Registration</h3>
<div class="paragraph">
<p>Keycloak implements <a href="https://openid.net/specs/openid-connect-registration-1_0.html">OpenID Connect Dynamic Client Registration</a>, which extends <a href="https://datatracker.ietf.org/doc/html/rfc7591">OAuth 2.0 Dynamic Client Registration Protocol</a> and <a href="https://datatracker.ietf.org/doc/html/rfc7592">OAuth 2.0 Dynamic Client Registration Management Protocol</a>.</p>
</div>
<div class="paragraph">
<p>The endpoint to use these specifications to register clients in Keycloak is <code>/realms/&lt;realm&gt;/clients-registrations/openid-connect[/&lt;client id&gt;]</code>.</p>
</div>
<div class="paragraph">
<p>This endpoint can also be found in the OpenID Connect Discovery endpoint for the realm, <code>/realms/&lt;realm&gt;/.well-known/openid-configuration</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="saml-entity-descriptors"><a class="anchor" href="#saml-entity-descriptors"></a>5.5. SAML Entity Descriptors</h3>
<div class="paragraph">
<p>The SAML Entity Descriptor endpoint only supports using SAML v2 Entity Descriptors to create clients.
It doesn&#8217;t support retrieving, updating or deleting clients.
For those operations the Keycloak representation endpoints should be used.
When creating a client a Keycloak Client Representation is returned with details about the created client, including a registration access token.</p>
</div>
<div class="paragraph">
<p>To create a client perform an HTTP POST request with the SAML Entity Descriptor to <code>/realms/&lt;realm&gt;/clients-registrations/saml2-entity-descriptor</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-using-curl-2"><a class="anchor" href="#example-using-curl-2"></a>5.6. Example using CURL</h3>
<div class="paragraph">
<p>The following example creates a client with the clientId <code>myclient</code> using CURL. You need to replace <code>eyJhbGciOiJSUz&#8230;&#8203;</code> with a proper initial access token or
bearer token.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d '{ &quot;clientId&quot;: &quot;myclient&quot; }' \
    -H &quot;Content-Type:application/json&quot; \
    -H &quot;Authorization: bearer eyJhbGciOiJSUz...&quot; \
    http://localhost:8080/realms/master/clients-registrations/default</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="example-using-java-client-registration-api"><a class="anchor" href="#example-using-java-client-registration-api"></a>5.7. Example using Java Client Registration API</h3>
<div class="paragraph">
<p>The Client Registration Java API makes it easy to use the Client Registration Service using Java.
To use include the dependency <code>org.keycloak:keycloak-client-registration-api:&gt;VERSION&lt;</code> from Maven.</p>
</div>
<div class="paragraph">
<p>For full instructions on using the Client Registration refer to the JavaDocs.
Below is an example of creating a client. You need to replace <code>eyJhbGciOiJSUz&#8230;&#8203;</code> with a proper initial access token or bearer token.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> token = <span class="string"><span class="delimiter">&quot;</span><span class="content">eyJhbGciOiJSUz...</span><span class="delimiter">&quot;</span></span>;

ClientRepresentation client = <span class="keyword">new</span> ClientRepresentation();
client.setClientId(CLIENT_ID);

ClientRegistration reg = ClientRegistration.create()
    .url(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myrealm</span><span class="delimiter">&quot;</span></span>)
    .build();

reg.auth(Auth.token(token));

client = reg.create(client);

<span class="predefined-type">String</span> registrationAccessToken = client.getRegistrationAccessToken();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_client_registration_policies"><a class="anchor" href="#_client_registration_policies"></a>5.8. Client Registration Policies</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The current plans are for the Client Registration Policies to be removed in favor of the Client Policies described in the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/#_client_policies">Server Administration Guide</a>.
Client Policies are more flexible and support more use cases.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Keycloak currently supports two ways how new clients can be registered through Client Registration Service.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authenticated requests - Request to register new client must contain either <code>Initial Access Token</code> or <code>Bearer Token</code> as mentioned above.</p>
</li>
<li>
<p>Anonymous requests - Request to register new client doesn&#8217;t need to contain any token at all</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Anonymous client registration requests are very interesting and powerful feature, however you usually don&#8217;t want that anyone is able to register new
client without any limitations. Hence we have <code>Client Registration Policy SPI</code>, which provide a way to limit who can register new clients and under which conditions.</p>
</div>
<div class="paragraph">
<p>In Keycloak admin console, you can click to <code>Client Registration</code> tab and then <code>Client Registration Policies</code> sub-tab. Here you will see what policies
are configured by default for anonymous requests and what policies are configured for authenticated requests.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The anonymous requests (requests without any token) are allowed just for creating (registration) of new clients. So when you register
new client through anonymous request, the response will contain Registration Access Token, which must be used for Read, Update or Delete request of particular client.
However using this Registration Access Token from anonymous registration will be then subject to Anonymous Policy too! This means that for example request for update
client also needs to come from Trusted Host if you have <code>Trusted Hosts</code> policy. Also for example it won&#8217;t be allowed to disable <code>Consent Required</code> when updating client and
when <code>Consent Required</code> policy is present etc.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Currently we have these policy implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Trusted Hosts Policy - You can configure list of trusted hosts and trusted domains. Request to Client Registration Service can be sent just from those hosts or domains.
Request sent from some untrusted IP will be rejected. URLs of newly registered client must also use just those trusted hosts or domains. For example it won&#8217;t be allowed
to set <code>Redirect URI</code> of client pointing to some untrusted host. By default, there is not any whitelisted host, so anonymous client registration is de-facto disabled.</p>
</li>
<li>
<p>Consent Required Policy - Newly registered clients will have <code>Consent Allowed</code> switch enabled. So after successful authentication, user will always
see consent screen when he needs to approve permissions (client scopes). It means that client won&#8217;t have access to any personal
info or permission of user unless user approves it.</p>
</li>
<li>
<p>Protocol Mappers Policy - Allows to configure list of whitelisted protocol mapper implementations. New client can&#8217;t be registered
or updated if it contains some non-whitelisted protocol mapper. Note that this policy is used for authenticated requests as well, so
even for authenticated request there are some limitations which protocol mappers can be used.</p>
</li>
<li>
<p>Client Scope Policy - Allow to whitelist <code>Client Scopes</code>, which can be used with newly registered or updated clients.
There are no whitelisted scopes by default; only the client scopes, which are defined as <code>Realm Default Client Scopes</code> are whitelisted by default.</p>
</li>
<li>
<p>Full Scope Policy - Newly registered clients will have <code>Full Scope Allowed</code> switch disabled. This means they won&#8217;t have any scoped
realm roles or client roles of other clients.</p>
</li>
<li>
<p>Max Clients Policy - Rejects registration if current number of clients in the realm is same or bigger than specified limit. It&#8217;s 200 by default for anonymous registrations.</p>
</li>
<li>
<p>Client Disabled Policy - Newly registered client will be disabled. This means that admin needs to manually approve and enable all newly registered clients.
This policy is not used by default even for anonymous registration.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_client_registration_cli"><a class="anchor" href="#_client_registration_cli"></a>6. Automating Client Registration with the CLI</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/client-registration/client-registration-cli.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/client-registration/client-registration-cli.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/client-registration/client-registration-cli.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="paragraph">
<p>The Client Registration CLI is a command-line interface (CLI) tool for application developers to configure new clients in a self-service manner when integrating with Keycloak. It is specifically designed to interact with Keycloak Client Registration REST endpoints.</p>
</div>
<div class="paragraph">
<p>It is necessary to create or obtain a client configuration for any application to be able to use Keycloak. You usually configure a new client for each new application hosted on a unique host name. When an application interacts with Keycloak, the application identifies itself with a client ID so Keycloak can provide a login page, single sign-on (SSO) session management, and other services.</p>
</div>
<div class="paragraph">
<p>You can configure application clients from a command line with the Client Registration CLI, and you can use it in shell scripts.</p>
</div>
<div class="paragraph">
<p>To allow a particular user to use <code>Client Registration CLI</code>, the Keycloak administrator typically uses the Admin Console to configure a new user with proper roles or to configure a new client and client secret to grant access to the Client Registration REST API.</p>
</div>
<div class="sect2">
<h3 id="_configuring_a_user_for_client_registration_cli"><a class="anchor" href="#_configuring_a_user_for_client_registration_cli"></a>6.1. Configuring a new regular user for use with Client Registration CLI</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Log in to the Admin Console (for example, <a href="http://localhost:8080/admin" class="bare">http://localhost:8080/admin</a>) as <code class="command">admin</code>.</p>
</li>
<li>
<p>Select a realm to administer.</p>
</li>
<li>
<p>If you want to use an existing user, select that user to edit; otherwise, create a new user.</p>
</li>
<li>
<p>Select <strong>Role Mapping</strong>, <strong>Assign role</strong>. From the option list, click <strong>Filter by clients</strong>. In the search bar, type <code>manage-clients</code>. Select the role, or if you are in the master realm, select the one with <strong>NAME-realm</strong>, where <code>NAME</code> is the name of the target realm. You can grant access to any other realm to users in the master realm.</p>
</li>
<li>
<p>Click <strong>Assign</strong> to grant a full set of client management permissions. Another option is to choose <strong>view-clients</strong> for read-only or <strong>create-client</strong> to create new clients.</p>
</li>
<li>
<p>Select <strong>Available Roles</strong>, <strong>manage-client</strong> to grant a full set of client management permissions. Another option is to choose <strong>view-clients</strong> for read-only or <strong>create-client</strong> to create new clients.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These permissions grant the user the capability to perform operations without the use of <a href="#_initial_access_token">Initial Access Token</a> or <a href="#_registration_access_token">Registration Access Token</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>It is possible to not assign any <code class="command">realm-management</code> roles to a user. In that case, a user can still log in with the Client Registration CLI but cannot use it without an Initial Access Token. Trying to perform any operations without a token results in a <strong>403 Forbidden</strong> error.</p>
</div>
<div class="paragraph">
<p>The administrator can issue Initial Access Tokens from the Admin Console in the Clients area on the <strong>Initial Access Token</strong> tab.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_a_client_for_use_with_client_registration_cli"><a class="anchor" href="#_configuring_a_client_for_use_with_client_registration_cli"></a>6.2. Configuring a client for use with the Client Registration CLI</h3>
<div class="paragraph">
<p>By default, the server recognizes the Client Registration CLI as the <code class="filename">admin-cli</code> client, which is configured automatically for every new realm. No additional client configuration is necessary when logging in with a user name.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Create a client (for example, <code class="filename">reg-cli</code>) if you want to use a separate client configuration for the Client Registration CLI.</p>
</li>
<li>
<p>Uncheck <strong>Standard Flow Enabled</strong>.</p>
</li>
<li>
<p>Strengthen the security by toggling <strong>Client authentication</strong> to <strong>On</strong>.</p>
</li>
<li>
<p>Choose the type of account that you want to use.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If you want to use a service account associated with the client, check <strong>Service accounts roles</strong>.</p>
</li>
<li>
<p>If you prefer to use a regular user account, check <strong>Direct access grants</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click <strong>Next</strong>.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
<li>
<p>Click the <strong>Credentials</strong> tab.</p>
<div class="paragraph">
<p>Configure either <code class="filename">Client Id and Secret</code> or <code class="filename">Signed JWT</code>.</p>
</div>
</li>
<li>
<p>If you are using service account roles, click the <strong>Service Account Roles</strong> tab.</p>
<div class="paragraph">
<p>Select the roles to configure the access for the service account. For the details on what roles to select, see <a href="#_configuring_a_user_for_client_registration_cli">Configuring a new regular user for use with Client Registration CLI</a>.</p>
</div>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When you run the <code class="command">kcreg config credentials</code>, use the <code class="command">--secret</code> option to supply the configured secret.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specify which <code class="filename">clientId</code> to use (for example, <code class="command">--client reg-cli</code>) when running <code class="command">kcreg config credentials</code>.</p>
</li>
<li>
<p>With the service account enabled, you can omit specifying the user when running <code class="command">kcreg config credentials</code> and only provide the client secret or keystore information.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_installing_client_registration_cli"><a class="anchor" href="#_installing_client_registration_cli"></a>6.3. Installing the Client Registration CLI</h3>
<div class="paragraph">
<p>The Client Registration CLI is packaged inside the Keycloak Server distribution. You can find execution scripts inside the <code class="filename">bin</code> directory. The Linux script is called <code class="filename">kcreg.sh</code>, and the Windows script is called <code class="filename">kcreg.bat</code>.</p>
</div>
<div class="paragraph">
<p>Add the Keycloak server directory to your <code class="filename">PATH</code> when setting up the client for use from any location on the file system.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ export PATH=$PATH:$KEYCLOAK_HOME/bin
$ kcreg.sh</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; set PATH=%PATH%;%KEYCLOAK_HOME%\bin
c:\&gt; kcreg</pre>
</div>
</div>
<div class="paragraph">
<p><code class="filename">KEYCLOAK_HOME</code> refers to a directory where the Keycloak Server distribution was unpacked.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_client_registration_cli"><a class="anchor" href="#_using_client_registration_cli"></a>6.4. Using the Client Registration CLI</h3>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Start an authenticated session by logging in with your credentials.</p>
</li>
<li>
<p>Run commands on the <code class="filename">Client Registration REST</code> endpoint.</p>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh config credentials --server http://localhost:8080 --realm demo --user user --client reg-cli
$ kcreg.sh create -s clientId=my_client -s 'redirectUris=["http://localhost:8980/myapp/*"]'
$ kcreg.sh get my_client</pre>
</div>
</div>
</li>
<li>
<p>Windows:</p>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; kcreg config credentials --server http://localhost:8080 --realm demo --user user --client reg-cli
c:\&gt; kcreg create -s clientId=my_client -s "redirectUris=[\"http://localhost:8980/myapp/*\"]"
c:\&gt; kcreg get my_client</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In a production environment, Keycloak has to be accessed with <code class="filename">https:</code> to avoid exposing tokens to network sniffers.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>If a server&#8217;s certificate is not issued by one of the trusted certificate authorities (CAs) that are included in Java&#8217;s default certificate truststore, prepare a <code class="filename">truststore.jks</code> file and instruct the Client Registration CLI to use it.</p>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh config truststore --trustpass $PASSWORD ~/.keycloak/truststore.jks</pre>
</div>
</div>
</li>
<li>
<p>Windows:</p>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; kcreg config truststore --trustpass %PASSWORD% %HOMEPATH%\.keycloak\truststore.jks</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_logging_in"><a class="anchor" href="#_logging_in"></a>6.4.1. Logging in</h4>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Specify a server endpoint URL and a realm when you log in with the Client Registration CLI.</p>
</li>
<li>
<p>Specify a user name or a client id, which results in a special service account being used. When using a user name, you must use a password for the specified user. When using a client ID, you use a client secret or a <code class="filename">Signed JWT</code> instead of a password.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Regardless of the login method, the account that logs in needs proper permissions to be able to perform client registration operations. Keep in mind that any account in a non-master realm can only have permissions to manage clients within the same realm. If you need to manage different realms, you can either configure multiple users in different realms, or you can create a single user in the <code class="filename">master</code> realm and add roles for managing clients in different realms.</p>
</div>
<div class="paragraph">
<p>You cannot configure users with the Client Registration CLI. Use the Admin Console web interface or the Admin Client CLI to configure users. See <a href="https://www.keycloak.org/docs/25.0.5/server_admin/">Server Administration Guide</a> for more details.</p>
</div>
<div class="paragraph">
<p>When <code class="filename">kcreg</code> successfully logs in, it receives authorization tokens and saves them in a private configuration file so the tokens can be used for subsequent invocations. See <a href="#_working_with_alternative_configurations">Working with alternative configurations</a> for more information on configuration files.</p>
</div>
<div class="paragraph">
<p>See the built-in help for more information on using the Client Registration CLI.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh help</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; kcreg help</pre>
</div>
</div>
<div class="paragraph">
<p>See <code class="filename">kcreg config credentials --help</code> for more information about starting an authenticated session.</p>
</div>
</div>
<div class="sect3">
<h4 id="_working_with_alternative_configurations"><a class="anchor" href="#_working_with_alternative_configurations"></a>6.4.2. Working with alternative configurations</h4>
<div class="paragraph">
<p>By default, the Client Registration CLI automatically maintains a configuration file at a default location, <code class="filename">./.keycloak/kcreg.config</code>, under the user&#8217;s home directory. You can use the <code class="command">--config</code> option to point to a different file or location to maintain multiple authenticated sessions in parallel. It is the safest way to perform operations tied to a single configuration file from a single thread.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not make the configuration file visible to other users on the system. The configuration file contains access tokens and secrets that should be kept private.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You might want to avoid storing secrets inside a configuration file by using the <code class="command">--no-config</code> option with all of your commands, even though it is less convenient and requires more token requests to do so. Specify all authentication information with each <code class="command">kcreg</code> invocation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_initial_access_and_registration_access_tokens"><a class="anchor" href="#_initial_access_and_registration_access_tokens"></a>6.4.3. Initial Access and Registration Access Tokens</h4>
<div class="paragraph">
<p>Developers who do not have an account configured at the Keycloak server they want to use can use the Client Registration CLI. This is possible only when the realm administrator issues a developer an Initial Access Token. It is up to the realm administrator to decide how and when to issue and distribute these tokens. The realm administrator can limit the maximum age of the Initial Access Token and the total number of clients that can be created with it.</p>
</div>
<div class="paragraph">
<p>Once a developer has an Initial Access Token, the developer can use it to create new clients without authenticating with <code class="command">kcreg config credentials</code>. The Initial Access Token can be stored in the configuration file or specified as part of the <code class="command">kcreg create</code> command.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh config initial-token $TOKEN
$ kcreg.sh create -s clientId=myclient</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ kcreg.sh create -s clientId=myclient -t $TOKEN</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>c:\&gt; kcreg config initial-token %TOKEN%
c:\&gt; kcreg create -s clientId=myclient</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">c:\&gt; kcreg create -s clientId=myclient -t %TOKEN%</pre>
</div>
</div>
<div class="paragraph">
<p>When using an Initial Access Token, the server response includes a newly issued Registration Access Token. Any subsequent operation for that client needs to be performed by authenticating with that token, which is only valid for that client.</p>
</div>
<div class="paragraph">
<p>The Client Registration CLI automatically uses its private configuration file to save and use this token with its associated client. As long as the same configuration file is used for all client operations, the developer does not need to authenticate to read, update, or delete a client that was created this way.</p>
</div>
<div class="paragraph">
<p>See <a href="#_client_registration">Client Registration</a> for more information about Initial Access and Registration Access Tokens.</p>
</div>
<div class="paragraph">
<p>Run the <code class="command">kcreg config initial-token --help</code> and <code class="command">kcreg config registration-token --help</code> commands for more information on how to configure tokens with the Client Registration CLI.</p>
</div>
</div>
<div class="sect3">
<h4 id="_performing_crud_operations"><a class="anchor" href="#_performing_crud_operations"></a>6.4.4. Creating a client configuration</h4>
<div class="paragraph">
<p>The first task after authenticating with credentials or configuring an Initial Access Token is usually to create a new client. Often you might want to use a prepared JSON file as a template and set or override some of the attributes.</p>
</div>
<div class="paragraph">
<p>The following example shows how to read a JSON file, override any client id it may contain, set any other attributes, and print the configuration to a standard output after successful creation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh create -f client-template.json -s clientId=myclient -s baseUrl=/myclient -s 'redirectUris=["/myclient/*"]' -o</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>C:\&gt; kcreg create -f client-template.json -s clientId=myclient -s baseUrl=/myclient -s "redirectUris=[\"/myclient/*\"]" -o</pre>
</div>
</div>
<div class="paragraph">
<p>Run the <code class="command">kcreg create --help</code> for more information about the <code class="command">kcreg create</code> command.</p>
</div>
<div class="paragraph">
<p>You can use <code class="command">kcreg attrs</code> to list available attributes. Keep in mind that many configuration attributes are not checked for validity or consistency. It is up to you to specify proper values. Remember that you should not have any id fields in your
template and should not specify them as arguments to the <code class="command">kcreg create</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="retrieving-a-client-configuration"><a class="anchor" href="#retrieving-a-client-configuration"></a>6.4.5. Retrieving a client configuration</h4>
<div class="paragraph">
<p>You can retrieve an existing client by using the <code class="command">kcreg get</code> command.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh get myclient</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>C:\&gt; kcreg get myclient</pre>
</div>
</div>
<div class="paragraph">
<p>You can also retrieve the client configuration as an adapter configuration file, which you can package with your web application.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh get myclient -e install &gt; keycloak.json</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>C:\&gt; kcreg get myclient -e install &gt; keycloak.json</pre>
</div>
</div>
<div class="paragraph">
<p>Run the <code class="command">kcreg get --help</code> command for more information about the <code class="command">kcreg get</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="modifying-a-client-configuration"><a class="anchor" href="#modifying-a-client-configuration"></a>6.4.6. Modifying a client configuration</h4>
<div class="paragraph">
<p>There are two methods for updating a client configuration.</p>
</div>
<div class="paragraph">
<p>One method is to submit a complete new state to the server after getting the current configuration, saving it to a file, editing it, and posting it back to the server.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh get myclient &gt; myclient.json
$ vi myclient.json
$ kcreg.sh update myclient -f myclient.json</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>C:\&gt; kcreg get myclient &gt; myclient.json
C:\&gt; notepad myclient.json
C:\&gt; kcreg update myclient -f myclient.json</pre>
</div>
</div>
<div class="paragraph">
<p>The second method fetches the current client, sets or deletes fields on it, and posts it back in one step.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh update myclient -s enabled=false -d redirectUris</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>C:\&gt; kcreg update myclient -s enabled=false -d redirectUris</pre>
</div>
</div>
<div class="paragraph">
<p>You can also use a file that contains only changes to be applied so you do not have to specify too many values as arguments. In this case, specify <code class="command">--merge</code> to tell the Client Registration CLI that rather than treating the JSON file as a full, new configuration, it should treat it as a set of attributes to be applied over the existing configuration.</p>
</div>
<div class="paragraph">
<p>For example, on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh update myclient --merge -d redirectUris -f mychanges.json</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>C:\&gt; kcreg update myclient --merge -d redirectUris -f mychanges.json</pre>
</div>
</div>
<div class="paragraph">
<p>Run the <code class="command">kcreg update --help</code> command for more information about the <code class="command">kcreg update</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="deleting-a-client-configuration"><a class="anchor" href="#deleting-a-client-configuration"></a>6.4.7. Deleting a client configuration</h4>
<div class="paragraph">
<p>Use the following example to delete a client.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ kcreg.sh delete myclient</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>C:\&gt; kcreg delete myclient</pre>
</div>
</div>
<div class="paragraph">
<p>Run the <code class="command">kcreg delete --help</code> command for more information about the <code class="command">kcreg delete</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_refreshing_invalid_registration_access_tokens"><a class="anchor" href="#_refreshing_invalid_registration_access_tokens"></a>6.4.8. Refreshing invalid Registration Access Tokens</h4>
<div class="paragraph">
<p>When performing a create, read, update, and delete (CRUD) operation using the <code class="command">--no-config</code> mode, the Client Registration CLI cannot handle Registration Access Tokens for you. In that case, it is possible to lose track of the most recently issued Registration Access Token for a client, which makes it impossible to perform any further CRUD operations on that client without authenticating with an account that has <strong>manage-clients</strong> permissions.</p>
</div>
<div class="paragraph">
<p>If you have permissions, you can issue a new Registration Access Token for the client and have it printed to a standard output or saved to a configuration file of your choice. Otherwise, you have to ask the realm administrator to issue a new Registration Access Token for your client and send it to you. You can then pass it to any CRUD command via the <code class="command">--token</code> option. You can also use the <code class="command">kcreg config registration-token</code> command to save the new token in a configuration file and have the Client Registration CLI automatically handle it for you from that point on.</p>
</div>
<div class="paragraph">
<p>Run the <code class="command">kcreg update-token --help</code> command for more information about the <code class="command">kcreg update-token</code> command.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting_2"><a class="anchor" href="#_troubleshooting_2"></a>6.5. Troubleshooting</h3>
<div class="ulist">
<ul>
<li>
<p>Q: When logging in, I get an error: <strong>Parameter client_assertion_type is missing [invalid_client]</strong>.</p>
<div class="paragraph">
<p>A: This error means your client is configured with <code class="filename">Signed JWT</code> token credentials, which means you have to use the <code class="command">--keystore</code> parameter when logging in.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_token-exchange"><a class="anchor" href="#_token-exchange"></a>7. Using token exchange</h2>
<div class="sectionbody">
<div class="sidebarblock page-links">
<div class="content">
<a href="https://github.com/keycloak/keycloak/tree/main/docs/documentation/securing_apps/topics/token-exchange/token-exchange.adoc" target="_blank" rel="noopener">Edit this section</a>
<a href="https://github.com/keycloak/keycloak/issues/new?template=bug.yml&amp;title=Docs:%20securing_apps/topics/token-exchange/token-exchange.adoc&amp;description=%0A%0AFile:%20securing_apps/topics/token-exchange/token-exchange.adoc&amp;version=25.0.5&amp;behaviorExpected=%3C!--%20describe%20what%20you%20want%20to%20see%20in%20the%20docs%20--%3E&amp;behaviorActual=%3C!--%20describe%20what%20is%20currently%20wrong%20or%20missing%20in%20the%20docs%20--%3E&amp;reproducer=%3C!--%20list%20steps%20in%20the%20application%20that%20show%20behavior%20that%20should%20be%20documented%20--%3E" target="_blank" rel="noopener">Report an issue</a>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Token Exchange is
<strong>Preview</strong>
and is not fully supported. This feature is disabled by default.</p>
</div>
<div class="paragraph">
<p>To enable start the server with <code>--features=preview</code>
or <code>--features=token-exchange</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>To use more than the <a href="#_internal-token-to-internal-token-exchange">Internal Token to Internal Token Exchange</a> flow, also enable the <code>admin-fine-grained-authz</code> feature.
For details, see the <a href="https://www.keycloak.org/server/features">Enabling and disabling features</a> guide.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="how-token-exchange-works"><a class="anchor" href="#how-token-exchange-works"></a>7.1. How token exchange works</h3>
<div class="paragraph">
<p>In Keycloak, token exchange is the process of using a set of credentials or token to obtain an entirely different token.
A client may want to invoke on a less trusted application so it may want to downgrade the current token it has.
A client may want to exchange a Keycloak token for a token stored for a linked social provider account.
You may want to trust external tokens minted by other Keycloak realms or foreign IDPs. A client may have a need
to impersonate a user.  Here&#8217;s a short summary of the current capabilities of Keycloak around token exchange.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A client can exchange an existing Keycloak token created for a specific client for a new token targeted to a different client</p>
</li>
<li>
<p>A client can exchange an existing Keycloak token for an external token, i.e. a linked Facebook account</p>
</li>
<li>
<p>A client can exchange an external token for a Keycloak token.</p>
</li>
<li>
<p>A client can impersonate a user</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Token exchange in Keycloak is a very loose implementation of the <a href="https://datatracker.ietf.org/doc/html/rfc8693">OAuth Token Exchange</a> specification at the IETF.
We have extended it a little, ignored some of it, and loosely interpreted other parts of the specification.  It is
a simple grant type invocation on a realm&#8217;s OpenID Connect token endpoint.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/realms/{realm}/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>It accepts form parameters (<code>application/x-www-form-urlencoded</code>) as input and the output depends on the type of token you requested an exchange for.
Token exchange is a client endpoint so requests must provide authentication information for the calling client.
Public clients specify their client identifier as a form parameter.  Confidential clients can also use form parameters
to pass their client id and secret, Basic Auth, or however your admin has configured the client authentication flow in your
realm.</p>
</div>
<div class="sect3">
<h4 id="form-parameters"><a class="anchor" href="#form-parameters"></a>7.1.1. Form parameters</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">client_id</dt>
<dd>
<p><em>REQUIRED MAYBE.</em>  This parameter is required for clients using form parameters for authentication.  If you are using
Basic Auth, a client JWT token, or client cert authentication, then do not specify this parameter.</p>
</dd>
<dt class="hdlist1">client_secret</dt>
<dd>
<p><em>REQUIRED MAYBE</em>.  This parameter is required for clients using form parameters for authentication and using a client secret as a credential.
Do not specify this parameter if client invocations in your realm are authenticated by a different means.</p>
</dd>
<dt class="hdlist1">grant_type</dt>
<dd>
<p><em>REQUIRED.</em>  The value of the parameter must be <code>urn:ietf:params:oauth:grant-type:token-exchange</code>.</p>
</dd>
<dt class="hdlist1">subject_token</dt>
<dd>
<p><em>OPTIONAL.</em>  A security token that represents the identity of the party on behalf of whom the request is being made.  It is required if you are exchanging an existing token for a new one.</p>
</dd>
<dt class="hdlist1">subject_issuer</dt>
<dd>
<p><em>OPTIONAL.</em> Identifies the issuer of the <code>subject_token</code>.  It can be left blank if the token comes from the current realm or if the issuer
can be determined from the <code>subject_token_type</code>.  Otherwise it is required to be specified. Valid values are the alias of an <code>Identity Provider</code> configured for your realm.  Or an issuer claim identifier
configured by a specific <code>Identity Provider</code>.</p>
</dd>
<dt class="hdlist1">subject_token_type</dt>
<dd>
<p><em>OPTIONAL.</em>  This parameter is the type of the token passed with the <code>subject_token</code> parameter.  This defaults
to <code>urn:ietf:params:oauth:token-type:access_token</code> if the <code>subject_token</code> comes from the realm and is an access token.
If it is an external token, this parameter may or may not have to be specified depending on the requirements of the
<code>subject_issuer</code>.</p>
</dd>
<dt class="hdlist1">requested_token_type</dt>
<dd>
<p><em>OPTIONAL.</em> This parameter represents the type of token the client wants to exchange for.  Currently only oauth
and OpenID Connect token types are supported.  The default value for this depends on whether it
is <code>urn:ietf:params:oauth:token-type:refresh_token</code> in which case you will be returned both an access token and refresh
token within the response.  Other appropriate values are <code>urn:ietf:params:oauth:token-type:access_token</code> and <code>urn:ietf:params:oauth:token-type:id_token</code></p>
</dd>
<dt class="hdlist1">audience</dt>
<dd>
<p><em>OPTIONAL.</em>  This parameter specifies the target client you want the new token minted for.</p>
</dd>
<dt class="hdlist1">requested_issuer</dt>
<dd>
<p><em>OPTIONAL.</em>  This parameter specifies that the client wants a token minted by an external provider.  It must
be the alias of an <code>Identity Provider</code> configured within the realm.</p>
</dd>
<dt class="hdlist1">requested_subject</dt>
<dd>
<p><em>OPTIONAL.</em> This specifies a username or user id if your client wants to impersonate a different user.</p>
</dd>
<dt class="hdlist1">scope</dt>
<dd>
<p><em>OPTIONAL.</em> This parameter represents the target set of OAuth and OpenID Connect scopes the client
is requesting. Returned scope is the Cartesian product of scope parameter and access token scope.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We currently only support OpenID Connect and OAuth exchanges.  Support for SAML based clients and identity providers may be added in the future depending on user demand.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="responses-from-a-token-exchange-request"><a class="anchor" href="#responses-from-a-token-exchange-request"></a>7.1.2. Responses from a token exchange request</h4>
<div class="paragraph">
<p>A successful response from an exchange invocation will return the HTTP 200 response code with a content type that
depends on the <code>requested-token-type</code> and <code>requested_issuer</code> the client asks for.  OAuth requested token types will return
a JSON document as described in the <a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-token-exchange-16">OAuth Token Exchange</a> specification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">.....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">refresh_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">.....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">expires_in</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Clients requesting a refresh token will get back both an access and refresh token in the response.  Clients requesting only
access token type will only get an access token in the response.  Expiration information may or may not be included for
clients requesting an external issuer through the <code>requested_issuer</code> parameter.</p>
</div>
<div class="paragraph">
<p>Error responses generally fall under the 400 HTTP response code category, but other error status codes may be returned
depending on the severity of the error.  Error responses may include content depending on the <code>requested_issuer</code>.
OAuth based exchanges may return a JSON document as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>
   <span class="key"><span class="delimiter">&quot;</span><span class="content">error_description</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additional error claims may be returned depending on the exchange type.  For example, OAuth Identity Providers may include
an additional <code>account-link-url</code> claim if the user does not have a link to an identity provider.  This link can be used
for a client initiated link request.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Token exchange setup requires knowledge of fine grain admin permissions (See the <a href="https://www.keycloak.org/docs/25.0.5/server_admin/">Server Administration Guide</a> for more information).  You will need to grant clients
      permission to exchange.  This is discussed more later in this chapter.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The rest of this chapter discusses the setup requirements and provides examples for different exchange scenarios.
For simplicity&#8217;s sake, let&#8217;s call a token minted by the current realm as an <em>internal</em> token and a token minted by
an external realm or identity provider as an <em>external</em> token.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_internal-token-to-internal-token-exchange"><a class="anchor" href="#_internal-token-to-internal-token-exchange"></a>7.2. Internal token to internal token exchange</h3>
<div class="paragraph">
<p>With an internal token to token exchange you have an existing token minted to a specific client and you want to exchange
this token for a new one minted for a different target client.  Why would you want to do this?  This generally happens
when a client has a token minted for itself, and needs to make additional requests to other applications that require different
claims and permissions within the access token.  Other reasons this type of exchange might be required is if you
need to perform a "permission downgrade" where your app needs to invoke on a less trusted app and you don&#8217;t want
to propagate your current access token.</p>
</div>
<div class="sect3">
<h4 id="_client_to_client_permission"><a class="anchor" href="#_client_to_client_permission"></a>7.2.1. Granting permission for the exchange</h4>
<div class="paragraph">
<p>Clients that want to exchange tokens for a different client need to be authorized in the Admin Console.
You need to define a <code>token-exchange</code> fine grain permission in the target client you want permission to exchange to.</p>
</div>
<div class="paragraph">
<div class="title">Target Client Permission</div>
<p><span class="image"><img src="./images/exchange-target-client-permission-unset.png" alt="Target Client Permission"></span></p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Toggle <strong>Permissions Enabled</strong> to <strong>On</strong>.</p>
<div class="paragraph">
<div class="title">Target Client Permission</div>
<p><span class="image"><img src="./images/exchange-target-client-permission-set.png" alt="Target Client Exchange Permission Set"></span></p>
</div>
<div class="paragraph">
<p>That page displays a <strong>token-exchange</strong> link.</p>
</div>
</li>
<li>
<p>Click that link to start defining the permission.</p>
<div class="paragraph">
<p>This setup page displays.</p>
</div>
<div class="paragraph">
<div class="title">Target Client Exchange Permission Setup</div>
<p><span class="image"><img src="./images/exchange-target-client-permission-setup.png" alt="Target Client Exchange Permission Setup"></span></p>
</div>
</li>
<li>
<p>Click <strong>Client details</strong> in the breadcrumbs at the top of the screen.</p>
</li>
<li>
<p>Define a policy for this permission.</p>
</li>
<li>
<p>Click <strong>Authorization</strong> in the breadcrumbs at the top of the screen.</p>
</li>
<li>
<p>Define a policy for this permission.</p>
</li>
<li>
<p>Click the <strong>Policies</strong> tab.</p>
</li>
<li>
<p>Create a <strong>Client</strong> Policy by clicking <strong>Create policy</strong> button.</p>
<div class="paragraph">
<div class="title">Client Policy Creation</div>
<p><span class="image"><img src="./images/exchange-target-client-policy.png" alt="Client Policy Creation"></span></p>
</div>
</li>
<li>
<p>Enter in the starting client that is the authenticated client that is requesting a token exchange.</p>
</li>
<li>
<p>After you create this policy, go back to the target client&#8217;s <strong>token-exchange</strong> permission and add the client policy you just defined.</p>
<div class="paragraph">
<div class="title">Apply Client Policy</div>
<p><span class="image"><img src="./images/exchange-target-client-exchange-apply-policy.png" alt="Apply Client Policy"></span></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Your client now has permission to invoke.  If you do not do this correctly, you will get a 403 Forbidden response if you
try to make an exchange.</p>
</div>
</div>
<div class="sect3">
<h4 id="_internal_internal_making_request"><a class="anchor" href="#_internal_internal_making_request"></a>7.2.2. Making the request</h4>
<div class="paragraph">
<p>When your client is exchanging an existing token for a token targeting another client, you use the <code>audience</code> parameter.
This parameter must be the client identifier for the target client that you configured in the Admin Console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=the client secret&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:refresh_token&quot; \
    -d &quot;audience=target-client&quot; \
    http://localhost:8080/realms/myrealm/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>subject_token</code> parameter must be an access token for the target realm.  If your <code>requested_token_type</code> parameter
is a refresh token type, then the response will contain both an access token, refresh token, and expiration.  Here&#8217;s
an example JSON response you get back from this call.</p>
</div>
<div class="paragraph">
<p>When the <code>audience</code> parameter is not set, the value of the parameter defaults to the client making the token exchange request.</p>
</div>
<div class="paragraph">
<p>Unlike with confidential clients, public clients are not allowed to perform token exchanges using tokens from other clients.
If you are passing a <code>subject_token</code>, the (confidential) client that was issued the token should either match the client making the request or, if issued to a different client,
the client making the request should be among the audiences set to the token.</p>
</div>
<div class="paragraph">
<p>If you are explicitly setting a target <code>audience</code> (with a client different from the client making the request), you should also make sure that the <code>token-exchange</code> scope permission is configured for the client set to the <code>audience</code> parameter to allow
the client making the request to successfully complete the exchange.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">refresh_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">expires_in</span><span class="delimiter">&quot;</span></span> : <span class="integer">3600</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="internal-token-to-external-token-exchange"><a class="anchor" href="#internal-token-to-external-token-exchange"></a>7.3. Internal token to external token exchange</h3>
<div class="paragraph">
<p>You can exchange a realm token for an external token minted by an external identity provider.  This external identity provider
must be configured within the <code>Identity Provider</code> section of the Admin Console.  Currently only OAuth/OpenID Connect based external
identity providers are supported, this includes all social providers.  Keycloak does not perform a backchannel exchange to the external provider.  So if the account
is not linked, you will not be able to get the external token.  To be able to obtain an external token one of
these conditions must be met:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The user must have logged in with the external identity provider at least once</p>
</li>
<li>
<p>The user must have linked with the external identity provider through the User Account Service</p>
</li>
<li>
<p>The user account was linked through the external identity provider using <a href="https://www.keycloak.org/docs/25.0.5/server_development/">Client Initiated Account Linking</a> API.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, the external identity provider must have been configured to store tokens, or, one of the above actions must
have been performed with the same user session as the internal token you are exchanging.</p>
</div>
<div class="paragraph">
<p>If the account is not linked, the exchange response will contain a link you can use to establish it.  This is
discussed more in the <a href="#_internal_external_making_request">Making the Request</a> section.</p>
</div>
<div class="sect3">
<h4 id="_grant_permission_external_exchange"><a class="anchor" href="#_grant_permission_external_exchange"></a>7.3.1. Granting permission for the exchange</h4>
<div class="paragraph">
<p>Internal to external token exchange requests will be denied with a 403, Forbidden response until you grant permission for the calling client to exchange tokens with the external identity provider.  To grant permission to the client, you go to the identity provider&#8217;s configuration page to the <strong>Permissions</strong> tab.</p>
</div>
<div class="paragraph">
<div class="title">Identity Provider Permission</div>
<p><span class="image"><img src="./images/exchange-idp-permission-unset.png" alt="Identity Provider Exchange Permission"></span></p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Toggle <strong>Permissions Enabled</strong> to <strong>On</strong>.</p>
<div class="paragraph">
<div class="title">Identity Provider Permission</div>
<p><span class="image"><img src="./images/exchange-idp-permission-set.png" alt="Identity Provider Exchange Permission Set"></span></p>
</div>
<div class="paragraph">
<p>The page displays <strong>token-exchange</strong> link.</p>
</div>
</li>
<li>
<p>Click the link to start defining the permission.</p>
<div class="paragraph">
<p>This setup page appears.</p>
</div>
<div class="paragraph">
<div class="title">Identity Provider Exchange Permission Setup</div>
<p><span class="image"><img src="./images/exchange-idp-permission-setup.png" alt="Identity Provider Exchange Permission Setup"></span></p>
</div>
</li>
<li>
<p>Click <strong>Client details</strong> in the breadcrumbs at the top of the screen.</p>
</li>
<li>
<p>Click <strong>Policies</strong> tab to create a client policy.</p>
<div class="paragraph">
<div class="title">Client Policy Creation</div>
<p><span class="image"><img src="./images/exchange-idp-client-policy.png" alt="Client Policy Creation"></span></p>
</div>
</li>
<li>
<p>Enter the starting client that is the authenticated client that is requesting a token exchange.</p>
</li>
<li>
<p>Return to the identity provider&#8217;s <strong>token-exchange</strong> permission and add the client policy you just defined.</p>
<div class="paragraph">
<div class="title">Apply Client Policy</div>
<p><span class="image"><img src="./images/exchange-idp-apply-policy.png" alt="Apply Client Policy"></span></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Your client now has permission to invoke.  If you do not do this correctly, you will get a 403 Forbidden response if you try to make an exchange.</p>
</div>
</div>
<div class="sect3">
<h4 id="_internal_external_making_request"><a class="anchor" href="#_internal_external_making_request"></a>7.3.2. Making the request</h4>
<div class="paragraph">
<p>When your client is exchanging an existing internal token to an external one, you provide the <code>requested_issuer</code> parameter.  The parameter must be the alias of a configured identity provider.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=the client secret&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:access_token&quot; \
    -d &quot;requested_issuer=google&quot; \
    http://localhost:8080/realms/myrealm/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>subject_token</code> parameter must be an access token for the target realm.  The <code>requested_token_type</code> parameter
must be <code>urn:ietf:params:oauth:token-type:access_token</code> or left blank.  No other requested token type is supported
at this time.  Here&#8217;s
an example successful JSON response you get back from this call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">expires_in</span><span class="delimiter">&quot;</span></span> : <span class="integer">3600</span>
   <span class="key"><span class="delimiter">&quot;</span><span class="content">account-link-url</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">https://....</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the external identity provider is not linked for whatever reason, you will get an HTTP 400 response code with
this JSON document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">error_description</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>
   <span class="key"><span class="delimiter">&quot;</span><span class="content">account-link-url</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">https://....</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>error</code> claim will be either <code>token_expired</code> or <code>not_linked</code>.  The <code>account-link-url</code> claim is provided
so that the client can perform <a href="https://www.keycloak.org/docs/25.0.5/server_development/">Client Initiated Account Linking</a>.  Most, if not all,
providers require linking through browser OAuth protocol.  With the <code>account-link-url</code> just add a <code>redirect_uri</code>
query parameter to it and you can forward browsers to perform the link.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="external-token-to-internal-token-exchange"><a class="anchor" href="#external-token-to-internal-token-exchange"></a>7.4. External token to internal token exchange</h3>
<div class="paragraph">
<p>You can trust and exchange external tokens minted by external identity providers for internal tokens.  This can be
used to bridge between realms or just to trust tokens from your social provider.  It works similarly to an identity provider
browser login in that a new user is imported into your realm if it doesn&#8217;t exist.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The current limitation on external token exchanges is that if the external token maps to an existing user an
       exchange will not be allowed unless the existing user already has an account link to the external identity
       provider.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the exchange is complete, a user session will be created within the realm, and you will receive an access
and or refresh token depending on the <code>requested_token_type</code> parameter value.  You should note that this new
user session will remain active until it times out or until you call the logout endpoint of the realm passing this
new access token.</p>
</div>
<div class="paragraph">
<p>These types of changes required a configured identity provider in the Admin Console.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
SAML identity providers are not supported at this time.  Twitter tokens cannot be exchanged either.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="granting-permission-for-the-exchange"><a class="anchor" href="#granting-permission-for-the-exchange"></a>7.4.1. Granting permission for the exchange</h4>
<div class="paragraph">
<p>Before external token exchanges can be done, you grant permission for the calling client to make the exchange.  This
permission is granted in the same manner as <a href="#_grant_permission_external_exchange">internal to external permission is granted</a>.</p>
</div>
<div class="paragraph">
<p>If you also provide an <code>audience</code> parameter whose value points to a different client other than the calling one, you
must also grant the calling client permission to exchange to the target client specific in the <code>audience</code> parameter.  How
to do this is <a href="#_client_to_client_permission">discussed earlier</a> in this section.</p>
</div>
</div>
<div class="sect3">
<h4 id="making-the-request"><a class="anchor" href="#making-the-request"></a>7.4.2. Making the request</h4>
<div class="paragraph">
<p>The <code>subject_token_type</code> must either be <code>urn:ietf:params:oauth:token-type:access_token</code> or <code>urn:ietf:params:oauth:token-type:jwt</code>.
If the type is <code>urn:ietf:params:oauth:token-type:access_token</code> you specify the <code>subject_issuer</code> parameter and it must be the
alias of the configured identity provider.  If the type is <code>urn:ietf:params:oauth:token-type:jwt</code>, the provider will be matched via
the <code>iss</code> (issuer) claim within the JWT which must be the alias of the provider, or a registered issuer within the providers configuration.</p>
</div>
<div class="paragraph">
<p>For validation, if the token is an access token, the provider&#8217;s user info service will be invoked to validate the token.  A successful call
will mean that the access token is valid.  If the subject token is a JWT and if the provider has signature validation enabled, that will be attempted,
otherwise, it will default to also invoking on the user info service to validate the token.</p>
</div>
<div class="paragraph">
<p>By default, the internal token minted will use the calling client to determine what&#8217;s in the token using the protocol
mappers defined for the calling client.  Alternatively, you can specify a different target client using the <code>audience</code>
parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=the client secret&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    -d &quot;subject_issuer=myOidcProvider&quot; \
    --data-urlencode &quot;subject_token_type=urn:ietf:params:oauth:token-type:access_token&quot; \
    -d &quot;audience=target-client&quot; \
    http://localhost:8080/realms/myrealm/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your <code>requested_token_type</code> parameter
is a refresh token type, then the response will contain both an access token, refresh token, and expiration.  Here&#8217;s
an example JSON response you get back from this call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">refresh_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">expires_in</span><span class="delimiter">&quot;</span></span> : <span class="integer">3600</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="impersonation"><a class="anchor" href="#impersonation"></a>7.5. Impersonation</h3>
<div class="paragraph">
<p>For internal and external token exchanges, the client can request on behalf of a user to impersonate a different user.
For example, you may have an admin application that needs to impersonate a user so that a support engineer can debug
a problem.</p>
</div>
<div class="sect3">
<h4 id="granting-permission-for-the-exchange-2"><a class="anchor" href="#granting-permission-for-the-exchange-2"></a>7.5.1. Granting permission for the exchange</h4>
<div class="paragraph">
<p>The user that the subject token represents must have permission to impersonate other users.  See the
<a href="https://www.keycloak.org/docs/25.0.5/server_admin/">Server Administration Guide</a> on how to enable this permission.  It can be done through a role or through
fine grain admin permissions.</p>
</div>
</div>
<div class="sect3">
<h4 id="making-the-request-2"><a class="anchor" href="#making-the-request-2"></a>7.5.2. Making the request</h4>
<div class="paragraph">
<p>Make the request as described in other chapters except additionally specify the <code>requested_subject</code> parameter.  The
value of this parameter must be a username or user id.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=the client secret&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:access_token&quot; \
    -d &quot;audience=target-client&quot; \
    -d &quot;requested_subject=wburke&quot; \
    http://localhost:8080/realms/myrealm/protocol/openid-connect/token</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="direct-naked-impersonation"><a class="anchor" href="#direct-naked-impersonation"></a>7.6. Direct Naked Impersonation</h3>
<div class="paragraph">
<p>You can make an internal token exchange request without providing a <code>subject_token</code>.  This is called a direct
naked impersonation because it places a lot of trust in a client as that client can impersonate any user in the realm.
You might need this to bridge for applications where it is impossible to obtain a subject token to exchange.  For example,
you may be integrating a legacy application that performs login directly with LDAP.  In that case, the legacy app
is able to authenticate users itself, but not able to obtain a token.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It is very risky to enable direct naked impersonation for a client.  If the client&#8217;s credentials are ever
         stolen, that client can impersonate any user in the system.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="granting-permission-for-the-exchange-3"><a class="anchor" href="#granting-permission-for-the-exchange-3"></a>7.6.1. Granting permission for the exchange</h4>
<div class="paragraph">
<p>If the <code>audience</code> parameter is provided, then the calling client must have permission to exchange to the client.  How
to set this up is discussed earlier in this chapter.</p>
</div>
<div class="paragraph">
<p>Additionally, the calling client must be granted permission to impersonate users.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Click <strong>Users</strong> in the menu.</p>
</li>
<li>
<p>Click the <strong>Permissions</strong> tab.</p>
<div class="paragraph">
<div class="title">User Permissions</div>
<p><span class="image"><img src="./images/exchange-users-permission-unset.png" alt="User Permissions"></span></p>
</div>
</li>
<li>
<p>Toggle <strong>Permissions Enabled</strong> to <strong>On</strong>.</p>
<div class="paragraph">
<div class="title">Identity Provider Permission</div>
<p><span class="image"><img src="./images/exchange-users-permission-set.png" alt="Users Impersonation Permission Set"></span></p>
</div>
<div class="paragraph">
<p>The page displays an <strong>impersonate</strong> link.</p>
</div>
</li>
<li>
<p>Click that link to start defining the permission.</p>
<div class="paragraph">
<p>This setup page displays.</p>
</div>
<div class="paragraph">
<div class="title">Users Impersonation Permission Setup</div>
<p><span class="image"><img src="./images/exchange-users-permission-setup.png" alt="Users Impersonation Permission Setup"></span></p>
</div>
</li>
<li>
<p>Click <strong>Client details</strong> in the breadcrumbs at the top of the screen.</p>
</li>
<li>
<p>Define a policy for this permission.</p>
</li>
<li>
<p>Go to the <strong>Policies</strong> tab and create a client policy.</p>
<div class="paragraph">
<div class="title">Client Policy Creation</div>
<p><span class="image"><img src="./images/exchange-users-client-policy.png" alt="Client Policy Creation"></span></p>
</div>
</li>
<li>
<p>Enter the starting client that is the authenticated client that is requesting a token exchange.</p>
</li>
<li>
<p>Return to the users' <strong>impersonation</strong> permission and add the client policy you just
defined.</p>
<div class="paragraph">
<div class="title">Apply Client Policy</div>
<p><span class="image"><img src="./images/exchange-users-apply-policy.png" alt="Apply Client Policy"></span></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Your client now has permission to impersonate users.  If you do not do this correctly, you will get a 403 Forbidden response if you
try to make this type of exchange.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Public clients are not allowed to do direct naked impersonations.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="making-the-request-3"><a class="anchor" href="#making-the-request-3"></a>7.6.2. Making the request</h4>
<div class="paragraph">
<p>To make the request, simply specify the <code>requested_subject</code> parameter.  This must be the username or user id of
a valid user.  You can also specify an <code>audience</code> parameter if you wish.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=the client secret&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;requested_subject=wburke&quot; \
    http://localhost:8080/realms/myrealm/protocol/openid-connect/token</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="expand-permission-model-with-service-accounts"><a class="anchor" href="#expand-permission-model-with-service-accounts"></a>7.7. Expand permission model with service accounts</h3>
<div class="paragraph">
<p>When granting clients permission to exchange, you don&#8217;t necessarily  manually enable those permissions for each and every client.
If the client has a service account associated with it, you can use a role to group permissions together and assign exchange permissions
by assigning a role to the client&#8217;s service account.  For example, you might define a <code>naked-exchange</code> role and any service account that has that
role can do a naked exchange.</p>
</div>
</div>
<div class="sect2">
<h3 id="exchange-vulnerabilities"><a class="anchor" href="#exchange-vulnerabilities"></a>7.8. Exchange vulnerabilities</h3>
<div class="paragraph">
<p>When you start allowing token exchanges, there are various things you have to both be aware of and careful of.</p>
</div>
<div class="paragraph">
<p>The first is public clients.  Public clients do not have or require a client credential in order to perform an exchange.  Anybody that has a valid
token will be able to <em>impersonate</em> the public client and perform the exchanges that public client is allowed to perform.  If there
are any untrustworthy clients that are managed by your realm, public clients may open up vulnerabilities in your permission models.
This is why direct naked exchanges do not allow public clients and will abort with an error if the calling client is public.</p>
</div>
<div class="paragraph">
<p>It is possible to exchange social tokens provided by Facebook, Google, etc. for a realm token.  Be careful and vigilante on what
the exchange token is allowed to do as it&#8217;s not hard to create fake accounts on these social websites.  Use default roles, groups, and identity provider mappers to control what attributes and roles
are assigned to the external social user.</p>
</div>
<div class="paragraph">
<p>Direct naked exchanges are quite dangerous.  You are putting a lot of trust in the calling client that it will never leak out
its client credentials.  If those credentials are leaked, then the thief can impersonate anybody in your system.  This is in direct
contrast to confidential clients that have existing tokens.  You have two factors of authentication, the access token and the client
credentials, and you&#8217;re only dealing with one user.  So use direct naked exchanges sparingly.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-09-10 05:07:39 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.js"></script>

<script>
    const oldtoc = document.getElementById('toctitle').nextElementSibling;
    const newtoc = document.createElement('div');
    newtoc.setAttribute('id', 'tocbot');
    newtoc.setAttribute('class', 'js-toc');
    oldtoc.parentNode.replaceChild(newtoc, oldtoc);
    tocbot.init({ contentSelector: '#content',
        headingSelector: 'h2, h3, h4',
        smoothScroll: false
    });
    const handleTocOnResize = function() {
        const width = window.innerWidth
                    || document.documentElement.clientWidth
                    || document.body.clientWidth;
        if (width < 768) {
            tocbot.refresh({
                contentSelector: '#content',
                headingSelector: 'h2, h3, h4',
                collapseDepth: 6,
                activeLinkClass: 'ignoreactive',
                throttleTimeout: 1000,
                smoothScroll: false
            });
        }
        else {
            tocbot.refresh({
                contentSelector: '#content',
                headingSelector: 'h2, h3, h4',
                smoothScroll: false
            });
        }
    };
    window.addEventListener('resize', handleTocOnResize);
    handleTocOnResize();
</script>
</body>
</html>