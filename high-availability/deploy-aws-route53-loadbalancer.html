
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Deploy an AWS Route 53 loadbalancer - Keycloak</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Keycloak is an open source identity and access management solution">
    <meta name="author" content="Keycloak Team">
    <meta name="keywords" content="sso,idm,openid connect,saml,kerberos,ldap">

    

    

    <link href="https://www.keycloak.org/resources/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://www.keycloak.org/resources/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="https://www.keycloak.org/resources/css/keycloak.css" rel="stylesheet">

    <link rel="shortcut icon" href="https://www.keycloak.org/resources/favicon.ico">

    <script src="https://www.keycloak.org/resources/js/ga.js" type="text/javascript"></script>
    <script src="https://www.keycloak.org/resources/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="https://www.keycloak.org/resources/tocbot/dist/tocbot.min.js" type="text/javascript"></script>
</head>
<body>

<header class="navbar navbar-expand-md bg-light shadow-sm">
<nav class="container-xxl flex-wrap flex-md-no-wrap navbar-light">
    <a class="navbar-brand me-5" href="https://www.keycloak.org/">
        <img class="img-fluid" src="https://www.keycloak.org/resources/images/logo.svg" width="240" alt="Keycloak"/>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="fa fa-bars fa-lg px-1 py-2"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav flex-row flex-wrap bd-navbar-nav pt-2 py-md-0">
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/guides">Guides</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/documentation">Docs</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/downloads">Downloads</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/community">Community</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/blog">Blog</a>
        </li>
      </ul>
    </div>
</nav>
</header>


<div class="container mt-5 kc-article">
    <div class="row">
        <div class="col-md-9 col-xl-10 col-sm-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="https://www.keycloak.org/guides">Guides</a></li>
                    <li class="breadcrumb-item"><a href="https://www.keycloak.org/guides#high-availability">High availability</a></li>
                    <li class="breadcrumb-item active">Deploy an AWS Route 53 loadbalancer</li>
                </ol>
            </nav>

            <div class="mb-4">
                <h1>Deploy an AWS Route 53 loadbalancer</h1>
                    <span class="text-muted">Building block for a loadbalancer</span>
            </div>



            <div class="kc-asciidoc" id="guide-body">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This guide is describing a feature which is currently in preview. Please provide your feedback while weâ€™re continuing to work on this.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This topic describes the procedure required to configure DNS based failover for Multi-AZ Keycloak clusters using AWS Route53 for an active/passive setup. These instructions are intended for used with the setup described in the <a href="https://www.keycloak.org/high-availability/concepts-active-passive-sync">Concepts for active-passive deployments</a> guide.
Use it together with the other building blocks outlined in the <a href="https://www.keycloak.org/high-availability/bblocks-active-passive-sync">Building blocks active-passive deployments</a> guide.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We provide these blueprints to show a minimal functionally complete example with a good baseline performance for regular installations.
You would still need to adapt it to your environment and your organization&#8217;s standards and security best practices.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture">Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All Keycloak client requests are routed by a DNS name managed by Route53 records.
Route53 is responsibile to ensure that all client requests are routed to the Primary cluster when it is available and healthy, or to the backup cluster in the event of the primary availability-zone or Keycloak deployment failing.</p>
</div>
<div class="paragraph">
<p>If the primary site fails, the DNS changes will need to propagate to the clients.
Depending on the client&#8217;s settings, the propagation may take some minutes based on the client&#8217;s configuration.
When using mobile connections, some internet providers might not respect the TTL of the DNS entries, which can lead to an extended time before the clients can connect to the new site.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://www.keycloak.org/resources/images/guides/high-availability/route53-multi-az-failover.svg" alt="route53 multi az failover">
</div>
<div class="title">Figure 1. AWS Global Accelerator Failover</div>
</div>
<div class="paragraph">
<p>Two Openshift Routes are exposed on both the Primary and Backup ROSA cluster.
The first Route uses the Route53 DNS name to service client requests, whereas the second Route is used by Route53 to monitor the health of the Keycloak cluster.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites">Prerequisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Deployment of Keycloak as described in <a href="https://www.keycloak.org/high-availability/deploy-keycloak-kubernetes">Deploy Keycloak for HA with the Keycloak Operator</a> on a ROSA cluster in two AWS availability zones in AWS one region</p>
</li>
<li>
<p>An owned domain for client requests to be routed through</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_procedure">Procedure</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a id="create-hosted-zone"></a>Create a <a href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/CreatingHostedZone.html">Route53 Hosted Zone</a> using the root domain name through which you want all Keycloak clients to connect.</p>
<div class="paragraph">
<p>Take note of the "Hosted zone ID", because this ID is required in later steps.</p>
</div>
</li>
<li>
<p>Retrieve the "Hosted zone ID" and DNS name associated with each ROSA cluster.</p>
<div class="paragraph">
<p>For both the Primary and Backup cluster, perform the following steps:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Log in to the ROSA cluster.</p>
</li>
<li>
<p>Obtain the cluster VPC ID.</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">NODE=$(kubectl get nodes --selector=node-role.kubernetes.io/worker \
  -o jsonpath='{.items[0].metadata.name}'
)
aws ec2 describe-instances \
--filters "Name=private-dns-name,Values=${NODE}" \
--query 'Reservations[*].Instances[*].VpcId' \
--region eu-west-1 \<i class="conum" data-value="1"></i><b>(1)</b>
--output text</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The AWS region hosting your ROSA cluster</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code>vpc-08572eedcb77c9f87</code></pre>
</div>
</div>
</li>
<li>
<p><a id="hosted_zone_id"></a>Retrieve the cluster LoadBalancer Hosted Zone ID and DNS hostname</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws elb describe-load-balancers \
  --query "LoadBalancerDescriptions[?VPCId=='vpc-08572eedcb77c9f87'].{CanonicalHostedZoneNameID:CanonicalHostedZoneNameID,DNSName:DNSName}" \<i class="conum" data-value="1"></i><b>(1)</b>
  --region eu-west-1 \
  --output json</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Utilise the VPC ID retrieved in the previous step</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">[
    {
        "CanonicalHostedZoneNameID": "Z32O12XQLNTSW2", <i class="conum" data-value="1"></i><b>(1)</b>
        "DNSName": "ab50395cd04304a539af5b8854325e22-773464857.eu-west-1.elb.amazonaws.com"
    }
]</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create Route53 health checks</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">function createHealthCheck() {
  # Creating a hash of the caller reference to allow for names longer than 64 characters
  REF=($(echo $1 | sha1sum ))
  aws route53 create-health-check \
  --caller-reference "$REF" \
  --query "HealthCheck.Id" \
  --no-cli-pager \
  --output text \
  --health-check-config '
  {
    "Type": "HTTPS",
    "ResourcePath": "/health/live",
    "FullyQualifiedDomainName": "'$1'",
    "Port": 443,
    "RequestInterval": 30,
    "FailureThreshold": 1,
    "EnableSNI": true
  }
  '
}
CLIENT_DOMAIN="client.keycloak-benchmark.com" <i class="conum" data-value="1"></i><b>(1)</b>
PRIMARY_DOMAIN="primary.${CLIENT_DOMAIN}" <i class="conum" data-value="2"></i><b>(2)</b>
BACKUP_DOMAIN="backup.${CLIENT_DOMAIN}" <i class="conum" data-value="3"></i><b>(3)</b>
createHealthCheck ${PRIMARY_DOMAIN}
createHealthCheck ${BACKUP_DOMAIN}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The domain which Keycloak clients should connect to.
This should be the same, or a subdomain, of the root domain used to create the <a href="#create-hosted-zone">Hosted Zone</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The subdomain that will be used for health probes on the Primary cluster</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The subdomain that will be used for health probes on the Backup cluster</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">233e180f-f023-45a3-954e-415303f21eab <i class="conum" data-value="1"></i><b>(1)</b>
799e2cbb-43ae-4848-9b72-0d9173f04912 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The ID of the Primary Health check</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The ID of the Backup Health check</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create the Route53 record set</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">HOSTED_ZONE_ID="Z09084361B6LKQQRCVBEY" <i class="conum" data-value="1"></i><b>(1)</b>
PRIMARY_LB_HOSTED_ZONE_ID="Z32O12XQLNTSW2"
PRIMARY_LB_DNS=ab50395cd04304a539af5b8854325e22-773464857.eu-west-1.elb.amazonaws.com
PRIMARY_HEALTH_ID=233e180f-f023-45a3-954e-415303f21eab
BACKUP_LB_HOSTED_ZONE_ID="Z32O12XQLNTSW2"
BACKUP_LB_DNS=a184a0e02a5d44a9194e517c12c2b0ec-1203036292.eu-west-1.elb.amazonaws.com
BACKUP_HEALTH_ID=799e2cbb-43ae-4848-9b72-0d9173f04912
aws route53 change-resource-record-sets \
  --hosted-zone-id Z09084361B6LKQQRCVBEY \
  --query "ChangeInfo.Id" \
  --output text \
  --change-batch '
  {
    "Comment": "Creating Record Set for '${CLIENT_DOMAIN}'",
  	"Changes": [{
  		"Action": "CREATE",
  		"ResourceRecordSet": {
  			"Name": "'${PRIMARY_DOMAIN}'",
  			"Type": "A",
        "AliasTarget": {
          "HostedZoneId": "'${PRIMARY_LB_HOSTED_ZONE_ID}'",
          "DNSName": "'${PRIMARY_LB_DNS}'",
          "EvaluateTargetHealth": true
        }
  		}
  	}, {
  		"Action": "CREATE",
  		"ResourceRecordSet": {
  			"Name": "'${BACKUP_DOMAIN}'",
  			"Type": "A",
        "AliasTarget": {
          "HostedZoneId": "'${BACKUP_LB_HOSTED_ZONE_ID}'",
          "DNSName": "'${BACKUP_LB_DNS}'",
          "EvaluateTargetHealth": true
        }
  		}
  	}, {
  		"Action": "CREATE",
  		"ResourceRecordSet": {
  			"Name": "'${CLIENT_DOMAIN}'",
  			"Type": "A",
        "SetIdentifier": "client-failover-primary-'${SUBDOMAIN}'",
        "Failover": "PRIMARY",
        "HealthCheckId": "'${PRIMARY_HEALTH_ID}'",
        "AliasTarget": {
          "HostedZoneId": "'${HOSTED_ZONE_ID}'",
          "DNSName": "'${PRIMARY_DOMAIN}'",
          "EvaluateTargetHealth": true
        }
  		}
  	}, {
  		"Action": "CREATE",
  		"ResourceRecordSet": {
  			"Name": "'${CLIENT_DOMAIN}'",
  			"Type": "A",
        "SetIdentifier": "client-failover-backup-'${SUBDOMAIN}'",
        "Failover": "SECONDARY",
        "HealthCheckId": "'${BACKUP_HEALTH_ID}'",
        "AliasTarget": {
          "HostedZoneId": "'${HOSTED_ZONE_ID}'",
          "DNSName": "'${BACKUP_DOMAIN}'",
          "EvaluateTargetHealth": true
        }
  		}
  	}]
  }
  '</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The ID of the <a href="#create-hosted-zone">Hosted Zone</a> created earlier</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code>/change/C053410633T95FR9WN3YI</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the Route53 records to be updated</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws route53 wait resource-record-sets-changed --id /change/C053410633T95FR9WN3YI</code></pre>
</div>
</div>
</li>
<li>
<p>Update or create the Keycloak deployment</p>
<div class="paragraph">
<p>For both the Primary and Backup cluster, perform the following steps:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Log in to the ROSA cluster</p>
</li>
<li>
<p>Ensure the Keycloak CR has the following configuration</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: k8s.keycloak.org/v2alpha1
kind: {project_name}
metadata:
  name: keycloak
spec:
  hostname:
    hostname: ${CLIENT_DOMAIN} <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The domain clients used to connect to Keycloak</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To ensure that request forwarding works, edit the Keycloak CR to specify the hostname through which clients will access the Keycloak instances.
This hostname must be the <code>$CLIENT_DOMAIN</code> used in the Route53 configuration.</p>
</div>
</li>
<li>
<p>Create health check Route</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | kubectl apply -n $NAMESPACE -f - <i class="conum" data-value="1"></i><b>(1)</b>
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: aws-health-route
spec:
  host: $DOMAIN <i class="conum" data-value="2"></i><b>(2)</b>
  port:
    targetPort: https
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: passthrough
  to:
    kind: Service
    name: keycloak-service
    weight: 100
  wildcardPolicy: None

EOF</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>$NAMESPACE</code> should be replaced with the namespace of your Keycloak deployment</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>$DOMAIN</code> should be replaced with either the <code>PRIMARY_DOMAIN</code> or <code>BACKUP_DOMAIN</code>, if the current cluster is the Primary of Backup cluster, respectively.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verify">Verify</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Navigate to the chosen CLIENT_DOMAIN in your local browser and log in to the Keycloak console.</p>
</div>
<div class="paragraph">
<p>To test failover works as expected, log in to the Primary cluster and scale the Keycloak deployment to zero Pods.
Scaling will cause the Primary&#8217;s health checks to fail and Route53 should start routing traffic to the Keycloak Pods on the Backup cluster.</p>
</div>
</div>
</div>            </div>
        </div>

        <div class="col-md-3 mt-4 col-xl-2 col-sm-12 bg-light">
            <div class="sticky-top px-2 py-3">
                <div class="mt-2 mb-2 fw-bold">On this page</div>
                <div id="js-toc"></div>
                <div class="mt-4">
                    <a href="https://github.com/keycloak/keycloak/tree/main/docs/guides/high-availability/deploy-aws-route53-loadbalancer.adoc" target="_blank"><i class="fa fa-edit"></i> Edit this guide</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.keycloak.org/resources/js/guide.js" type="text/javascript"></script>


<div class="container mt-5">
    <footer class="py-3 my-4 border-top">
        <p class="text-center text-muted">Keycloak is a Cloud Native Computing Foundation incubation project</p>
        <div class="text-center">
            <img alt="Cloud Native Computing Foundation" src="https://www.keycloak.org/resources/images/cncf_logo.png"/>
        </div>
        <p class="mt-4 text-center small text-muted">&copy; Keycloak Authors 2023. &copy; 2023 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage page</a>.</p>
    </footer>
</div>

</body>
</html>
