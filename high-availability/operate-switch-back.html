
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Switch back to the primary site - Keycloak</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Keycloak is an open source identity and access management solution">
    <meta name="author" content="Keycloak Team">
    <meta name="keywords" content="sso,idm,openid connect,saml,kerberos,ldap">

    

    

    <link href="https://www.keycloak.org/resources/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://www.keycloak.org/resources/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="https://www.keycloak.org/resources/css/keycloak.css" rel="stylesheet">

    <link rel="shortcut icon" href="https://www.keycloak.org/resources/favicon.ico">

    <script src="https://www.keycloak.org/resources/js/ga.js" type="text/javascript"></script>
    <script src="https://www.keycloak.org/resources/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="https://www.keycloak.org/resources/tocbot/dist/tocbot.min.js" type="text/javascript"></script>
</head>
<body>

<header class="navbar navbar-expand-md bg-light shadow-sm">
<nav class="container-xxl flex-wrap flex-md-no-wrap navbar-light">
    <a class="navbar-brand me-5" href="https://www.keycloak.org/">
        <img class="img-fluid" src="https://www.keycloak.org/resources/images/logo.svg" width="240" alt="Keycloak"/>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="fa fa-bars fa-lg px-1 py-2"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav flex-row flex-wrap bd-navbar-nav pt-2 py-md-0">
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/guides">Guides</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/documentation">Docs</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/downloads">Downloads</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/community">Community</a>
        </li>
        <li class="nav-item col-6 col-md-auto">
          <a class="nav-link " href="https://www.keycloak.org/blog">Blog</a>
        </li>
      </ul>
    </div>
</nav>
</header>


<div class="container mt-5 kc-article">
    <div class="row">
        <div class="col-md-9 col-xl-10 col-sm-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="https://www.keycloak.org/guides">Guides</a></li>
                    <li class="breadcrumb-item"><a href="https://www.keycloak.org/guides#high-availability">High availability</a></li>
                    <li class="breadcrumb-item active">Switch back to the primary site</li>
                </ol>
            </nav>

            <div class="mb-4">
                <h1>Switch back to the primary site</h1>
                    <span class="text-muted">This describes the operational procedures necessary</span>
            </div>



            <div class="kc-asciidoc" id="guide-body">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>These procedures switch back to the primary site back after a failover or switchover to the secondary site.
In a setup as outlined in <a href="https://www.keycloak.org/high-availability/concepts-active-passive-sync">Concepts for active-passive deployments</a> together with the blueprints outlined in <a href="https://www.keycloak.org/high-availability/bblocks-active-passive-sync">Building blocks active-passive deployments</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_when_to_use_this_procedure">When to use this procedure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These procedures bring the primary site back to operation when the secondary site is handling all the traffic.
At the end of the guide, the primary site is online again and handles the traffic.</p>
</div>
<div class="paragraph">
<p>This procedure is necessary when the primary site has lost its state in Infinispan, a network partition occurred between the primary and the secondary site while the secondary site was active, or the replication was disabled as described in the <a href="https://www.keycloak.org/high-availability/operate-switch-over">Switch over to the secondary site</a> guide.</p>
</div>
<div class="paragraph">
<p>If the data in Infinispan on both sites is still in sync, the procedure for Infinispan can be skipped.</p>
</div>
<div class="paragraph">
<p>See the <a href="https://www.keycloak.org/high-availability/introduction">Multi-site deployments</a> guide for different operational procedures.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_procedures">Procedures</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_infinispan_cluster">Infinispan Cluster</h3>
<div class="paragraph">
<p>For the context of this guide, <code>Site-A</code> is the primary site, recovering back to operation, and <code>Site-B</code> is the secondary site, running in production.</p>
</div>
<div class="paragraph">
<p>After the Infinispan in the primary site is back online and has joined the cross-site channel (see <a href="https://www.keycloak.org/high-availability/deploy-infinispan-kubernetes-crossdc">Deploy Infinispan for HA with the Infinispan Operator</a>#verifying-the-deployment on how to verify the Infinispan deployment), the state transfer must be manually started from the secondary site.</p>
</div>
<div class="paragraph">
<p>After clearing the state in the primary site, it transfers the full state from the secondary site to the primary site, and it must be completed before the primary site can start handling incoming requests.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Transferring the full state may impact the Infinispan cluster perform by increasing the response time and/or resources usage.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first procedure is to delete any stale data from the primary site.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in to the primary site.</p>
</li>
<li>
<p>Shutdown Keycloak.
This action will clear all Keycloak caches and prevents the state of Keycloak from being out-of-sync with Infinispan.</p>
<div class="paragraph">
<p>When deploying Keycloak using the Keycloak Operator, change the number of Keycloak instances in the Keycloak Custom Resource to 0.</p>
</div>
</li>
<li>
<p>Connect into Infinispan Cluster using the Infinispan CLI tool:</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl -n keycloak exec -it pods/infinispan-0 -- ./bin/cli.sh --trustall --connect https://127.0.0.1:11222</code></pre>
</div>
</div>
<div class="paragraph">
<p>It asks for the username and password for the Infinispan cluster.
Those credentials are the one set in the <a href="https://www.keycloak.org/high-availability/deploy-infinispan-kubernetes-crossdc">Deploy Infinispan for HA with the Infinispan Operator</a> guide in the configuring credentials section.</p>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Username: developer
Password:
[infinispan-0-29897@ISPN//containers/default]&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The pod name depends on the cluster name defined in the Infinispan CR.
The connection can be done with any pod in the Infinispan cluster.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Disable the replication from primary site to the secondary site by running the following command.
It prevents the clear request to reach the secondary site and delete all the correct cached data.</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">site take-offline --all-caches --site=site-b</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{
  "offlineClientSessions" : "ok",
  "authenticationSessions" : "ok",
  "sessions" : "ok",
  "clientSessions" : "ok",
  "work" : "ok",
  "offlineSessions" : "ok",
  "loginFailures" : "ok",
  "actionTokens" : "ok"
}</code></pre>
</div>
</div>
</li>
<li>
<p>Check the replication status is <code>offline</code>.</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">site status --all-caches --site=site-b</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{
  "status" : "offline"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the status is not <code>offline</code>, repeat the previous step.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure the replication is <code>offline</code> otherwise the clear data will clear both sites.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Clear all the cached data in primary site using the following commands:</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">clearcache actionTokens
clearcache authenticationSessions
clearcache clientSessions
clearcache loginFailures
clearcache offlineClientSessions
clearcache offlineSessions
clearcache sessions
clearcache work</code></pre>
</div>
</div>
<div class="paragraph">
<p>These commands do not print any output.</p>
</div>
</li>
<li>
<p>Re-enable the cross-site replication from primary site to the secondary site.</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">site bring-online --all-caches --site=site-b</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{
  "offlineClientSessions" : "ok",
  "authenticationSessions" : "ok",
  "sessions" : "ok",
  "clientSessions" : "ok",
  "work" : "ok",
  "offlineSessions" : "ok",
  "loginFailures" : "ok",
  "actionTokens" : "ok"
}</code></pre>
</div>
</div>
</li>
<li>
<p>Check the replication status is <code>online</code>.</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">site status --all-caches --site=site-b</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{
  "status" : "online"
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now we are ready to transfer the state from the secondary site to the primary site.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in into your secondary site.</p>
</li>
<li>
<p>Connect into Infinispan Cluster using the Infinispan CLI tool:</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl -n keycloak exec -it pods/infinispan-0 -- ./bin/cli.sh --trustall --connect https://127.0.0.1:11222</code></pre>
</div>
</div>
<div class="paragraph">
<p>It asks for the username and password for the Infinispan cluster.
Those credentials are the one set in the <a href="https://www.keycloak.org/high-availability/deploy-infinispan-kubernetes-crossdc">Deploy Infinispan for HA with the Infinispan Operator</a> guide in the configuring credentials section.</p>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Username: developer
Password:
[infinispan-0-29897@ISPN//containers/default]&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The pod name depends on the cluster name defined in the Infinispan CR.
The connection can be done with any pod in the Infinispan cluster.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Trigger the state transfer from the secondary site to the primary site.</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">site push-site-state --all-caches --site=site-a</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{
  "offlineClientSessions" : "ok",
  "authenticationSessions" : "ok",
  "sessions" : "ok",
  "clientSessions" : "ok",
  "work" : "ok",
  "offlineSessions" : "ok",
  "loginFailures" : "ok",
  "actionTokens" : "ok"
}</code></pre>
</div>
</div>
</li>
<li>
<p>Check the replication status is <code>online</code> for all caches.</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">site status --all-caches --site=site-a</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{
  "status" : "online"
}</code></pre>
</div>
</div>
</li>
<li>
<p>Wait for the state transfer to complete by checking the output of <code>push-site-status</code> command for all caches.</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">site push-site-status --cache=actionTokens
site push-site-status --cache=authenticationSessions
site push-site-status --cache=clientSessions
site push-site-status --cache=loginFailures
site push-site-status --cache=offlineClientSessions
site push-site-status --cache=offlineSessions
site push-site-status --cache=sessions
site push-site-status --cache=work</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{
  "site-a" : "OK"
}
{
  "site-a" : "OK"
}
{
  "site-a" : "OK"
}
{
  "site-a" : "OK"
}
{
  "site-a" : "OK"
}
{
  "site-a" : "OK"
}
{
  "site-a" : "OK"
}
{
  "site-a" : "OK"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the table in <a href="https://infinispan.org/docs/stable/titles/xsite/xsite.html#rest_v2_xsite_state_push_cross-site-operations-rest">this section for the Cross-Site Documentation</a> for the possible status values.</p>
</div>
<div class="paragraph">
<p>If an error is reported, repeat the state transfer for that specific cache.</p>
</div>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">site push-site-state --cache=&lt;cache-name&gt; --site=site-a</code></pre>
</div>
</div>
</li>
<li>
<p>Clear/reset the state transfer status with the following command</p>
<div class="listingblock">
<div class="title">Command:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">site clear-push-site-status --cache=actionTokens
site clear-push-site-status --cache=authenticationSessions
site clear-push-site-status --cache=clientSessions
site clear-push-site-status --cache=loginFailures
site clear-push-site-status --cache=offlineClientSessions
site clear-push-site-status --cache=offlineSessions
site clear-push-site-status --cache=sessions
site clear-push-site-status --cache=work</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Output:</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">"ok"
"ok"
"ok"
"ok"
"ok"
"ok"
"ok"
"ok"</code></pre>
</div>
</div>
</li>
<li>
<p>Log in to the primary site.</p>
</li>
<li>
<p>Start Keycloak.</p>
<div class="paragraph">
<p>When deploying Keycloak using the Keycloak Operator, change the number of Keycloak instances in the Keycloak Custom Resource to the original value.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Both Infinispan clusters are in sync and the switchover from secondary back to the primary site can be performed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_aws_aurora_database">AWS Aurora Database</h3>
<div class="paragraph">
<p>Assuming a Regional multi-AZ Aurora deployment, the current writer instance should be in the same region as the active Keycloak cluster to avoid latencies and communication across availability zones.</p>
</div>
<div class="paragraph">
<p>Switching the writer instance of Aurora will lead to a short downtime. The writer instance in the other site with a slightly longer latency might be acceptable for some deployments.
Therefore, this situation might be deferred to a maintenance window or skipped depending on the circumstances of the deployment.</p>
</div>
<div class="paragraph">
<p>To change the writer instance, run a failover.
This change will make the database unavailable for a short time.
Keycloak will need to re-establish database connections.</p>
</div>
<div class="paragraph">
<p>To fail over the writer instance to the other AZ, issue the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">aws rds failover-db-cluster  --db-cluster-identifier ...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_route53">Route53</h3>
<div class="paragraph">
<p>If switching over to the secondary site has been triggered by changing the health endpoint, edit the health check in AWS to point to a correct endpoint (<code>health/live</code>).
After some minutes, the clients will notice the change and traffic will gradually move over to the secondary site.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_reading">Further reading</h2>
<div class="sectionbody">
<div class="paragraph">
<p>See <a href="https://www.keycloak.org/high-availability/concepts-infinispan-cli-batch">Concepts to automate Infinispan CLI commands</a> on how to automate Infinispan CLI commands.</p>
</div>
</div>
</div>            </div>
        </div>

        <div class="col-md-3 mt-4 col-xl-2 col-sm-12 bg-light">
            <div class="sticky-top px-2 py-3">
                <div class="mt-2 mb-2 fw-bold">On this page</div>
                <div id="js-toc"></div>
                <div class="mt-4">
                    <a href="https://github.com/keycloak/keycloak/tree/main/docs/guides/high-availability/operate-switch-back.adoc" target="_blank"><i class="fa fa-edit"></i> Edit this guide</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.keycloak.org/resources/js/guide.js" type="text/javascript"></script>


<div class="container mt-5">
    <footer class="py-3 my-4 border-top">
        <p class="text-center text-muted">Keycloak is a Cloud Native Computing Foundation incubation project</p>
        <div class="text-center">
            <img alt="Cloud Native Computing Foundation" src="https://www.keycloak.org/resources/images/cncf_logo.png"/>
        </div>
        <p class="mt-4 text-center small text-muted">&copy; Keycloak Authors 2023. &copy; 2023 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage page</a>.</p>
    </footer>
</div>

</body>
</html>
